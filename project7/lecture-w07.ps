%!PS-Adobe-3.0
%%Creator: groff version 1.19.1
%%CreationDate: Wed Nov 23 00:43:47 2016
%%DocumentNeededResources: font Times-Roman
%%+ font Times-Bold
%%+ font Courier
%%+ font Times-Italic
%%DocumentSuppliedResources: file x86stack.eps
%%+ file kern.eps
%%+ file idt.eps
%%+ procset grops 1.19 1
%%Pages: 28
%%PageOrder: Ascend
%%DocumentMedia: Default 612 792 0 () ()
%%Orientation: Portrait
%%EndComments
%%BeginDefaults
%%PageMedia: Default
%%EndDefaults
%%BeginProlog
%%BeginResource: procset grops 1.19 1
%!PS-Adobe-3.0 Resource-ProcSet
/setpacking where{
pop
currentpacking
true setpacking
}if
/grops 120 dict dup begin
/SC 32 def
/A/show load def
/B{0 SC 3 -1 roll widthshow}bind def
/C{0 exch ashow}bind def
/D{0 exch 0 SC 5 2 roll awidthshow}bind def
/E{0 rmoveto show}bind def
/F{0 rmoveto 0 SC 3 -1 roll widthshow}bind def
/G{0 rmoveto 0 exch ashow}bind def
/H{0 rmoveto 0 exch 0 SC 5 2 roll awidthshow}bind def
/I{0 exch rmoveto show}bind def
/J{0 exch rmoveto 0 SC 3 -1 roll widthshow}bind def
/K{0 exch rmoveto 0 exch ashow}bind def
/L{0 exch rmoveto 0 exch 0 SC 5 2 roll awidthshow}bind def
/M{rmoveto show}bind def
/N{rmoveto 0 SC 3 -1 roll widthshow}bind def
/O{rmoveto 0 exch ashow}bind def
/P{rmoveto 0 exch 0 SC 5 2 roll awidthshow}bind def
/Q{moveto show}bind def
/R{moveto 0 SC 3 -1 roll widthshow}bind def
/S{moveto 0 exch ashow}bind def
/T{moveto 0 exch 0 SC 5 2 roll awidthshow}bind def
/SF{
findfont exch
[exch dup 0 exch 0 exch neg 0 0]makefont
dup setfont
[exch/setfont cvx]cvx bind def
}bind def
/MF{
findfont
[5 2 roll
0 3 1 roll
neg 0 0]makefont
dup setfont
[exch/setfont cvx]cvx bind def
}bind def
/level0 0 def
/RES 0 def
/PL 0 def
/LS 0 def
/MANUAL{
statusdict begin/manualfeed true store end
}bind def
/PLG{
gsave newpath clippath pathbbox grestore
exch pop add exch pop
}bind def
/BP{
/level0 save def
1 setlinecap
1 setlinejoin
72 RES div dup scale
LS{
90 rotate
}{
0 PL translate
}ifelse
1 -1 scale
}bind def
/EP{
level0 restore
showpage
}bind def
/DA{
newpath arcn stroke
}bind def
/SN{
transform
.25 sub exch .25 sub exch
round .25 add exch round .25 add exch
itransform
}bind def
/DL{
SN
moveto
SN
lineto stroke
}bind def
/DC{
newpath 0 360 arc closepath
}bind def
/TM matrix def
/DE{
TM currentmatrix pop
translate scale newpath 0 0 .5 0 360 arc closepath
TM setmatrix
}bind def
/RC/rcurveto load def
/RL/rlineto load def
/ST/stroke load def
/MT/moveto load def
/CL/closepath load def
/Fr{
setrgbcolor fill
}bind def
/setcmykcolor where{
pop
/Fk{
setcmykcolor fill
}bind def
}if
/Fg{
setgray fill
}bind def
/FL/fill load def
/LW/setlinewidth load def
/Cr/setrgbcolor load def
/setcmykcolor where{
pop
/Ck/setcmykcolor load def
}if
/Cg/setgray load def
/RE{
findfont
dup maxlength 1 index/FontName known not{1 add}if dict begin
{
1 index/FID ne{def}{pop pop}ifelse
}forall
/Encoding exch def
dup/FontName exch def
currentdict end definefont pop
}bind def
/DEFS 0 def
/EBEGIN{
moveto
DEFS begin
}bind def
/EEND/end load def
/CNT 0 def
/level1 0 def
/PBEGIN{
/level1 save def
translate
div 3 1 roll div exch scale
neg exch neg exch translate
0 setgray
0 setlinecap
1 setlinewidth
0 setlinejoin
10 setmiterlimit
[]0 setdash
/setstrokeadjust where{
pop
false setstrokeadjust
}if
/setoverprint where{
pop
false setoverprint
}if
newpath
/CNT countdictstack def
userdict begin
/showpage{}def
/setpagedevice{}def
}bind def
/PEND{
clear
countdictstack CNT sub{end}repeat
level1 restore
}bind def
end def
/setpacking where{
pop
setpacking
}if
%%EndResource
%%EndProlog
%%BeginSetup
%%BeginFeature: *PageSize Default
<< /PageSize [ 612 792 ] /ImagingBBox null >> setpagedevice
%%EndFeature
%%IncludeResource: font Times-Roman
%%IncludeResource: font Times-Bold
%%IncludeResource: font Courier
%%IncludeResource: font Times-Italic
grops begin/DEFS 1 dict def DEFS begin/u{.001 mul}bind def end/RES 72
def/PL 792 def/LS false def/ENC0[/asciicircum/asciitilde/Scaron/Zcaron
/scaron/zcaron/Ydieresis/trademark/quotesingle/Euro/.notdef/.notdef
/.notdef/.notdef/.notdef/.notdef/.notdef/.notdef/.notdef/.notdef/.notdef
/.notdef/.notdef/.notdef/.notdef/.notdef/.notdef/.notdef/.notdef/.notdef
/.notdef/.notdef/space/exclam/quotedbl/numbersign/dollar/percent
/ampersand/quoteright/parenleft/parenright/asterisk/plus/comma/hyphen
/period/slash/zero/one/two/three/four/five/six/seven/eight/nine/colon
/semicolon/less/equal/greater/question/at/A/B/C/D/E/F/G/H/I/J/K/L/M/N/O
/P/Q/R/S/T/U/V/W/X/Y/Z/bracketleft/backslash/bracketright/circumflex
/underscore/quoteleft/a/b/c/d/e/f/g/h/i/j/k/l/m/n/o/p/q/r/s/t/u/v/w/x/y
/z/braceleft/bar/braceright/tilde/.notdef/quotesinglbase/guillemotleft
/guillemotright/bullet/florin/fraction/perthousand/dagger/daggerdbl
/endash/emdash/ff/fi/fl/ffi/ffl/dotlessi/dotlessj/grave/hungarumlaut
/dotaccent/breve/caron/ring/ogonek/quotedblleft/quotedblright/oe/lslash
/quotedblbase/OE/Lslash/.notdef/exclamdown/cent/sterling/currency/yen
/brokenbar/section/dieresis/copyright/ordfeminine/guilsinglleft
/logicalnot/minus/registered/macron/degree/plusminus/twosuperior
/threesuperior/acute/mu/paragraph/periodcentered/cedilla/onesuperior
/ordmasculine/guilsinglright/onequarter/onehalf/threequarters
/questiondown/Agrave/Aacute/Acircumflex/Atilde/Adieresis/Aring/AE
/Ccedilla/Egrave/Eacute/Ecircumflex/Edieresis/Igrave/Iacute/Icircumflex
/Idieresis/Eth/Ntilde/Ograve/Oacute/Ocircumflex/Otilde/Odieresis
/multiply/Oslash/Ugrave/Uacute/Ucircumflex/Udieresis/Yacute/Thorn
/germandbls/agrave/aacute/acircumflex/atilde/adieresis/aring/ae/ccedilla
/egrave/eacute/ecircumflex/edieresis/igrave/iacute/icircumflex/idieresis
/eth/ntilde/ograve/oacute/ocircumflex/otilde/odieresis/divide/oslash
/ugrave/uacute/ucircumflex/udieresis/yacute/thorn/ydieresis]def
/Times-Italic@0 ENC0/Times-Italic RE/Courier@0 ENC0/Courier RE
/Times-Bold@0 ENC0/Times-Bold RE/Times-Roman@0 ENC0/Times-Roman RE
%%EndSetup
%%Page: 1 1
%%BeginPageSetup
BP
%%EndPageSetup
/F0 9/Times-Roman@0 SF(ECE357:Computer Operating Systems)69.336 60 Q
(Unit 7/pg 1)55.998 E(\2512016 Jef)126.405 E 2.25(fH)-.225 G(akner)-2.25
E/F1 13/Times-Bold@0 SF(What is the K)211.806 120 Q(er)-.325 E(nel?)
-.195 E/F2 13/Times-Roman@0 SF .193(In this unit, we will be)33.336 156
R .193(gin an in-depth e)-.195 F .192(xploration of the Linux k)-.195 F
3.442(ernel. The)-.13 F .192(\214rst and most)3.442 F(ob)33.336 171 Q
(vious question is: just what e)-.195 E(xactly is the "k)-.195 E
(ernel"?!)-.13 E 3.212(The Linux k)33.336 207 R 3.213
(ernel is an unusual type of program.)-.13 F 3.213
(Most programs to which we are)9.713 F 1.141(accustomed ha)33.336 222 R
1.531 -.195(ve o)-.26 H 1.141(ne point of entry).195 F 4.39(,r)-.845 G
1.14(un for some time, and then terminate.)-4.39 F 1.14(The k)7.64 F
(ernel)-.13 E 2.264(has one initial point of entry which is used at boo\
t-time, and then multiple points of)33.336 237 R 1.163
(controlled re-entry)33.336 252 R 7.663(.T)-.845 G 1.163
(he termination of the k)-7.663 F 1.163
(ernel amounts to handing the CPU back to)-.13 F(the \214rmw)33.336 267
Q(are which either reboots or turns of)-.13 E 3.25(ft)-.325 G
(he machine.)-3.25 E .996(The k)33.336 303 R .997
(ernel is compiled and link)-.13 F .997(ed just lik)-.13 F 4.247(ea)-.13
G 4.247(no)-4.247 G .997(rdinary C program, in that it consists of)
-4.247 F(man)33.336 318 Q 3.523(yi)-.195 G(ndi)-3.523 E .273
(vidual object \()-.325 F/F3 13/Courier@0 SF(.o)A F2 3.523<298c>C .273
(les which are compiled from source code \(the Linux k)-3.523 F(ernel)
-.13 E .585(is written e)33.336 333 R(xclusi)-.195 E -.195(ve)-.325 G
.585(ly in C and assembly\).).195 F -.52(Wi)7.085 G .585(thin the k).52
F .585(ernel is the equi)-.13 F -.325(va)-.325 G .585(lent of a).325 F
F3(text)3.835 E F2 .024(section, containing the e)33.336 348 R -.195(xe)
-.195 G .024(cutable code, as well as).195 F F3(data)3.274 E F2 .024
(section with v)3.274 F .023(ariable initializers.)-.325 F(Lik)33.336
363 Q 4.693(ea)-.13 G 4.693(no)-4.693 G 1.443
(rdinary C program, when the k)-4.693 F 1.443
(ernel starts it sets aside space for uninitialized)-.13 F F3(bss)33.336
378 Q F2 -.325(va)3.513 G .262(riables, and can dynamically allocate me\
mory for other data structures.).325 F .262(Also, lik)6.762 F(e)-.13 E
3.25(au)33.336 393 S(ser)-3.25 E(-le)-.26 E -.195(ve)-.325 G 3.25(lCp)
.195 G(rogram, the k)-3.25 E(ernel can dynamically load and unload e)
-.13 E -.195(xe)-.195 G(cutable modules.).195 E(Unlik)33.336 423 Q 3.47
(et)-.13 G .22(he C en)-3.47 F .22(vironment that is documented in the \
C language standards documents, the)-.52 F -.13(ke)33.336 438 S 1.474
(rnel does not ha).13 F 1.864 -.195(ve t)-.26 H 1.474
(he standard library).195 F 7.973(.T)-.845 G 1.473
(here is no printf, no malloc, no fopen, etc.)-7.973 F .155
(because these standard library functions w)33.336 453 R .155
(ould require an operating system to pro)-.13 F .155(vide the)-.195 F
5.512(services. There)33.336 468 R 2.261
(is a subset of library functions which is link)5.512 F 2.261
(ed in the k)-.13 F 2.261(ernel such as)-.13 F(strcp)33.336 483 Q 8.145
-.845(y. T)-.13 H 3.205(he k).845 F 3.206(ernel is also coded to a)-.13
F -.26(vo)-.26 G 3.206(id all use of the \215oating point re).26 F 3.206
(gisters, so)-.195 F 1.526(functions such as po)33.336 498 R 1.526
(w\(\) and sqrt\(\) w)-.325 F 1.525(ould ne)-.13 F -.195(ve)-.325 G
4.775(rb).195 G 4.775(es)-4.775 G 1.525(een in k)-4.775 F 1.525
(ernel code, and indeed the)-.13 F -.13(ke)33.336 513 S(yw)-.065 E(ords)
-.13 E F3(float)3.25 E F2(and)3.25 E F3(double)3.25 E F2 -.13(wo)3.25 G
(uld generally be absent too.).13 E 2.431
(At this point, it might be instructi)33.336 549 R 2.822 -.195(ve t)
-.325 H 5.682(ol).195 G 2.432(ook at ho)-5.682 F 5.682(wt)-.325 G 2.432
(he Linux k)-5.682 F 2.432(ernel source code is)-.13 F 3.567
(arranged. The)33.336 564 R -.13(ke)3.567 G .317
(rnel can be compiled for a v).13 F .317(ariety of tar)-.325 F .316
(get architectures.)-.234 F .316(From the top-)6.816 F(le)33.336 579 Q
-.195(ve)-.325 G 5.679(ld).195 G(irectory)-5.679 E 5.679(,w)-.845 G 5.68
(es)-5.679 G 2.43(ee the follo)-5.68 F 2.43
(wing directories, each of which contains architecture-)-.325 F 1.574
(independent code.)33.336 594 R 1.574(Thus the code belo)8.074 F 4.824
(wi)-.325 G 4.824(so)-4.824 G 1.574(nly in C, not assembly)-4.824 F
8.074(.T)-.845 G 1.573(here is one top-)-8.074 F(le)33.336 609 Q -.195
(ve)-.325 G 5.036(ld).195 G 1.786(irectory called)-5.036 F F3(arch)5.036
E F2 5.036(,u)C 1.787
(nder which is one entry for each supported architecture,)-5.036 F(e.g.)
33.336 624 Q F3(arch/x86)5.091 E F2 5.091(,a)C 1.841(nd belo)-5.091 F
5.091(we)-.325 G 1.841
(ach of those is another set of subdirectories with similar)-5.091 F
(structure to the architecture-independent set.)33.336 639 Q
(Here is a description of these directories:)6.5 E<83>33.336 654 Q F3
(block)4.986 E F2 4.986(:Af)C 1.736
(airly small set of utility routines pertaining to block-le)-5.116 F
-.195(ve)-.325 G 4.987(la).195 G 1.737(ccess to hard)-4.987 F(disks.)
33.336 669 Q<83>33.336 684 Q F3(crypto)3.25 E F2 3.25(:E)C
(ncryption functions.)-3.25 E<83>33.336 699 Q F3(drivers)3.266 E F2
3.266(:Av)C .016(ast set of routines for interf)-3.591 F .016
(acing with I/O de)-.13 F .016(vices, including arch-neutral)-.325 F
(stuf)33.336 714 Q 9.93(fs)-.325 G 6.681
(uch as the SCSI messaging layer)-9.93 F 9.931(,a)-.52 G 6.681
(nd support for speci\214c peripherals,)-9.931 F(motherboards, etc.)
33.336 729 Q<83>33.336 744 Q F3(fs)4.701 E F2 4.701(:R)C 1.451(outines \
to support the \214le system, such as open, read, write system calls.)
-4.701 F(Also)7.95 E 0 Cg EP
%%Page: 2 2
%%BeginPageSetup
BP
%%EndPageSetup
/F0 9/Times-Roman@0 SF(ECE357:Computer Operating Systems)33.336 60 Q
(Unit 7/pg 2)73.998 E(\2512016 Jef)144.405 E 2.25(fH)-.225 G(akner)-2.25
E/F1 13/Times-Roman@0 SF
(subdirectories for each supported \214le system type module.)33.336 120
Q<83>33.336 135 Q/F2 13/Courier@0 SF(include)3.25 E F1 3.25(:H)C
(eader \(.h\) \214les)-3.25 E<83>33.336 150 Q F2(init)3.25 E F1 3.25(:C)
C(ode which is e)-3.25 E -.195(xe)-.195 G
(cuted when the system \214rst boots.).195 E<83>33.336 165 Q F2(ipc)3.25
E F1 3.25(:S)C(ystem V and POSIX IPC mechanisms)-3.25 E<83>33.336 180 Q
F2(kernel)5.625 E F1 5.625(:Ac)C 2.376
(onsiderable amount of code including all of the synchronization, task)
-5.625 F(control, signals, halting and restarting the system, etc.)
33.336 195 Q<83>33.336 210 Q F2(lib)8.883 E F1 8.883(:An)C 5.633
(umber of utility routines needed by dif)-8.883 F 5.632
(ferent subsystems, including)-.325 F(synchronization primiti)33.336 225
Q -.195(ve)-.325 G 3.25(ss).195 G(uch as spin locks and semaphores.)
-3.25 E<83>33.336 240 Q F2(mm)3.25 E F1 3.25(:T)C
(he virtual memory subsystem.)-3.25 E<83>33.336 255 Q F2(net)3.25 E F1
3.25(:N)C(etw)-3.25 E(orking protocols)-.13 E<83>33.336 270 Q F2
(security)3.25 E F1 3.25(:S)C(ome e)-3.25 E(xtra stuf)-.195 E 3.25(ff)
-.325 G(or "security-hardened" v)-3.25 E(ersions of the k)-.195 E
(ernel.)-.13 E<83>33.336 285 Q F2(sound)3.25 E F1 3.25(:S)C(ound dri)
-3.25 E -.195(ve)-.325 G(rs and support).195 E 1.408(\(there are a fe)
33.336 315 R 4.658(wo)-.325 G 1.408(ther subdirectories which ha)-4.658
F 1.798 -.195(ve t)-.26 H 4.658(od).195 G 4.658(ow)-4.658 G 1.409
(ith the k)-4.658 F 1.409(ernel b)-.13 F 1.409(uild and install)-.26 F
(process or other features b)33.336 330 Q(ut are be)-.26 E
(yond the scope of this course.\))-.195 E/F3 13/Times-Bold@0 SF(Boot-up)
244.943 360 Q F1(The follo)33.336 390 Q(wing describes ho)-.325 E 3.25
(wt)-.325 G(he linux k)-3.25 E
(ernel under X86-32 bit architecture is booted:)-.13 E 5.136<8354>33.336
405 S 1.886(he linux k)-5.136 F 1.886(ernel is b)-.13 F 1.886
(uilt from source and often included as a binary distrib)-.26 F 5.135
(ution. A)-.26 F -.325(va)33.336 420 S 1.018(lid k).325 F 1.019(ernel m\
ust be present to support the particular architecture of the machine th\
at is)-.13 F 1.032(being booted, and the particular de)33.336 435 R
1.032(vice dri)-.325 F -.195(ve)-.325 G 1.032
(rs that are needed at boot time.).195 F 1.031(The k)7.531 F(ernel)-.13
E 1.239(source code as described abo)33.336 450 R 1.629 -.195(ve i)-.195
H 4.49<738c>.195 G 1.24(rst compiled into an a.out \214le.)-4.49 F(Ho)
7.74 E(we)-.325 E -.195(ve)-.325 G 2.28 -.52(r, a).195 H 1.24
(.out \214les).52 F 1.212(mean nothing to the \214rmw)33.336 465 R 1.212
(are, so additional preparation is necessary)-.13 F 7.712(.T)-.845 G(he)
-7.712 E/F4 13/Times-Italic@0 SF(ima)4.462 E -.13(ge)-.13 G F1 1.212
(of the)4.592 F(te)33.336 480 Q 1.337
(xt and data sections is pulled out of the compiled k)-.195 F 4.587
(ernel. T)-.13 F(ypically)-1.04 E 4.588(,t)-.845 G 4.588(os)-4.588 G
-2.925 -.26(av e)-4.588 H 1.338(space on)4.848 F .526
(smaller bootable media, the k)33.336 495 R .526
(ernel image is compressed.)-.13 F 3.776(Ab)7.026 G .526(ootable k)
-3.776 F .526(ernel consists of a)-.13 F 3.128
(small, uncompressed portion of bootable code follo)33.336 510 R 3.128
(wed by the compressed te)-.325 F(xt/data)-.195 E 7.485(image. This)
33.336 525 R 4.235(bootable k)7.485 F 4.235(ernel \(typically called)
-.13 F F2(vmlinuz)7.484 E F1 4.234(where the "z" stands for)7.484 F .239
(compressed\) is installed on the bootable medium \(hard disk, CD/D)
33.336 540 R .24(VD R)-.52 F .24(OM, USB stick\).)-.52 F 4.127<8354>
33.336 555 S 4.127(ob)-5.167 G .877(oot the system, the \214rmw)-4.127 F
.877(are \("BIOS"\) causes the k)-.13 F .876
(ernel image to be read in from)-.13 F 1.04(the boot de)33.336 570 R
1.04(vice \(e.g. the hard disk\) into a speci\214c place in ph)-.325 F
1.04(ysical memory)-.065 F 7.54(.T)-.845 G 1.04(he e)-7.54 F(xact)-.195
E 2.903(manner in which this happens may be discussed in a later unit.)
33.336 585 R 2.902(The \214rmw)9.402 F 2.902(are then)-.13 F
(transfers control to the starting address of the k)33.336 600 Q(ernel.)
-.13 E 3.391<8342>33.336 615 S .141
(IOS runs in supervisor mode, with address translation turned of)-3.391
F 3.391(f\()-.325 G .142(so all addresses used)-3.391 F .611
(in code are ph)33.336 630 R .611
(ysical\) and with interrupts disabled.)-.065 F(Hand-of)7.111 E 3.861
(ft)-.325 G 3.861(ot)-3.861 G .611(he k)-3.861 F .611
(ernel image is made)-.13 F 2.686(in this condition.)33.336 645 R 2.686
(Thus the \214rst part of the k)9.186 F(ernel')-.13 E 5.936(si)-.715 G
2.686(nitialization routines ha)-5.936 F 3.076 -.195(ve b)-.26 H(een)
.195 E 2.986(compiled and link)33.336 660 R 2.986
(ed with a speci\214c address in mind which corresponds to the load)-.13
F 5.125(address. The)33.336 675 R(ne)5.125 E 1.876
(xt task is to de-compress the image which is in one place in ph)-.195 F
(ysical)-.065 E .049(memory and write it to another location.)33.336 690
R -.195(Fo)6.548 G 3.298(rt).195 G .048
(he \(32-bit\) x86 architecture, this is ph)-3.298 F(ysical)-.065 E
(address)33.336 705 Q F2(0x00100000)3.25 E F1 6.5(.A)C
(jump is then made to that ph)-3.25 E(ysical address.)-.065 E 4.354
<8341>33.336 720 S 4.354(ta)-4.354 G 1.104(round this time, the k)-4.354
F 1.104(ernel turns on virtual address translation.)-.13 F 1.105
(On the x86 32-bit)7.604 F 1.967(architecture, the Linux k)33.336 735 R
1.967(ernel uses virtual addresses belo)-.13 F 5.217(w0)-.325 G 1.967
(xC000000 e)-5.217 F(xclusi)-.195 E -.195(ve)-.325 G 1.966(ly for).195 F
0 Cg EP
%%Page: 3 3
%%BeginPageSetup
BP
%%EndPageSetup
/F0 9/Times-Roman@0 SF(ECE357:Computer Operating Systems)33.336 60 Q
(Unit 7/pg 3)73.998 E(\2512016 Jef)144.405 E 2.25(fH)-.225 G(akner)-2.25
E/F1 13/Times-Roman@0 SF(user)33.336 120 Q(-le)-.26 E -.195(ve)-.325 G
6.131(lp).195 G 2.881(rocesses, and reserv)-6.131 F 2.881
(es the 0xC000000-0xFFFFFFFF range e)-.195 F(xclusi)-.195 E -.195(ve)
-.325 G 2.882(ly for).195 F -.13(ke)33.336 135 S .937(rnel memory).13 F
7.437(.W)-.845 G(e')-8.477 E .937(ll see ho)-.13 F 4.187(wt)-.325 G .937
(his is e)-4.187 F .937(xploited to accomplish f)-.195 F .937
(ast access to k)-.13 F .936(ernel data)-.13 F(structures.)33.336 150 Q
/F2 13/Times-Bold@0 SF 1.043(Note: All parts of the k)7.543 F(er)-.13 E
1.043(nel see the same virtual addr)-.195 F 1.043(ess mappings.)-.234 F
F1 -1.04(To)7.543 G 1.052(get the k)33.336 165 R 1.052
(ernel running on virtual, rather than ph)-.13 F 1.052
(ysical addresses, page tables are created)-.065 F 4.736
(which map 0xC00000000 to ph)33.336 180 R 4.737
(ysical address 0x00100000, and so on for higher)-.065 F .51
(addresses, until the entire static part of the k)33.336 195 R .51
(ernel \(te)-.13 F .509(xt, data, bss\) has been mapped.)-.195 F(The)
7.009 E .126(static bss pages are e)33.336 210 R .126
(xplicitly zero-\214lled at this time.)-.195 F 3.376(At)6.626 G .126
(emporary stack is set up to allo)-3.376 F(w)-.325 E(the k)33.336 225 Q
(ernel initialization code to run.)-.13 E 3.25<8354>33.336 240 S
(he MMU is turned on and thereafter the k)-3.25 E
(ernel runs on virtual addresses.)-.13 E 4.594<8354>33.336 255 S 1.344
(he ph)-4.594 F 1.344
(ysical page frames that are not part of the static part of the k)-.065
F 1.343(ernel become the)-.13 F .422(page frame pool.)33.336 270 R .423
(The k)6.923 F .423
(ernel is able to dynamically allocate memory for itself out of this)
-.13 F(pool, in addition to satisfying user)33.336 285 Q(-le)-.26 E
-.195(ve)-.325 G 3.25(lp).195 G(age f)-3.25 E(ault demands.)-.13 E 6.222
<8354>33.336 300 S 2.971(he interrupt v)-6.222 F 2.971(ector tables are\
 appropriately initialized \(see "Interrupt Handling in)-.195 F(Hardw)
33.336 315 Q(are" belo)-.13 E(w\).)-.325 E 6.372<8354>33.336 330 S 3.122
(he k)-6.372 F 3.122(ernel then calls initialization routines for its v)
-.13 F 3.123(arious subsystems, e.g. virtual)-.325 F(memory)33.336 345 Q
3.429<2c8c>-.845 G .179(le systems, scheduling.)-3.429 F(The)6.679 E
3.429(ya)-.195 G .178(llocate dynamic k)-3.429 F .178
(ernel memory as needed.)-.13 F(An)9.928 E(in)33.336 360 Q -.195(ve)-.52
G .884(ntory of hardw).195 F .884(are de)-.13 F .884(vices is tak)-.325
F .884(en and the initialization routines for each de)-.13 F .884
(vice are)-.325 F(called.)33.336 375 Q 3.25<8349>33.336 390 S
(nterrupts are no)-3.25 E 3.25(we)-.325 G(nabled.)-3.25 E 3.744<834e>
33.336 405 S 1.144 -.325(ow t)-3.744 H .494(he k).325 F .493
(ernel is able to pro)-.13 F .493(vide its services, b)-.195 F .493
(ut has no user)-.26 F .493(-mode processes to which)-.26 F(the)33.336
420 Q 4.727(yc)-.195 G 1.477(an be pro)-4.727 F 1.477(vided yet.)-.195 F
1.477(The de)7.977 F 1.477
(vice which contains the root \214lesystem is determined)-.325 F(from i\
nformation passed during boot loading, and the root \214lesystem is mou\
nted.)33.336 435 Q 5.241<8354>33.336 450 S 1.991(he k)-5.241 F 1.991
(ernel creates process #1 and causes that process to e)-.13 F -.195(xe)
-.195 G 1.99(c/map a speci\214c binary).195 F 3.495(program \()33.336
465 R/F3 13/Courier@0 SF(/sbin/init)A F1 3.496(\), running as the super)
B 3.496(-user \(uid and gid = 0\).)-.26 F 3.496(This "init")9.996 F .125
(program must reside on the root \214lesystem, and is the bridge betwee\
n k)33.336 480 R .125(ernel initialization)-.13 F(and user)33.336 495 Q
(-mode initialization.)-.26 E
(It remains running for the life of the system.)6.5 E 5.875<8370>33.336
510 S 2.625(id 1 is mark)-5.875 F 2.625(ed as ready to run and the k)
-.13 F 2.626(ernel relinquishes control to the process)-.13 F 2.377(sch\
eduler which immediately selects pid 1 to run \(since there is nothing \
else to do!\))33.336 525 R 1.445(Control no)33.336 540 R 4.695(we)-.325
G 1.445(xits k)-4.89 F 1.445(ernel mode and the init process be)-.13 F
1.446(gins to e)-.195 F -.195(xe)-.195 G 1.446(cute at user le).195 F
-.195(ve)-.325 G 4.696(l. Of).195 F 2.498
(course control immediately re-enters the k)33.336 555 R 2.498
(ernel as init page-f)-.13 F 2.498(aults in its \214rst page of)-.13 F
-.195(exe)33.336 570 S(cutable te).195 E(xt.)-.195 E 3.51<8346>33.336
585 S(irst,)-3.51 E F3(init)3.511 E F1 .261(runs a series of programs a\
nd shell scripts which complete the initialization)3.511 F .717
(of the system.)33.336 600 R .716
(This includes locating and mounting other \214lesystem v)7.216 F .716
(olumes as needed.)-.26 F 3.019(Then, init spa)33.336 615 R 3.019
(wns other user)-.195 F 3.02(-mode programs which ultimately pro)-.26 F
3.02(vide access to the)-.195 F(machine for the end-user)33.336 630 Q(.)
-.715 E/F4 13/Times-Italic@0 SF .308(Note: on mor)33.336 660 R 3.558(er)
-.481 G .307(ecent Linux systems, the str)-4.039 F(aightforwar)-.195 E
.307(d, tr)-.481 F .307(aditional /sbin/init is r)-.195 F(eplaced)-.481
E .912(by a mor)33.336 675 R 4.162(eu)-.481 G .912
(nwieldy /bin/systemd.)-4.162 F .912(Either way)7.412 F 4.163(,i)-.715 G
4.163(ti)-4.163 G 4.163(sp)-4.163 G .913(id #1 whic)-4.163 F 4.163(hi)
-.195 G 4.163(sr)-4.163 G .913(esponsible for user)-4.644 F(-)-.26 E(le)
33.336 690 Q(vel system startup)-.195 E F1 3.043(When booting up a mult\
iprocessor machine, the BIOS starts the machine in single-)33.336 720 R
.094(processor mode.)33.336 735 R -.195(Fa)6.594 G .094
(irly late in the k).195 F(ernel')-.13 E 3.344(si)-.715 G .095
(nitialization, the other processors are enabled.)-3.344 F 0 Cg EP
%%Page: 4 4
%%BeginPageSetup
BP
%%EndPageSetup
/F0 9/Times-Roman@0 SF(ECE357:Computer Operating Systems)33.336 60 Q
(Unit 7/pg 4)73.998 E(\2512016 Jef)144.405 E 2.25(fH)-.225 G(akner)-2.25
E/F1 13/Times-Roman@0 SF(The)33.336 120 Q 4.337(ya)-.195 G 1.087
(re initially gi)-4.337 F -.195(ve)-.325 G 4.337(nt).195 G(he)-4.337 E
/F2 13/Times-Italic@0 SF 1.087(idle task)4.337 F F1 1.087(to run.)4.337
F 1.087(Once additional processes other than pid 1)7.587 F
(are runnable, the other CPUs will start to pick up their loads.)33.336
135 Q/F3 13/Times-Bold@0 SF(Re-entering the k)205.04 165 Q(er)-.13 E
(nel)-.195 E F1 3.083 -1.04(We h)33.336 201 T -2.925 -.26(av e)1.04 H
1.004(seen that there is one initial entrypoint to the k)4.513 F 1.004
(ernel, through the boot process.)-.13 F(Thereafter)33.336 216 Q 3.882
(,t)-.52 G .631(he k)-3.882 F .631(ernel relinquishes control to user)
-.13 F .631(-mode processes.)-.26 F .631(The k)7.131 F .631
(ernel is entered)-.13 F(ag)33.336 231 Q
(ain only through the interrupt mechanism.)-.065 E 2.08 -1.04(We c)
33.336 252 T(an broadly di)1.04 E(vide re-entry into tw)-.325 E 3.25(oc)
-.13 G(ate)-3.25 E(gories:)-.195 E<83>33.336 267 Q F3(Synchr)6.647 E
(onous)-.234 E F1 6.647(:W)C 3.397
(hen the interupt is raised because of the e)-6.647 F -.195(xe)-.195 G
3.397(cution of a speci\214c).195 F 2.211
(instruction, that is said to be synchronous.)33.336 282 R 2.211
(The Linux k)8.711 F 2.211(ernel calls these synchronous)-.13 F -2.795
-.325(ev e)33.336 297 T(nts).325 E F3(Exceptions)4.654 E F1 7.904(.O)C
1.404(ther similar terms are "F)-7.904 F 1.404(ault" and "T)-.195 F
4.654(rap". Exceptions)-.455 F 1.404(are said to)4.654 F 2.672
(occur in the conte)33.336 312 R 2.672
(xt of a particular running process.)-.195 F 2.672(The k)9.172 F 2.672
(ernel associates a unique)-.13 F -.13(ke)33.336 327 S 1.057
(rnel-mode stack for each process \(or to be precise, for each user).13
F(-le)-.26 E -.195(ve)-.325 G 4.307(lt).195 G 1.057(hread\), and so)
-4.307 F .357(we can think of the k)33.336 342 R .356
(ernel as containing one k)-.13 F .356
(ernel-mode thread of control for each user)-.13 F(-)-.26 E(le)33.336
357 Q -.195(ve)-.325 G 4.101(lt).195 G .851(hread, which gets acti)
-4.101 F -.325(va)-.325 G .851(ted when an e).325 F .852
(xception is raised.)-.195 F .852(Thus the handling of the)7.352 F -.195
(ex)33.336 372 S .572(ception in the k).195 F .572(ernel is in ef)-.13 F
.572(fect a controlled e)-.325 F .572(xtension of the user)-.195 F(-le)
-.26 E -.195(ve)-.325 G 3.822(lt).195 G .572(hread into the)-3.822 F
-.13(ke)33.336 387 S(rnel.).13 E<83>33.336 402 Q F3(Asynchr)5.036 E
(onous)-.234 E F1 5.036(:T)C 1.786(hese e)-5.036 F -.195(ve)-.325 G
1.786(nts are not correlated with a speci\214c instruction, b).195 F
1.787(ut come)-.26 F 2.017(from hardw)33.336 417 R 2.017(are de)-.13 F
5.266(vices. The)-.325 F 2.016(Linux k)5.266 F 2.016
(ernel calls these "Interrupts", which is some)-.13 F(what)-.325 E .501
(ambiguous because Exceptions are also a form of interrupt.)33.336 432 R
.501(Asynchronous interrupts are)7.001 F(handled on whate)33.336 447 Q
-.195(ve)-.325 G 3.25(rk).195 G(ernel-mode stack happens to be acti)
-3.38 E .39 -.195(ve a)-.325 H 3.25(tt).195 G(he time.)-3.25 E .435
(In most operating systems literature, synchronous entries to the k)
33.336 468 R .434(ernel are said to be ")-.13 F F2(top)A(half)33.336 483
Q F1 2.168(," and asynchronous are said to be in the ")B F2 2.168
(bottom half)B F1 5.418(". Unfortunately)B 2.168(the Linux)5.418 F -.13
(ke)33.336 498 S .127
(rnel uses the term "bottom half" in an inconsistent manner).13 F 3.377
(,s)-.52 G 3.377(ow)-3.377 G 3.377(ew)-3.377 G .127(ill a)-3.377 F -.26
(vo)-.26 G .127(id top/bottom).26 F
(half terminology to reduce confusion.)33.336 513 Q F3(Exception T)
221.771 543 Q(ypes)-.962 E F1 3.523<834d>33.336 573 S(an)-3.523 E 3.523
(ye)-.195 G .274(xceptions are the result of program error)-3.718 F
6.774(.T)-.715 G .274(hese are also called)-6.774 F F3(faults)3.524 E F1
3.524(.Af)C .274(ault is)-3.654 F 2.732
(de\214ned as a condition which pre)33.336 588 R -.195(ve)-.325 G 2.732
(nts the current opcode from being e).195 F -.195(xe)-.195 G 5.982
(cuted. The).195 F(def)33.336 603 Q .674(ault beha)-.13 F .674
(vior of the k)-.26 F .674(ernel for most f)-.13 F .675
(aults is to post a signal to the of)-.13 F .675(fending process.)-.325
F(Examples of such f)33.336 618 Q(aults include: inte)-.13 E(ger di)
-.195 E(vide by 0 and ille)-.325 E -.065(ga)-.195 G 3.25(li).065 G
(nstruction.)-3.25 E 4.701<8341>33.336 633 S F3 -.13(Pa)C 1.451(ge F).13
F(ault)-.325 E F1 -.195(ex)4.701 G 1.451(ception occurs when the hardw)
.195 F 1.45(are w)-.13 F 1.45(as unable to perform a memory)-.13 F 4.875
(access. On)33.336 648 R 1.625(the x86-32 architecture, this same f)
4.875 F 1.625(ault type is used both for when a v)-.13 F(alid)-.325 E
2.205(PTE can not be found and for a protection violation, the distinct\
ion between the tw)33.336 663 R(o)-.13 E .471(being passed to the f)
33.336 678 R .471(ault handler by hardw)-.13 F .472
(are in a speci\214c re)-.13 F(gister)-.195 E 6.972(.P)-.715 G .472
(age F)-7.167 F .472(aults are quite)-.195 F
(normal and not necessarily a sign of program error)33.336 693 Q 3.25
(,a)-.52 G 3.25(sd)-3.25 G(iscussed in Unit 5.)-3.25 E 4.203<8354>33.336
708 S .953(he k)-4.203 F .953(ernel uses some e)-.13 F .953
(xceptions to be cle)-.195 F -.195(ve)-.325 G 4.203(ra).195 G .953
(nd ef)-4.203 F .952(\214cient about things.)-.325 F -.195(Fo)7.452 G
4.202(re).195 G(xample,)-4.397 E .488(the k)33.336 723 R .488
(ernel usually does not bother with \215oating point re)-.13 F 3.739
(gisters. It)-.195 F .489(turns the \215oating point)3.739 F 3.276
(unit of)33.336 738 R 3.275(f, and then if the process tries to use a \
\215oating-point operation, it raises an)-.325 F 0 Cg EP
%%Page: 5 5
%%BeginPageSetup
BP
%%EndPageSetup
/F0 9/Times-Roman@0 SF(ECE357:Computer Operating Systems)33.336 60 Q
(Unit 7/pg 5)73.998 E(\2512016 Jef)144.405 E 2.25(fH)-.225 G(akner)-2.25
E/F1 13/Times-Roman@0 SF -.195(ex)33.336 120 S .685(ception and the k)
.195 F .685(ernel kno)-.13 F .685(ws that it needs to w)-.325 F .685
(orry about it for that process.)-.13 F .685(So these)7.185 F -.195(ex)
33.336 135 S .763(ceptions are lik).195 F 4.013(eaP)-.13 G .763(age F)
-4.208 F .762(ault, in that the k)-.195 F(ernel')-.13 E 4.012(sh)-.715 G
.762(andler must determine whether the)-4.012 F -.195(ex)33.336 150 S
(ception is benign or the result of an errant program.).195 E 3.451
<8357>33.336 165 S .202(hen f)-3.451 F .202(aults are resolv)-.13 F .202
(ed successfully by the k)-.195 F .202
(ernel, control returns to user le)-.13 F -.195(ve)-.325 G 3.452(la).195
G .202(nd the)-3.452 F(pre)33.336 180 Q(viously f)-.325 E
(aulted instruction is re-tried, and this time should succeed.)-.13 E
3.55<8341>33.336 195 S/F2 13/Times-Bold@0 SF .3(System Call)B F1 .3
(is a particularly important type of e)3.55 F .3(xception, and we')-.195
F .299(ll spend some time)-.13 F(looking at system calls in detail.)
33.336 210 Q F2(Interrupt T)223.22 240 Q(ypes)-.962 E F1 3.63<8348>
33.336 270 S(ardw)-3.63 E .38(are de)-.13 F .38
(vices will raise interrupts to indicate that the)-.325 F 3.631(yh)-.195
G -2.925 -.26(av e)-3.631 H .381(entered a ready or non-)3.891 F
(ready state, that data are a)33.336 285 Q -.325(va)-.26 G
(ilable, or that a data transfer operation has completed.).325 E 6.614
<8354>33.336 300 S 3.364(he k)-6.614 F 3.364
(ernel programs a chip on the motherboard to deli)-.13 F -.195(ve)-.325
G 6.614(rap).195 G 3.364(eriodic "heartbeat")-6.614 F .86
(interrupt, e.g. e)33.336 315 R -.195(ve)-.325 G .86(ry millisecond.)
.195 F(This)7.36 E F2 -.26(Pe)4.11 G .86(riodic Inter).26 F -.13(va)-.13
G 4.11(lT).13 G .861(imer \(PIT\))-4.344 F F1 .861(is v)4.111 F .861
(ery important)-.195 F 5.823(to the scheduler)33.336 330 R 12.323(.O)
-.715 G 5.823(ther time-based e)-12.323 F -.195(ve)-.325 G 5.823
(nts in the k).195 F 5.823(ernel \(e.g. netw)-.13 F 5.822(ork protocol)
-.13 F(retransmission timers\) are deri)33.336 345 Q -.195(ve)-.325 G
3.25(df).195 G(rom this clock source.)-3.25 E 3.992<834f>33.336 360 S
3.992(nam)-3.992 G .742(ulti-processor system, one processor may e)
-3.992 F -.195(xe)-.195 G .742(cute a series of instructions which).195
F 2.083(cause a hardw)33.336 375 R 2.083
(are interrupt to be posted to the other processors.)-.13 F 2.082
(This is kno)8.582 F 2.082(wn as an)-.325 F F2(Inter)33.336 390 Q(-pr)
-.481 E .122(ocessor Interrupt \(IPI\))-.234 F F1 6.622(.T)C .122
(he Linux k)-6.622 F .122(ernel uses this in se)-.13 F -.195(ve)-.325 G
.123(ral speci\214c cases: \(a\)).195 F 3.564 -1.04(To s)33.336 405 T
1.484(hut do)1.04 F 1.484(wn the system)-.325 F 1.484
(\(b\) to request that the other processors re-e)7.984 F 1.483
(xamine their task)-.195 F(scheduling \(co)33.336 420 Q -.195(ve)-.195 G
(red in ne).195 E(xt unit\))-.195 E(\(c\) to pur)6.5 E
(ge stale TLB entries.)-.234 E 3.512<8348>33.336 435 S(ardw)-3.512 E
.262(are will deli)-.13 F -.195(ve)-.325 G 3.513(ri).195 G .263
(nterrupts to notify the k)-3.513 F .263(ernel of important system e)
-.13 F -.195(ve)-.325 G .263(nts, such as).195 F 4.192(ah)33.336 450 S
(ardw)-4.192 E .942(are f)-.13 F .942(ailure, battery po)-.13 F .942
(wer f)-.325 F .941(ailure, etc.)-.13 F .941
(If continued system operation is possible,)7.441 F .092(the k)33.336
465 R .092(ernel will ultimately translate these into user)-.13 F .092
(-mode e)-.26 F -.195(ve)-.325 G 3.342(nts. Otherwise).195 F .092(the k)
3.342 F .093(ernel will)-.13 F(print out an informati)33.336 480 Q .39
-.195(ve m)-.325 H(essage and halt the system.).195 E F2(Important Shar)
122.08 510 Q(ed Pr)-.234 E(ocessor/K)-.234 E(er)-.325 E
(nel Data Structur)-.195 E(es)-.234 E F1 2.998(The beha)33.336 546 R
2.998(vior of the CPU is hard-wired \(or programmed in its microcode\) \
and thus)-.26 F 2.912(immutable to an)33.336 561 R 6.162(ys)-.195 G
(oftw)-6.162 E 2.912(are code including the k)-.13 F 6.162(ernel. The)
-.13 F -.13(ke)6.162 G 2.912(rnel is compiled for a).13 F .798
(speci\214c architecture and kno)33.336 576 R .798
(ws about data structures that the processor e)-.325 F .798
(xpects to see in)-.195 F(memory)33.336 591 Q 3.49(,w)-.845 G .24
(hich control ho)-3.49 F 3.49(wt)-.325 G .241
(he processor reacts to certain e)-3.49 F -.195(ve)-.325 G 3.491
(nts. Because).195 F .241(the processor)3.491 F 1.111
(itself must respond to virtual memory lookup f)33.336 606 R 1.11
(ailures \(page f)-.13 F 1.11(aults\) these data structures)-.13 F 1.306
(are typically de\214ned at ph)33.336 621 R 1.307
(ysical, rather than virtual memory addresses.)-.065 F 1.307
(On the X86-32)7.807 F(bit architecture, these data structures are:)
33.336 636 Q 4.804<8354>33.336 651 S(he)-4.804 E F2 1.554
(Interrupt Descriptor T)4.804 F 1.554(able \(IDT\))-1.196 F F1 1.554
(is an array of 256 interrupt descriptors.)4.804 F(The)8.054 E(ph)33.336
666 Q 2.118(ysical address of this array is set via the special)-.065 F
/F3 13/Courier@0 SF(idtr)5.368 E F1(re)5.368 E(gister)-.195 E 5.368(,w)
-.52 G 2.119(hich can only be)-5.368 F .734
(accessed through special pri)33.336 681 R(vile)-.325 E .733
(ged instructions LIDT and SIDT)-.195 F 7.233(.A)-.962 G .733
(lthough the structure)-7.233 F 2.45
(of the IDT is baroque because of le)33.336 696 R -.065(ga)-.195 G 2.841
-.195(cy X).065 H 2.451(86 se).195 F 2.451
(gmented memory model issues, it is)-.195 F 1.426(basically a table of \
program counter \(%eip\) addresses, which are the handler addresses)
33.336 711 R .954
(\(virtual addresses\) for each of the 256 possible interrupt or e)
33.336 726 R(xception/f)-.195 E .955(ault v)-.13 F 4.205(ectors. The)
-.195 F -.13(ke)33.336 741 S 1.769
(rnel has initialized all IDT entries to point to v).13 F 1.769(alid k)
-.325 F 1.769(ernel functions before allo)-.13 F(wing)-.325 E 0 Cg EP
%%Page: 6 6
%%BeginPageSetup
BP
%%EndPageSetup
/F0 9/Times-Roman@0 SF(ECE357:Computer Operating Systems)33.336 60 Q
(Unit 7/pg 6)73.998 E(\2512016 Jef)144.405 E 2.25(fH)-.225 G(akner)-2.25
E/F1 13/Times-Roman@0 SF(user)33.336 120 Q(-le)-.26 E -.195(ve)-.325 G
4.055(lc).195 G .805(ode to be)-4.055 F .805(gin e)-.195 F -.195(xe)
-.195 G .805(cution after system boot.).195 F .805
(The IDT is generally not modi\214ed)7.305 F(after this.)33.336 135 Q
4.323<8354>33.336 150 S(he)-4.323 E/F2 13/Times-Bold@0 SF -1.196(Ta)
4.322 G 1.072(sk State Segment \(TSS\))1.196 F F1 1.072
(is a small data structure which resides inside a lar)4.322 F(ger)-.234
E .928(data structure kno)33.336 165 R .928
(wn as the Global Descriptor T)-.325 F .928(able \(GDT\).)-1.04 F .928
(The Linux k)7.428 F .928(ernel does not)-.13 F .617
(utilize all of the functionality that is a)33.336 180 R -.325(va)-.26 G
.617(ilable with the TSS, b).325 F .616(ut uses it simply to control)
-.26 F 3.01
(the stack pointer address that will be used during interrupt/e)33.336
195 R 3.01(xception handling.)-.195 F(The)9.511 E(special)33.336 210 Q
/F3 13/Courier@0 SF(tr)3.985 E F1(re)3.984 E .734
(gister controls the location of the TSS and is generally set once.)
-.195 F .734(On multi-)7.234 F
(processor systems, there is a TSS for each processor)33.336 225 Q(.)
-.715 E 5.112<8354>33.336 240 S 1.862
(he page table, which has been described in unit #5.)-5.112 F(The)8.363
E F3(cr3)5.113 E F1(re)5.113 E 1.863(gister controls the)-.195 F(ph)
33.336 255 Q(ysical address of the highest-le)-.065 E -.195(ve)-.325 G
3.25(lp).195 G(age table \(the P)-3.25 E(age Global Directory\).)-.195 E
0 0 360 559 -374.812 582 87.336 650.812 PBEGIN
%%BeginDocument: idt.eps
%!PS-Adobe-2.0 EPSF-2.0
%%Title: idt.fig
%%Creator: fig2dev Version 3.2 Patchlevel 4
%%CreationDate: Wed Nov  4 23:17:04 2015
%%For: hak@lex ()
%%BoundingBox: 0 0 559 582
%%Magnification: 1.0000
%%EndComments
/$F2psDict 200 dict def
$F2psDict begin
$F2psDict /mtrx matrix put
/col-1 {0 setgray} bind def
/col0 {0.000 0.000 0.000 srgb} bind def
/col1 {0.000 0.000 1.000 srgb} bind def
/col2 {0.000 1.000 0.000 srgb} bind def
/col3 {0.000 1.000 1.000 srgb} bind def
/col4 {1.000 0.000 0.000 srgb} bind def
/col5 {1.000 0.000 1.000 srgb} bind def
/col6 {1.000 1.000 0.000 srgb} bind def
/col7 {1.000 1.000 1.000 srgb} bind def
/col8 {0.000 0.000 0.560 srgb} bind def
/col9 {0.000 0.000 0.690 srgb} bind def
/col10 {0.000 0.000 0.820 srgb} bind def
/col11 {0.530 0.810 1.000 srgb} bind def
/col12 {0.000 0.560 0.000 srgb} bind def
/col13 {0.000 0.690 0.000 srgb} bind def
/col14 {0.000 0.820 0.000 srgb} bind def
/col15 {0.000 0.560 0.560 srgb} bind def
/col16 {0.000 0.690 0.690 srgb} bind def
/col17 {0.000 0.820 0.820 srgb} bind def
/col18 {0.560 0.000 0.000 srgb} bind def
/col19 {0.690 0.000 0.000 srgb} bind def
/col20 {0.820 0.000 0.000 srgb} bind def
/col21 {0.560 0.000 0.560 srgb} bind def
/col22 {0.690 0.000 0.690 srgb} bind def
/col23 {0.820 0.000 0.820 srgb} bind def
/col24 {0.500 0.190 0.000 srgb} bind def
/col25 {0.630 0.250 0.000 srgb} bind def
/col26 {0.750 0.380 0.000 srgb} bind def
/col27 {1.000 0.500 0.500 srgb} bind def
/col28 {1.000 0.630 0.630 srgb} bind def
/col29 {1.000 0.750 0.750 srgb} bind def
/col30 {1.000 0.880 0.880 srgb} bind def
/col31 {1.000 0.840 0.000 srgb} bind def

end
save
newpath 0 582 moveto 0 0 lineto 559 0 lineto 559 582 lineto closepath clip newpath
-0.0 630.7 translate
1 -1 scale

/cp {closepath} bind def
/ef {eofill} bind def
/gr {grestore} bind def
/gs {gsave} bind def
/sa {save} bind def
/rs {restore} bind def
/l {lineto} bind def
/m {moveto} bind def
/rm {rmoveto} bind def
/n {newpath} bind def
/s {stroke} bind def
/sh {show} bind def
/slc {setlinecap} bind def
/slj {setlinejoin} bind def
/slw {setlinewidth} bind def
/srgb {setrgbcolor} bind def
/rot {rotate} bind def
/sc {scale} bind def
/sd {setdash} bind def
/ff {findfont} bind def
/sf {setfont} bind def
/scf {scalefont} bind def
/sw {stringwidth} bind def
/tr {translate} bind def
/tnt {dup dup currentrgbcolor
  4 -2 roll dup 1 exch sub 3 -1 roll mul add
  4 -2 roll dup 1 exch sub 3 -1 roll mul add
  4 -2 roll dup 1 exch sub 3 -1 roll mul add srgb}
  bind def
/shd {dup dup currentrgbcolor 4 -2 roll mul 4 -2 roll mul
  4 -2 roll mul srgb} bind def
/$F2psBegin {$F2psDict begin /$F2psEnteredState save def} def
/$F2psEnd {$F2psEnteredState restore end} def

$F2psBegin
10 setmiterlimit
0 slj 0 slc
 0.06000 0.06000 sc
%
% Fig objects follow
%
% 
% here starts figure with depth 50
% Polyline
7.500 slw
n 1200 1200 m 3600 1200 l 3600 1800 l 1200 1800 l
 cp gs col0 s gr 
% Polyline
n 1200 1800 m 3600 1800 l 3600 2400 l 1200 2400 l
 cp gs col0 s gr 
% Polyline
n 1200 2400 m 3600 2400 l 3600 3000 l 1200 3000 l
 cp gs col0 s gr 
% Polyline
n 1200 3000 m 3600 3000 l 3600 3600 l 1200 3600 l
 cp gs col0 s gr 
% Polyline
n 1200 3600 m 3600 3600 l 3600 4200 l 1200 4200 l
 cp gs col0 s gr 
% Polyline
n 1200 4200 m 3600 4200 l 3600 4800 l 1200 4800 l
 cp gs col0 s gr 
% Polyline
n 1200 4800 m 3600 4800 l 3600 5400 l 1200 5400 l
 cp gs col0 s gr 
% Polyline
n 1200 5400 m 3600 5400 l 3600 6000 l 1200 6000 l
 cp gs col0 s gr 
% Polyline
n 1200 6000 m 3600 6000 l 3600 6600 l 1200 6600 l
 cp gs col0 s gr 
% Polyline
n 1200 6600 m 3600 6600 l 3600 7200 l 1200 7200 l
 cp gs col0 s gr 
% Polyline
n 1200 7200 m 3600 7200 l 3600 7800 l 1200 7800 l
 cp gs col0 s gr 
% Polyline
n 1200 7800 m 3600 7800 l 3600 8400 l 1200 8400 l
 cp gs col0 s gr 
% Polyline
n 1200 8400 m 3600 8400 l 3600 9900 l 1200 9900 l
 cp gs col0 s gr 
% Polyline
n 1200 9900 m 3600 9900 l 3600 10500 l 1200 10500 l
 cp gs col0 s gr 
% Polyline
gs  clippath
1140 1305 m 1140 1245 l 988 1245 l 1108 1275 l 988 1305 l cp
eoclip
n 450 1275 m
 1125 1275 l gs col0 s gr gr

% arrowhead
n 988 1305 m 1108 1275 l 988 1245 l  col0 s
% Polyline
n 6000 1200 m 9300 1200 l 9300 8700 l 6000 8700 l
 cp gs col0 s gr 
% Polyline
gs  clippath
6108 2402 m 6056 2371 l 5979 2501 l 6067 2414 l 6031 2532 l cp
eoclip
n 2625 8175 m
 6075 2400 l gs col0 s gr gr

% arrowhead
n 6031 2532 m 6067 2414 l 5979 2501 l  col0 s
% Polyline
gs  clippath
6299 3558 m 6326 3505 l 6191 3435 l 6285 3517 l 6164 3489 l cp
eoclip
n 2325 1500 m
 6300 3525 l gs col0 s gr gr

% arrowhead
n 6164 3489 m 6285 3517 l 6191 3435 l  col0 s
% Polyline
gs  clippath
6157 4832 m 6171 4774 l 6025 4737 l 6134 4796 l 6010 4795 l cp
eoclip
n 2625 3900 m
 6150 4800 l gs col0 s gr gr

% arrowhead
n 6010 4795 m 6134 4796 l 6025 4737 l  col0 s
% Polyline
gs  clippath
6218 5882 m 6255 5835 l 6135 5743 l 6212 5840 l 6098 5790 l cp
eoclip
n 3000 3375 m
 6225 5850 l gs col0 s gr gr

% arrowhead
n 6098 5790 m 6212 5840 l 6135 5743 l  col0 s
% Polyline
gs  clippath
6227 7233 m 6250 7177 l 6110 7120 l 6210 7194 l 6087 7175 l cp
eoclip
n 2775 5775 m
 6225 7200 l gs col0 s gr gr

% arrowhead
n 6087 7175 m 6210 7194 l 6110 7120 l  col0 s
/Times-Roman ff 200.00 scf sf
2250 8775 m
gs 1 -1 sc (.) col0 sh gr
/Times-Roman ff 200.00 scf sf
2250 9285 m
gs 1 -1 sc (.) col0 sh gr
/Times-Roman ff 200.00 scf sf
2250 9795 m
gs 1 -1 sc (.) col0 sh gr
/Times-Roman ff 200.00 scf sf
0 1200 m
gs 1 -1 sc (%idtr) col0 sh gr
/Times-Roman ff 200.00 scf sf
300 1500 m
gs 1 -1 sc (\(Phys) col0 sh gr
/Times-Roman ff 200.00 scf sf
300 1755 m
gs 1 -1 sc (Addr\)) col0 sh gr
/Times-Roman ff 200.00 scf sf
6825 975 m
gs 1 -1 sc (Kernel Text) col0 sh gr
/Times-Roman ff 200.00 scf sf
5850 1275 m
gs 1 -1 sc (C0000000) dup sw pop neg 0 rm  col0 sh gr
/Times-Roman ff 200.00 scf sf
6150 2400 m
gs 1 -1 sc (system_call:) col0 sh gr
/Times-Roman ff 200.00 scf sf
5100 1500 m
gs 1 -1 sc (\(Virt) col0 sh gr
/Times-Roman ff 200.00 scf sf
5100 1755 m
gs 1 -1 sc (Addr\)) col0 sh gr
/Times-Roman ff 200.00 scf sf
6375 3525 m
gs 1 -1 sc (divide_error:) col0 sh gr
/Times-Roman ff 200.00 scf sf
3750 1650 m
gs 1 -1 sc (#0) col0 sh gr
/Times-Roman ff 200.00 scf sf
3750 3900 m
gs 1 -1 sc (#14) col0 sh gr
/Times-Roman ff 200.00 scf sf
6300 4800 m
gs 1 -1 sc (page_fault:) col0 sh gr
/Times-Roman ff 200.00 scf sf
3750 3375 m
gs 1 -1 sc (#6) col0 sh gr
/Times-Roman ff 200.00 scf sf
6300 5850 m
gs 1 -1 sc (invalid_op:) col0 sh gr
/Times-Roman ff 200.00 scf sf
1725 975 m
gs 1 -1 sc (IDT \(incomplete example\)) col0 sh gr
/Times-Roman ff 200.00 scf sf
3750 8100 m
gs 1 -1 sc (#128) col0 sh gr
/Times-Roman ff 200.00 scf sf
3750 5700 m
gs 1 -1 sc (#32) col0 sh gr
/Times-Roman ff 200.00 scf sf
6300 7200 m
gs 1 -1 sc (timer:) col0 sh gr
% here ends figure;
$F2psEnd
rs
showpage
%%EndDocument
end PEND F2(Interrupt and Exception handling in hard)137.713 686.812 Q
(war)-.195 E(e)-.234 E F1 .168
(On the 32-bit X86 architecture, the follo)33.336 722.812 R .168
(wing steps are tak)-.325 F .168(en by the processor in response)-.13 F
(to an interrupt or e)33.336 737.812 Q(xception:)-.195 E 0 Cg EP
%%Page: 7 7
%%BeginPageSetup
BP
%%EndPageSetup
/F0 9/Times-Roman@0 SF(ECE357:Computer Operating Systems)33.336 60 Q
(Unit 7/pg 7)73.998 E(\2512016 Jef)144.405 E 2.25(fH)-.225 G(akner)-2.25
E/F1 13/Times-Roman@0 SF 3.353<8345>33.336 120 S .103
(ach interrupt or e)-3.353 F .103(xception has an associated)-.195 F/F2
13/Times-Bold@0 SF -.13(ve)3.353 G(ctor).13 E F1 .103
(between 0 and 255.)3.353 F .104(This is used to)6.603 F(inde)33.336 135
Q 5.172(xt)-.195 G 1.922(he IDT)-5.172 F 5.172(,f)-.962 G 1.921
(rom which the handler address is fetched.)-5.172 F 1.921
(The handler address is the)8.421 F 1.627(virtual address of the \214rs\
t opcode of the associated handler function within the k)33.336 150 R
(ernel.)-.13 E 1.099
(This function is generally written in assembly language.)33.336 165 R
1.099(The k)7.599 F 1.099(ernel has made sure that)-.13 F 1.751
(all 256 entries ha)33.336 180 R 2.141 -.195(ve v)-.26 H 1.751
(alid handler addresses.)-.13 F 1.751(In the X86 architecture, v)8.251 F
1.751(ectors 0-31 are)-.195 F(reserv)33.336 195 Q .759(ed for processor)
-.195 F .759(-generated e)-.26 F .758(xceptions, while 32-255 are user)
-.195 F .758(-de\214ned and typically)-.26 F(used for I/O de)33.336 210
Q(vices \(the system call v)-.325 E(ector)-.195 E 3.25(,1)-.52 G
(28 decimal, f)-3.25 E(alls within this range\))-.13 E 4.237<8357>33.336
225 S .987(hen the processor is currently running in User mode, it fetc\
hes the TSS.)-4.237 F -.52(Wi)7.488 G .988(thin the).52 F .562
(TSS is the ne)33.336 240 R 3.812(wv)-.325 G .562
(alue \(virtual address\) of the stack pointer)-4.137 F 7.061(.T)-.715 G
.561(his will be the k)-7.061 F(ernel-mode)-.13 E .672
(stack, as described later)33.336 255 R 7.172(.T)-.715 G .672(he k)
-7.172 F .672(ernel maintains a separate k)-.13 F .673
(ernel stack for each task \(this)-.13 F 2.759
(includes each thread in a multi-threaded program\), and mak)33.336 270
R 2.759(es sure the correct stack)-.13 F 1.082(address w)33.336 285 R
1.082(as placed within the TSS before performing a conte)-.13 F 1.082
(xt switch.)-.195 F 1.082(If ho)7.582 F(we)-.325 E -.195(ve)-.325 G
2.122 -.52(r, t).195 H(he).52 E .531(processor w)33.336 300 R .531
(as already in Supervisor mode at the time of the e)-.13 F .531
(xception/interrupt, then the)-.195 F 2.717
(stack pointer is already within a v)33.336 315 R 2.717(alid k)-.325 F
2.717(ernel stack, and the TSS is not used by the)-.13 F(processor)
33.336 330 Q(.)-.715 E 4.999<8354>33.336 345 S 1.749(he processor no)
-4.999 F 4.999(wt)-.325 G 1.749
(ransitions to Supervisor mode, and the %esp re)-4.999 F 1.749
(gister is pointing)-.195 F(within the k)33.336 360 Q
(ernel-mode stack for the task.)-.13 E 5.439<8354>33.336 375 S 2.189
(he processor pushes onto the k)-5.439 F 2.19(ernel-mode stack the v)
-.13 F 2.19(alue of the old stack pointer)-.325 F(re)33.336 390 Q
(gister)-.195 E/F3 13/Courier@0 SF(%esp)6.797 E F1 6.797(,t)C 3.547
(he \215ags/status re)-6.797 F(gister)-.195 E F3(%eflags)6.796 E F1
6.796(,a)C 3.546(nd the program counter re)-6.796 F(gister)-.195 E F3
(%eip)33.336 405 Q F1 6.955(.T)C(he)-6.955 E F3(%cs)3.705 E F1(and)6.955
E F3(%ss)3.705 E F1(re)3.705 E .455(gisters \(which ha)-.195 F .845
-.195(ve t)-.26 H 3.705(od).195 G 3.705(ow)-3.705 G .455(ith ho)-3.705 F
3.705(wc)-.325 G .455(ode and stack memory)-3.705 F 2.26
(are accessed\) are also sa)33.336 420 R -.195(ve)-.26 G 5.51(d. This)
.195 F 2.26(set of 5 re)5.51 F 2.259
(gisters is critical because it is what the)-.195 F(hardw)33.336 435 Q
(are relies on to determine where the stack is, and where the ne)-.13 E
(xt instruction is.)-.195 E 3.653<8346>33.336 450 S .403
(or certain types of e)-3.848 F .403
(xceptions, the processor pushes an error code onto the stack.)-.195 F
(This)6.903 E
(is used, e.g., to distinguish between a page translation f)33.336 465 Q
(ault and a page protection f)-.13 E(ault.)-.13 E 4.263<8354>33.336 480
S 1.013(he program counter location of the handler)-4.263 F 4.262(,w)
-.52 G 1.012(hich w)-4.262 F 1.012(as fetched from the IDT)-.13 F 4.262
(,i)-.962 G 4.262(sn)-4.262 G -.325(ow)-4.262 G(loaded into the)33.336
495 Q F3(eip)3.25 E F1(re)3.25 E(gister)-.195 E 3.25(,e)-.52 G -.325(ff)
-3.25 G(ecting a jump to that entrypoint.).325 E 4.591<8352>33.336 510 S
1.341(ecall that the k)-4.591 F 1.342
(ernel controls the page tables, and establishes them for each process.)
-.13 F 1.446(The k)33.336 525 R 1.446
(ernel virtual address space, 0xC0000000-0xFFFFFFFF)-.13 F 4.696(,i)
-1.04 G 4.695(sa)-4.696 G -.13(lwa)-4.695 G 1.445(ys present in these)
.13 F 3.078(page tables, b)33.336 540 R 3.078
(ut the User/Supervisor \215ags in the P)-.26 F 3.078(age T)-.195 F
3.079(able Entries are set so user)-1.04 F .583
(processes can not directly access the k)33.336 555 R .583
(ernel memory \(this w)-.13 F .582(ould be really bad....ho)-.13 F(we)
-.325 E -.195(ve)-.325 G(r).195 E 1.961
(user processes running as root can use a pseudo-de)33.336 570 R(vice)
-.325 E F3(/dev/kmem)5.211 E F1 1.961(to access k)5.211 F(ernel)-.13 E
.909(memory as if it were a \214le\).)33.336 585 R .908
(This page table arrangement means that as soon as control)7.408 F
(enters the k)33.336 600 Q(ernel, the shared k)-.13 E
(ernel address space is immediately a)-.13 E -.325(va)-.26 G(ilable.)
.325 E(An)33.336 636 Q 4.331(yi)-.195 G 1.081(nterrupt or e)-4.331 F
1.081(xception handler ultimately terminates by e)-.195 F -.195(xe)-.195
G 1.082(cuting the special).195 F F3(iret)4.332 E F1
(instruction, which:)33.336 651 Q 3.25<8350>33.336 666 S(ops the 5 re)
-3.25 E(gisters from the stack which had been sa)-.195 E -.195(ve)-.26 G
3.25(db).195 G 3.25(yh)-3.25 G(ardw)-3.25 E(are.)-.13 E 5.182<8352>
33.336 681 S 1.932(esets the pri)-5.182 F(vile)-.325 E 1.932(ge le)-.195
F -.195(ve)-.325 G 5.182(lt).195 G 5.182(ot)-5.182 G 1.931(he pre)-5.182
F 1.931(vious v)-.325 F 1.931(alue \(because the e\215ags re)-.325 F
1.931(gister has been)-.195 F(restored from the stack\))33.336 696 Q
3.695<8352>33.336 711 S .445(esumes e)-3.695 F -.195(xe)-.195 G .446
(cution with the stack pointer no).195 F 3.696(ws)-.325 G .446
(et back to the original user)-3.696 F .446(-mode stack.)-.26 F 1.472
(Interrupts occur between instructions, and so e)33.336 726 R -.195(xe)
-.195 G 1.471(cution resumes at the ne).195 F 1.471(xt instruction.)
-.195 F -.195(Fo)33.336 741 S 7.325(re).195 G 4.075
(xception returns, if the instruction caused a f)-7.52 F 4.075
(ault \(e.g. P)-.13 F 4.075(age F)-.195 F 4.075(ault\) then that)-.195 F
0 Cg EP
%%Page: 8 8
%%BeginPageSetup
BP
%%EndPageSetup
/F0 9/Times-Roman@0 SF(ECE357:Computer Operating Systems)33.336 60 Q
(Unit 7/pg 8)73.998 E(\2512016 Jef)144.405 E 2.25(fH)-.225 G(akner)-2.25
E/F1 13/Times-Roman@0 SF(instruction is re-started, otherwise the ne)
33.336 120 Q(xt instruction is e)-.195 E -.195(xe)-.195 G(cuted.).195 E
0 0 468 604 -304.51 393 33.336 460.51 PBEGIN
%%BeginDocument: kern.eps
%!PS-Adobe-2.0 EPSF-2.0
%%Title: kern.fig
%%Creator: fig2dev Version 3.2 Patchlevel 4
%%CreationDate: Fri Oct 30 02:56:03 2009
%%For: hak@lex ()
%%BoundingBox: 0 0 604 393
%%Magnification: 1.0000
%%EndComments
/$F2psDict 200 dict def
$F2psDict begin
$F2psDict /mtrx matrix put
/col-1 {0 setgray} bind def
/col0 {0.000 0.000 0.000 srgb} bind def
/col1 {0.000 0.000 1.000 srgb} bind def
/col2 {0.000 1.000 0.000 srgb} bind def
/col3 {0.000 1.000 1.000 srgb} bind def
/col4 {1.000 0.000 0.000 srgb} bind def
/col5 {1.000 0.000 1.000 srgb} bind def
/col6 {1.000 1.000 0.000 srgb} bind def
/col7 {1.000 1.000 1.000 srgb} bind def
/col8 {0.000 0.000 0.560 srgb} bind def
/col9 {0.000 0.000 0.690 srgb} bind def
/col10 {0.000 0.000 0.820 srgb} bind def
/col11 {0.530 0.810 1.000 srgb} bind def
/col12 {0.000 0.560 0.000 srgb} bind def
/col13 {0.000 0.690 0.000 srgb} bind def
/col14 {0.000 0.820 0.000 srgb} bind def
/col15 {0.000 0.560 0.560 srgb} bind def
/col16 {0.000 0.690 0.690 srgb} bind def
/col17 {0.000 0.820 0.820 srgb} bind def
/col18 {0.560 0.000 0.000 srgb} bind def
/col19 {0.690 0.000 0.000 srgb} bind def
/col20 {0.820 0.000 0.000 srgb} bind def
/col21 {0.560 0.000 0.560 srgb} bind def
/col22 {0.690 0.000 0.690 srgb} bind def
/col23 {0.820 0.000 0.820 srgb} bind def
/col24 {0.500 0.190 0.000 srgb} bind def
/col25 {0.630 0.250 0.000 srgb} bind def
/col26 {0.750 0.380 0.000 srgb} bind def
/col27 {1.000 0.500 0.500 srgb} bind def
/col28 {1.000 0.630 0.630 srgb} bind def
/col29 {1.000 0.750 0.750 srgb} bind def
/col30 {1.000 0.880 0.880 srgb} bind def
/col31 {1.000 0.840 0.000 srgb} bind def

end
save
newpath 0 393 moveto 0 0 lineto 604 0 lineto 604 393 lineto closepath clip newpath
-36.0 414.7 translate
1 -1 scale

/cp {closepath} bind def
/ef {eofill} bind def
/gr {grestore} bind def
/gs {gsave} bind def
/sa {save} bind def
/rs {restore} bind def
/l {lineto} bind def
/m {moveto} bind def
/rm {rmoveto} bind def
/n {newpath} bind def
/s {stroke} bind def
/sh {show} bind def
/slc {setlinecap} bind def
/slj {setlinejoin} bind def
/slw {setlinewidth} bind def
/srgb {setrgbcolor} bind def
/rot {rotate} bind def
/sc {scale} bind def
/sd {setdash} bind def
/ff {findfont} bind def
/sf {setfont} bind def
/scf {scalefont} bind def
/sw {stringwidth} bind def
/tr {translate} bind def
/tnt {dup dup currentrgbcolor
  4 -2 roll dup 1 exch sub 3 -1 roll mul add
  4 -2 roll dup 1 exch sub 3 -1 roll mul add
  4 -2 roll dup 1 exch sub 3 -1 roll mul add srgb}
  bind def
/shd {dup dup currentrgbcolor 4 -2 roll mul 4 -2 roll mul
  4 -2 roll mul srgb} bind def
/reencdict 12 dict def /ReEncode { reencdict begin
/newcodesandnames exch def /newfontname exch def /basefontname exch def
/basefontdict basefontname findfont def /newfont basefontdict maxlength dict def
basefontdict { exch dup /FID ne { dup /Encoding eq
{ exch dup length array copy newfont 3 1 roll put }
{ exch newfont 3 1 roll put } ifelse } { pop pop } ifelse } forall
newfont /FontName newfontname put newcodesandnames aload pop
128 1 255 { newfont /Encoding get exch /.notdef put } for
newcodesandnames length 2 idiv { newfont /Encoding get 3 1 roll put } repeat
newfontname newfont definefont pop end } def
/isovec [
8#055 /minus 8#200 /grave 8#201 /acute 8#202 /circumflex 8#203 /tilde
8#204 /macron 8#205 /breve 8#206 /dotaccent 8#207 /dieresis
8#210 /ring 8#211 /cedilla 8#212 /hungarumlaut 8#213 /ogonek 8#214 /caron
8#220 /dotlessi 8#230 /oe 8#231 /OE
8#240 /space 8#241 /exclamdown 8#242 /cent 8#243 /sterling
8#244 /currency 8#245 /yen 8#246 /brokenbar 8#247 /section 8#250 /dieresis
8#251 /copyright 8#252 /ordfeminine 8#253 /guillemotleft 8#254 /logicalnot
8#255 /hyphen 8#256 /registered 8#257 /macron 8#260 /degree 8#261 /plusminus
8#262 /twosuperior 8#263 /threesuperior 8#264 /acute 8#265 /mu 8#266 /paragraph
8#267 /periodcentered 8#270 /cedilla 8#271 /onesuperior 8#272 /ordmasculine
8#273 /guillemotright 8#274 /onequarter 8#275 /onehalf
8#276 /threequarters 8#277 /questiondown 8#300 /Agrave 8#301 /Aacute
8#302 /Acircumflex 8#303 /Atilde 8#304 /Adieresis 8#305 /Aring
8#306 /AE 8#307 /Ccedilla 8#310 /Egrave 8#311 /Eacute
8#312 /Ecircumflex 8#313 /Edieresis 8#314 /Igrave 8#315 /Iacute
8#316 /Icircumflex 8#317 /Idieresis 8#320 /Eth 8#321 /Ntilde 8#322 /Ograve
8#323 /Oacute 8#324 /Ocircumflex 8#325 /Otilde 8#326 /Odieresis 8#327 /multiply
8#330 /Oslash 8#331 /Ugrave 8#332 /Uacute 8#333 /Ucircumflex
8#334 /Udieresis 8#335 /Yacute 8#336 /Thorn 8#337 /germandbls 8#340 /agrave
8#341 /aacute 8#342 /acircumflex 8#343 /atilde 8#344 /adieresis 8#345 /aring
8#346 /ae 8#347 /ccedilla 8#350 /egrave 8#351 /eacute
8#352 /ecircumflex 8#353 /edieresis 8#354 /igrave 8#355 /iacute
8#356 /icircumflex 8#357 /idieresis 8#360 /eth 8#361 /ntilde 8#362 /ograve
8#363 /oacute 8#364 /ocircumflex 8#365 /otilde 8#366 /odieresis 8#367 /divide
8#370 /oslash 8#371 /ugrave 8#372 /uacute 8#373 /ucircumflex
8#374 /udieresis 8#375 /yacute 8#376 /thorn 8#377 /ydieresis] def
/Times-Roman /Times-Roman-iso isovec ReEncode
 /DrawEllipse {
	/endangle exch def
	/startangle exch def
	/yrad exch def
	/xrad exch def
	/y exch def
	/x exch def
	/savematrix mtrx currentmatrix def
	x y tr xrad yrad sc 0 0 1 startangle endangle arc
	closepath
	savematrix setmatrix
	} def

/$F2psBegin {$F2psDict begin /$F2psEnteredState save def} def
/$F2psEnd {$F2psEnteredState restore end} def

$F2psBegin
10 setmiterlimit
0 slj 0 slc
 0.06000 0.06000 sc
%
% Fig objects follow
%
% 
% here starts figure with depth 50
% Ellipse
7.500 slw
n 6450 6375 3225 450 0 360 DrawEllipse gs col0 s gr

% Polyline
n 1875 3825 m 10650 3825 l 10650 6900 l 1875 6900 l
 cp gs col0 s gr 
% Polyline
n 4125 3825 m 5250 3825 l 5250 825 l 4125 825 l
 cp gs col0 s gr 
% Polyline
n 5925 3825 m 7050 3825 l 7050 825 l 5925 825 l
 cp gs col0 s gr 
% Polyline
 [60] 0 sd
n 7875 3825 m 9000 3825 l 9000 4950 l 7875 4950 l
 cp gs col0 s gr  [] 0 sd
% Polyline
gs  clippath
3124 728 m 3148 783 l 3287 723 l 3165 743 l 3263 668 l cp
eoclip
n 3675 525 m
 3150 750 l gs col0 s gr gr

% arrowhead
n 3263 668 m 3165 743 l 3287 723 l  col0 s
% Polyline
gs  clippath
4691 750 m 4745 776 l 4812 641 l 4732 735 l 4758 614 l cp
eoclip
n 4800 600 m
 4725 750 l gs col0 s gr gr

% arrowhead
n 4758 614 m 4732 735 l 4812 641 l  col0 s
% Polyline
gs  clippath
6459 707 m 6470 648 l 6321 621 l 6434 672 l 6310 680 l cp
eoclip
n 5625 525 m
 6450 675 l gs col0 s gr gr

% arrowhead
n 6310 680 m 6434 672 l 6321 621 l  col0 s
% Polyline
gs  clippath
2777 4541 m 2746 4592 l 2875 4672 l 2789 4584 l 2907 4620 l cp
eoclip
n 4500 5625 m
 2775 4575 l gs col0 s gr gr

% arrowhead
n 2907 4620 m 2789 4584 l 2875 4672 l  col0 s
% Polyline
gs  clippath
4823 4401 m 4766 4420 l 4814 4564 l 4805 4441 l 4871 4545 l cp
eoclip
n 5175 5550 m
 4800 4425 l gs col0 s gr gr

% arrowhead
n 4871 4545 m 4805 4441 l 4814 4564 l  col0 s
% Polyline
gs  clippath
6633 4500 m 6579 4473 l 6512 4608 l 6593 4515 l 6566 4635 l cp
eoclip
n 6075 5550 m
 6600 4500 l gs col0 s gr gr

% arrowhead
n 6566 4635 m 6593 4515 l 6512 4608 l  col0 s
% Polyline
n 2250 3825 m 3375 3825 l 3375 825 l 2250 825 l
 cp gs col0 s gr 
% Polyline
 [60] 0 sd
n 2250 4125 m 3375 4125 l 3375 5250 l 2250 5250 l
 cp gs col0 s gr  [] 0 sd
% Polyline
 [60] 0 sd
n 4125 3900 m 5250 3900 l 5250 5025 l 4125 5025 l
 cp gs col0 s gr  [] 0 sd
% Polyline
 [60] 0 sd
n 5925 4425 m 7050 4425 l 7050 5550 l 5925 5550 l
 cp gs col0 s gr  [] 0 sd
% Polyline
gs  clippath
8327 4391 m 8296 4443 l 8427 4519 l 8339 4433 l 8457 4467 l cp
eoclip
n 9750 5250 m
 8325 4425 l gs col0 s gr gr

% arrowhead
n 8457 4467 m 8339 4433 l 8427 4519 l  col0 s
/Times-Roman-iso ff 200.00 scf sf
900 900 m
gs 1 -1 sc (0x0000 0000) col0 sh gr
/Times-Roman-iso ff 200.00 scf sf
900 3675 m
gs 1 -1 sc (0xBFFF FFFF) col0 sh gr
/Times-Roman-iso ff 200.00 scf sf
600 3975 m
gs 1 -1 sc (0xC000 0000) col0 sh gr
/Times-Roman-iso ff 200.00 scf sf
600 6825 m
gs 1 -1 sc (0xFFFF FFFF) col0 sh gr
/Times-Roman-iso ff 200.00 scf sf
3825 525 m
gs 1 -1 sc (user-level processes) col0 sh gr
/Times-Roman-iso ff 200.00 scf sf
8325 5400 m
gs 1 -1 sc (kernel-only thread) col0 sh gr
/Times-Roman-iso ff 200.00 scf sf
4275 5850 m
gs 1 -1 sc (kernel-mode per-thread stacks) col0 sh gr
/Times-Roman-iso ff 200.00 scf sf
4500 6375 m
gs 1 -1 sc (shared kernel data structures) col0 sh gr
% here ends figure;
$F2psEnd
rs
showpage
%%EndDocument
end PEND/F2 13/Times-Bold@0 SF -.325(Ke)154.333 511.51 S -.195(rn).325 G
(el contr).195 E(ol \215o)-.234 E 3.25(wp)-.13 G(aths & pr)-3.25 E
(e-emption)-.234 E F1(No)33.336 547.51 Q 4.613(wt)-.325 G 1.363(hat we')
-4.613 F 1.753 -.195(ve s)-.65 H 1.362(een the types of k).195 F 1.362
(ernel entrypoints, lets continue further to talk about)-.13 F(ho)33.336
562.51 Q 3.25(wc)-.325 G(ontrol \215o)-3.25 E(ws within the k)-.325 E
(ernel and back out ag)-.13 E(ain.)-.065 E(At an)33.336 583.51 Q 3.25
(yg)-.195 G -2.795 -.325(iv e)-3.25 H 3.25(nm).325 G
(oment, a CPU is either:)-3.25 E 3.25<8345>33.336 598.51 S -.195(xe)
-3.25 G(cuting a user).195 E(-le)-.26 E -.195(ve)-.325 G 3.25(lt).195 G
(hread \(process\))-3.25 E 3.689<8345>33.336 613.51 S -.195(xe)-3.689 G
.439(cuting a k).195 F .439(ernel thread.)-.13 F .439
(This is identical to a user)6.939 F(-le)-.26 E -.195(ve)-.325 G 3.69
(lt).195 G .44(hread e)-3.69 F .44(xcept that the virtual)-.195 F
(address space is entirely within the k)33.336 628.51 Q(ernel.)-.13 E
3.25<8348>33.336 643.51 S(andling an e)-3.25 E(xception)-.195 E 3.25
<8348>33.336 658.51 S(andling an interrupt)-3.25 E 3.995<8354>33.336
673.51 S .744
(emporarily halted because there is nothing else to do at the moment.)
-4.905 F 2.824 -1.04(We c)7.244 H .744(all this the)1.04 F
("Idle" state.)33.336 688.51 Q .312(While handling an e)33.336 709.51 R
.312(xception or interrupt, it is possible that another e)-.195 F .312
(xception or interrupt)-.195 F .756(will arise.)33.336 724.51 R .756
(Thus the \215o)7.256 F 4.006(wo)-.325 G 4.006(fc)-4.006 G .756
(ontrol in the k)-4.006 F .755
(ernel is multiply re-entrant, and nested.)-.13 F(E.g.)7.255 E .321
(while handling a system call \(e)33.336 739.51 R .322(xception\), a k)
-.195 F -.195(ey)-.13 G .322(board interrupt is recei).195 F -.195(ve)
-.325 G 3.572(d. The).195 F -.195(ex)3.572 G(ception).195 E 0 Cg EP
%%Page: 9 9
%%BeginPageSetup
BP
%%EndPageSetup
/F0 9/Times-Roman@0 SF(ECE357:Computer Operating Systems)33.336 60 Q
(Unit 7/pg 9)73.998 E(\2512016 Jef)144.405 E 2.25(fH)-.225 G(akner)-2.25
E/F1 13/Times-Roman@0 SF 2.741(handler is suspened \(by hardw)33.336 120
R 2.741(are\) and the k)-.13 F -.195(ey)-.13 G 2.741
(board interrupt handler be).195 F 2.74(gins to run.)-.195 F 1.935
(While servicing that, a disk interrupt is recei)33.336 135 R -.195(ve)
-.325 G 5.185(da).195 G 1.935(nd handled.)-5.185 F 1.935
(When the disk handler)8.435 F 1.748(\214nishes, the k)33.336 150 R
-.195(ey)-.13 G 1.748
(board handler resumes and \214nishes, then the system call is allo).195
F 1.748(wed to)-.325 F(continue.)33.336 165 Q 2.269 -1.04(To s)33.336
186 T .189(implify k)1.04 F .189
(ernel programming and synchronization issues, the Linux k)-.13 F .189
(ernel is carefully)-.13 F 3.758(coded so that k)33.336 201 R 3.758
(ernel code ne)-.13 F -.195(ve)-.325 G 7.008(rp).195 G 3.758(roduces e)
-7.008 F 3.758(xceptions, with one ca)-.195 F -.195(ve)-.26 G 3.758
(at: During the).195 F .964(handling of a system call \(e)33.336 216 R
.965(xception\), a P)-.195 F .965(age F)-.195 F .965(ault \(e)-.195 F
.965(xception\) may be raised.)-.195 F .965(Thus we)7.465 F .96
(can say that e)33.336 231 R .96(xceptions will ne)-.195 F -.195(ve)
-.325 G 4.21(ra).195 G(rri)-4.21 E 1.35 -.195(ve d)-.325 H .96
(uring interrupt handling, and will ne).195 F -.195(ve)-.325 G 4.21(ra)
.195 G(rri)-4.21 E -.195(ve)-.325 G 1.742(during e)33.336 246 R 1.742
(xception handling other than a P)-.195 F 1.742(age F)-.195 F 1.742
(ault during a System Call.)-.195 F 1.742(An interrupt)8.242 F
(may occur at an)33.336 261 Q 3.25(yt)-.195 G
(ime, because it is asynchronous.)-3.25 E/F2 13/Times-Bold@0 SF(Pr)
33.336 282 Q(e-emption)-.234 E F1 .223(means a potentially non-v)3.473 F
.222(oluntary conte)-.26 F .222(xt switch between one thread \(task\))
-.195 F .121(to another)33.336 297 R 6.621(.P)-.715 G .121
(re-emption of a user)-6.621 F .121(-mode task by another user)-.26 F
.122(-mode task is straightforw)-.26 F(ard)-.13 E 3.495
(and generally happens as control is returning from the PIT \(T)33.336
312 R 3.494(imer/Clock\) interrupt)-.455 F .514
(handler back to userland.)33.336 327 R 3.764(Av)7.014 G .514
(oluntary conte)-4.024 F .514
(xt switch may also happen because a system)-.195 F
(call encounters a blocking condition and therefore e)33.336 342 Q
(xplicitly relinquishes the processor)-.195 E(.)-.715 E -.52(Wi)33.336
363 S 2.498(th re).52 F -.065(ga)-.195 G 2.498
(rd to pre-emption of a task which is already e).065 F -.195(xe)-.195 G
2.498(cuting in k).195 F 2.497(ernel code, this)-.13 F 2.75
(introduces comple)33.336 378 R 2.75(xity in the k)-.195 F(ernel')-.13 E
6(sc)-.715 G 2.75(oding, especially with re)-6 F -.065(ga)-.195 G 2.75
(rd to locking.).065 F(The)9.251 E 1.542(traditional def)33.336 393 R
1.542(ault con\214guration of Linux k)-.13 F 1.541
(ernel is such that pre-emption does not tak)-.13 F(e)-.13 E .884
(place in k)33.336 408 R .884(ernel code -- the pre-emption only occurs\
 as the task is about to return to user)-.13 F
(mode from a system call, f)33.336 423 Q(ault or interrupt.)-.13 E .182
(When k)33.336 444 R .181
(ernel pre-emption is enabled that changes the k)-.13 F .181
(ernel code and therefore this is not)-.13 F 3.526(am)33.336 459 S .276
(ode that can be toggled on the \215y or e)-3.526 F -.195(ve)-.325 G
3.526(ns).195 G .276(elected at system startup.)-3.526 F .276(The k)
6.776 F .277(ernel must)-.13 F(be compiled with pre-emption on or of)
33.336 474 Q 3.25(f. Here)-.325 F(is an e)3.25 E
(xample illustrating the dif)-.195 E(ference:)-.325 E 3.796<8343>33.336
489 S .546(ontrol has entered the k)-3.796 F .546(ernel synchronously)
-.13 F 3.796(,e)-.845 G .546(.g a system call or page f)-3.796 F .546
(ault, from task)-.13 F("A")33.336 504 Q 3.25<8357>33.336 519 S
(hile handling the system call or f)-3.25 E(ault, an interrupt is recei)
-.13 E -.195(ve)-.325 G(d).195 E 3.925<8354>33.336 534 S .675(he handli\
ng of the interrupt causes another task "B" with better scheduling prio\
rity to)-3.925 F(become READ)33.336 549 Q 3.25(Y\()-.715 G
(e.g. disk I/O has completed\).)-3.25 E 5.985<8357>33.336 564 S 2.735
(ith pre-emption OFF)-6.505 F 5.985(,t)-1.04 G 2.734
(he interrupt handler completes and control resumes in the)-5.985 F -.13
(ke)33.336 579 S 1.485(rnel code, handling the system call in the conte)
.13 F 1.486(xt of task "A".)-.195 F 1.486(Once the system call)7.986 F
1.17(\214nishes, upon return to user mode, pre-emption tak)33.336 594 R
1.17(es place \(see belo)-.13 F 4.42(wu)-.325 G 1.17(nder "Deferred)
-4.42 F(Return from System Call"\).)33.336 609 Q 4.085<8357>33.336 624 S
.836
(ith pre-emption ON, upon return from the interrupt handler to the k)
-4.605 F .836(ernel system call)-.13 F(handler)33.336 639 Q 5.81(,t)-.52
G 2.56(he NEED_RESCHED \215ag \(see belo)-5.81 F 5.81(wu)-.325 G 2.559
(nder "Deferred Return from System)-5.81 F .639
(call"\) is noticed and a conte)33.336 654 R .639(xt switch tak)-.195 F
.64(es place.)-.13 F(Ex)7.14 E .64(ecution of task "A" is suspended in)
-.195 F .137(the k)33.336 669 R .137(ernel at the point in the system c\
all handler where the interrupt happened to arri)-.13 F .526 -.195
(ve \()-.325 H(it).195 E .627(could be an)33.336 684 R 3.877(ya)-.195 G
.627(rbitrary point\).)-3.877 F -1.04(Ta)7.127 G .627
(sk "B" gets the CPU.)1.04 F .628(At some later time, task "A" gets)
7.127 F(the CPU ag)33.336 699 Q(ain, and the system call resumes.)-.065
E .69(The adv)33.336 720 R .69(antage of full k)-.325 F .69
(ernel pre-emption is latenc)-.13 F .69(y: a high priority task which w)
-.195 F(ak)-.13 E .689(es up)-.13 F .212(need not w)33.336 735 R .213
(ait for the system call to complete before it gets the CPU.)-.13 F .213
(The disadv)6.713 F .213(antage is)-.325 F 0 Cg EP
%%Page: 10 10
%%BeginPageSetup
BP
%%EndPageSetup
/F0 9/Times-Roman@0 SF(ECE357:Computer Operating Systems)33.336 60 Q
(Unit 7/pg 10)71.748 E(\2512016 Jef)142.155 E 2.25(fH)-.225 G(akner)
-2.25 E/F1 13/Times-Roman@0 SF 1.499(the added code comple)33.336 120 R
1.498(xity and locking, which can also introduce a slight performance)
-.195 F 1.149(penalty because it b)33.336 135 R 1.149(urns up CPU c)-.26
F 4.399(ycles. A)-.195 F 1.149(compromise between these tw)4.399 F 4.399
(oe)-.13 G 1.149(xtremes is)-4.594 F("v)33.336 150 Q 1.868
(oluntary pre-emption" where the k)-.26 F 1.867
(ernel is coded with speci\214c pre-emption points in)-.13 F .635
(system calls or f)33.336 165 R .635(ault handlers where it might tak)
-.13 F 3.885(ea")-.13 G .636(long time" \(b)-3.885 F .636
(ut not inde\214nite\) to do)-.26 F 4.127(something. At)33.336 180 R
.877(these points the NEED_RESCHED \215ag is e)4.127 F .876
(xplicitly tested and a conte)-.195 F(xt)-.195 E(switch is v)33.336 195
Q(oluntarily made if needed.)-.26 E/F2 13/Times-Bold@0 SF
(Making a System Call)206.125 225 Q F1 3.618 -1.04(We a)33.336 261 T
1.538(re no)1.04 F 4.788(wr)-.325 G 1.539
(eady to discuss one particular k)-4.788 F 1.539
(ernel control path: the system call.)-.13 F -1.04(We)8.039 G -.13('l)
1.04 G(l).13 E .876(illustrate a f)33.336 276 R .876(airly simple one:)
-.13 F/F3 13/Courier@0 SF(getuid\(\))4.125 E F1 7.375(.A)C(user)-3.25 E
(-le)-.26 E -.195(ve)-.325 G 4.125(lp).195 G .875(rogram calls)-4.125 F
F3(getuid\(\))4.125 E F1 .875(as an)4.125 F .696(ordinary C function.)
33.336 291 R .696(This function is pro)7.196 F .697
(vided by the standard C library which is link)-.195 F(ed)-.13 E 1.168
(with all C programs.)33.336 306 R(The)7.667 E F3(getuid\(\))4.417 E F1
1.167(function is written partially in C and partially in)4.417 F 2.212
(assembly language.)33.336 321 R 2.212(This pro)8.712 F 2.212
(vides the "glue" between the user)-.195 F(-le)-.26 E -.195(ve)-.325 G
5.462(ld).195 G 2.213(omain of the C)-5.462 F(program, and the k)33.336
336 Q(ernel')-.13 E 3.25(ss)-.715 G(ystem call API.)-3.25 E F2
(The 32-bit X86 API)212.989 366 Q F1(Ar)33.336 402 Q .416
(gument passing between user)-.234 F(-le)-.26 E -.195(ve)-.325 G 3.666
(lf).195 G .416(unctions in C \(X86-32\) is via the stack.)-3.666 F(Ho)
6.916 E(we)-.325 E -.195(ve)-.325 G -.52(r,).195 G 1.895
(during a system call, the processor will be switching to a dif)33.336
417 R 1.896(ferent, k)-.325 F 1.896(ernel stack.)-.13 F(The)8.396 E
(user)33.336 432 Q(-le)-.26 E -.195(ve)-.325 G 3.93(lp).195 G .68
(rogram ob)-3.93 F .679(viously can not write to the k)-.195 F .679
(ernel stack.)-.13 F(Con)7.179 E -.195(ve)-.52 G(rsely).195 E 3.929(,a)
-.845 G .679(lthough the)-3.929 F -.13(ke)33.336 447 S(rnel).13 E/F4 13
/Times-Italic@0 SF(can)3.392 E F1 .142(access the user)3.392 F(-le)-.26
E -.195(ve)-.325 G 3.392(ls).195 G .142(tack memory)-3.392 F 3.392(,i)
-.845 G 3.392(tw)-3.392 G .142(ould rather not, since that might create)
-3.522 F 6.87(aP)33.336 462 S 3.62(age F)-7.065 F 6.87(ault. The)-.195 F
3.62(solution is to pass ar)6.87 F 3.619(guments to system calls in re)
-.234 F 6.869(gisters. The)-.195 F(con)33.336 477 Q -.195(ve)-.52 G
1.107(ntion used on the x86-32 architecture is that the 32-bit ar).195 F
1.107(guments are passed such)-.234 F 1.202(that the \214rst ar)33.336
492 R 1.202(gument is in the)-.234 F F3(ebx)4.452 E F1(re)4.452 E
(gister)-.195 E 7.702(.T)-.715 G 1.201(he second is placed in the)-7.702
F F3(ecx)4.451 E F1(re)4.451 E(gister)-.195 E(.)-.715 E .325
(The third through sixth are placed in re)33.336 507 R(gisters)-.195 E
F3 .325(edx, esi, edi, ebp)3.575 F F1(respecti)3.575 E -.195(ve)-.325 G
(ly).195 E 6.825(.I)-.845 G(f)-6.825 E .207(the number of ar)33.336 522
R .207(guments to the system call e)-.234 F .206
(xceeds 6 \(rare\), then all of the ar)-.195 F .206(guments are)-.234 F
1.468(placed on the user)33.336 537 R(-le)-.26 E -.195(ve)-.325 G 4.718
(ls).195 G 1.468(tack and the k)-4.718 F 1.468(ernel recei)-.13 F -.195
(ve)-.325 G 4.718(sj).195 G 1.468(ust the address of that ar)-4.718 F
(gument)-.234 E(block.)33.336 552 Q 1.074(Each a)33.336 573 R -.325(va)
-.26 G 1.074
(ilable system call is assigned a speci\214c number by the k).325 F
4.323(ernel. A)-.13 F(gi)4.323 E -.195(ve)-.325 G 4.323(ns).195 G(ystem)
-4.323 E 1.68(call number also has a speci\214cation for what ar)33.336
588 R 1.68(guments are e)-.234 F 4.93(xpected. The)-.195 F 1.68
(standard C)4.93 F 3.42
(library must therefore be compiled, at least in part, with an e)33.336
603 R 3.42(ye to)-.195 F -.13(wa)-.325 G 3.42(rds the e).13 F(xact)-.195
E 2.14(architecture on which the program will be run.)33.336 618 R 2.14
(As the k)8.64 F 2.14(ernel e)-.13 F -.26(vo)-.325 G(lv).26 E 2.14
(es to)-.195 F -.13(wa)-.325 G 2.14(rds higher).13 F -.195(ve)33.336 633
S 2.132(rsion numbers and ne).195 F 5.382(ws)-.325 G 2.132
(ystem calls are added, backw)-5.382 F 2.132
(ards-compatability with older)-.13 F 2.275(code must be maintained.)
33.336 648 R 2.275(System call numbers are not re-used.)8.775 F 2.275
(If it is necessary to)8.775 F .818
(change the semantics of a system call, a ne)33.336 663 R 4.067(wc)-.325
G .817(all is de\214ned with a ne)-4.067 F 4.067(wn)-.325 G(umber)-4.067
E 4.067(,a)-.52 G .817(nd the)-4.067 F -.13(ke)33.336 678 S .238
(rnel pro).13 F .238(vides both v)-.195 F 3.488(ersions. In)-.195 F .238
(the Linux 2.6.15 v)3.488 F .238(ersion k)-.195 F .238
(ernel, there were 294 de\214ned)-.13 F 1.169(system call numbers, by v)
33.336 693 R 1.168(ersion 2.6.23 that number had gro)-.195 F 1.168
(wn to 325, and by 2.6.32 it)-.325 F(had reached 338!)33.336 708 Q 1.164
(The system call number is passed to the k)33.336 729 R 1.164
(ernel in the)-.13 F F3(eax)4.414 E F1(re)4.414 E(gister)-.195 E 7.664
(.N)-.715 G 1.814 -.325(ow t)-7.664 H 1.164(he user).325 F(-le)-.26 E
-.195(ve)-.325 G(l).195 E F3(getuid)33.336 744 Q F1 1.074
(function is ready to actually mak)4.324 F 4.323(et)-.13 G 1.073
(he system call.)-4.323 F 1.073(There are no ar)7.573 F 1.073
(guments to)-.234 F 0 Cg EP
%%Page: 11 11
%%BeginPageSetup
BP
%%EndPageSetup
/F0 9/Times-Roman@0 SF(ECE357:Computer Operating Systems)33.336 60 Q
(Unit 7/pg 11)71.748 E(\2512016 Jef)142.155 E 2.25(fH)-.225 G(akner)
-2.25 E/F1 13/Times-Roman@0 SF .854(this particular system call, so the\
 system call # corresponding to getuid \(199 decimal\) is)33.336 120 R
1.069(put in eax and then a special instruction is used.)33.336 135 R
1.068(There are tw)7.568 F 4.318(ow)-.13 G 1.068(ays to mak)-4.448 F
4.318(eas)-.13 G(ystem)-4.318 E 4.123(call: using the)33.336 150 R/F2 13
/Courier@0 SF 4.123(INT $0x80)7.373 F F1(softw)7.373 E 4.123
(are interrupt e)-.13 F 4.124(xception instruction, or using the)-.195 F
F2(SYSENTER)33.336 165 Q F1 4.278(instruction. W)4.279 F(e')-1.04 E
1.028(ll follo)-.13 F 4.278(wt)-.325 G 1.028(he former e)-4.278 F 4.278
(xample. The)-.195 F 1.028(reader is referred to the)4.278 F(book)33.336
180 Q/F3 13/Times-Italic@0 SF(Under)3.25 E(standing the Linux K)-.13 E
(ernel)-.455 E F1(for more information on the SYSENTER method.)3.25 E
(The)33.336 216 Q F2 .255(INT $0x80)3.505 F F1 .255
(instruction causes an e)3.505 F .255(xception to be raised with v)-.195
F .256(ector code 128.)-.195 F(The)6.756 E(hardw)33.336 231 Q .108
(are then v)-.13 F .108(ectors to the k)-.195 F .107
(ernel entrypoint in the IDT for v)-.13 F .107(ector 128, which the k)
-.195 F(ernel)-.13 E 8.57(had pre)33.336 246 R 8.571
(viously initialized to point to the \(symbolic\) k)-.325 F 8.571
(ernel virtual address)-.13 F F2(system_call)33.336 261 Q F1 26.267(.T)C
19.767(he code belo)-26.267 F 23.017(wi)-.325 G 23.016(sas)-23.017 G
19.766(impli\214ed v)-23.016 F 19.766(ersion of)-.195 F
(/usr/src/linux/arch/x86/k)33.336 276 Q(ernel/entry)-.13 E(.S:)-.845 E 0
Cg EP
%%Page: 12 12
%%BeginPageSetup
BP
%%EndPageSetup
/F0 9/Times-Roman@0 SF(ECE357:Computer Operating Systems)33.336 60 Q
(Unit 7/pg 12)71.748 E(\2512016 Jef)142.155 E 2.25(fH)-.225 G(akner)
-2.25 E/F1 10/Courier@0 SF(system_call:)33.336 117 Q 21.6(pushl %eax)
90.936 129 R(#contains system call #)148.8 E 176.4(SAVE_ALL #macro)
90.936 141 R(to push important)6 E(#registers on the stack)321.336 153 Q
27.6(movl $0xFFFFE000,%ebp)90.936 165 R(#mask SP to get to)76.8 E 27.6
(andl %esp,%ebp)90.936 177 R(#thread_info)118.8 E 21.6
(testw $_TIF_SYSCALL_TRACE,TI_FLAGS\(%ebp\))90.936 189 R
(#test thread_info.flags)26.4 E 33.6(jnz syscall_trace_entry)90.936 201
R(#for syscall tracing on)58.8 E 27.6(cmpl $nr_syscalls,)90.936 213 R
58.8(%eax #bounds)6 F(check)6 E 33.6(jae syscall_badsys)90.936 225 R
27.6(call *sys_call_table\(0,%eax,4\))90.936 237 R(#indirect addressing)
22.8 E 27.6(movl %eax,PT_EAX\(%esp\))90.936 249 R
(#poke return code into EAX slot)70.8 E(syscall_exit:)33.336 261 Q 206.4
(cli #temporarily)90.936 273 R(mask interrupts)6 E 27.6
(movl TI_flags\(%ebp\),%ecx)90.936 285 R
(#get flags field of thread_info)58.8 E(#ALLWORK_MASK includes all TIF_\
XXX thread info flags that indicate more)39.336 297 Q
(#work might be needed before returning to user space)39.336 309 Q 21.6
(testw $_TIF_ALLWORK_MASK,%cx)90.936 321 R(#see if any flags are set)
40.8 E 33.6(jne syscall_exit_work)90.936 333 R
(#if so more work before exit)70.8 E(restore_all:)33.336 345 Q 152.4
(RESTORE_REGS #pop)90.936 357 R(registers from stack)6 E 27.6
(addl $4,%esp)90.936 369 R(#discard original eax)130.8 E 200.4
(iret #return)90.936 381 R(from interrupt)6 E(syscall_badsys:)33.336 393
Q 27.6(movl $-ENOSYS,PT_EAX\(%esp\))90.936 405 R
(#poke error return code)46.8 E 33.6(jmp syscall_exit)90.936 417 R
(#simplified)100.8 E 174(syscall_exit_work: #simplified)33.336 429 R 12
(testb $_TIF_NEED_RESCHED,%cl)90.936 441 R(#flags already in ecx)50.4 E
39.6(jz work_notifysig)90.936 453 R(#if clear, must be signal pending)
88.8 E(work_resched:)33.336 465 Q 27.6(call schedule)90.936 477 R
(#otherwise, task switch)124.8 E 206.4(cli #avoid)90.936 489 R
(missing an interrupt)6 E 27.6(movl TI_flags\(%ebp\),%ecx)90.936 501 R
(#check flags again)58.8 E 27.6(andl $_TIF_WORK_MASK,%ecx)90.936 513 R
39.6(jz restore_all)90.936 525 R(#OK to return to userland)106.8 E 21.6
(testb $_TIF_NEED_RESCHED,%cl)90.936 537 R 33.6(jnz work_resched)90.936
549 R(#still need rescheduling)100.8 E(work_notifysig:)33.336 561 Q
(#we won't be covering this code in depth)90.936 573 Q 0 Cg EP
%%Page: 13 13
%%BeginPageSetup
BP
%%EndPageSetup
/F0 9/Times-Roman@0 SF(ECE357:Computer Operating Systems)33.336 60 Q
(Unit 7/pg 13)71.748 E(\2512016 Jef)142.155 E 2.25(fH)-.225 G(akner)
-2.25 E/F1 13/Times-Roman@0 SF(The)33.336 120 Q/F2 13/Courier@0 SF
(SAVE_ALL)3.818 E F1 .568(macros pushes all of the re)3.818 F .569
(gisters that the k)-.195 F .569(ernel is lik)-.13 F .569
(ely to clobber)-.13 F 7.069(.I)-.715 G(n)-7.069 E .95
(conjunction with the hardw)33.336 135 R .95
(are pushes and the instruction)-.13 F F2 .95(pushl %eax)4.2 F F1 .95
(just abo)4.2 F -.195(ve)-.195 G 4.2(,t).195 G(he)-4.2 E -.13(ke)33.336
150 S(rnel stack no).13 E 3.25(wl)-.325 G(ooks lik)-3.25 E 3.25(et)-.13
G(his:)-3.25 E/F3 10/Courier@0 SF(0x00\(%esp\) - ebx)33.336 162 Q
(general-purpose registers,)76.8 E(0x04\(%esp\) - ecx)33.336 174 Q
(saved by)76.8 E(0x08\(%esp\) - edx)33.336 186 Q(SAVE_ALL)76.8 E
(0x0C\(%esp\) - esi)33.336 198 Q(")76.8 E(0x10\(%esp\) - edi)33.336 210
Q(")76.8 E(0x14\(%esp\) - ebp)33.336 222 Q(")76.8 E(0x18\(%esp\) - eax)
33.336 234 Q 6("\()76.8 G(will be syscall return value\))-6 E
(0x1C\(%esp\) - ds)33.336 246 Q(")140.4 E(0x20\(%esp\) - es)33.336 258 Q
(")140.4 E(0x24\(%esp\) - fs)33.336 270 Q(")140.4 E
(0x28\(%esp\) - orig_eax)33.336 282 Q
(orig system_call number \(used for syscall restart\))46.8 E
(0x2C\(%esp\) - eip)33.336 294 Q
(program counter in user land, saved by hw)76.8 E(0x30\(%esp\) - cs)
33.336 306 Q(code segment register, saved by hw)82.8 E
(0x34\(%esp\) - eflags)33.336 318 Q(flags register, saved by hw)58.8 E
(0x38\(%esp\) - oldesp)33.336 330 Q
(user-land stack pointer, saved by hw)58.8 E(0x3C\(%esp\) - oldss)33.336
342 Q(user-land stack segment reg, saved by hw)64.8 E F1 1.189(The ne)
33.336 363 R 1.19(xt instruction places a mask into re)-.195 F(gister)
-.195 E F2(ebp)4.44 E F1 1.19(and applies that mask to the stack)4.44 F
(pointer)33.336 378 Q F2(esp)3.838 E F1 7.088(.N)C(ormally)-7.088 E
3.838(,i)-.845 G 3.838(nCp)-3.838 G .588(rograms, the ebp re)-3.838 F
.588(gister has a v)-.195 F .587(ery important function as)-.195 F 1.417
(the local frame pointer)33.336 393 R 7.917(.H)-.715 G -.325(ow)-7.917 G
-2.795 -.325(ev e).325 H 2.457 -.52(r, w).325 H 4.667(ea).52 G 1.417
(re still in an assembly language entrypoint, and)-4.667 F .025
(thus ebp is a)33.336 408 R -.325(va)-.26 G .024(ilable as a scratch re)
.325 F(gister)-.195 E 6.524(.T)-.715 G .024
(he purpose of this masking operation deserv)-6.524 F(es)-.195 E 3.25
(ac)33.336 423 S(onsiderable detour:)-3.25 E/F4 13/Times-Bold@0 SF -.325
(Ke)131.687 453 S -.195(rn).325 G(el-mode stack and the thr).195 E
(ead_inf)-.234 E 3.25(os)-.325 G(tructur)-3.25 E(e)-.234 E F1 2.577
(Recall that the k)33.336 489 R 2.577(ernel allocates an indi)-.13 F
2.577(vidual stack area for each user)-.325 F(-le)-.26 E -.195(ve)-.325
G 5.827(lt).195 G 2.577(hread of)-5.827 F 4.217(control. Depending)
33.336 504 R .967(on k)4.217 F .967(ernel v)-.13 F .966
(ersion and compilation parameters, the size of this stack)-.195 F .767
(may be 4K or 8K.)33.336 519 R -.195(Fo)7.268 G 4.018(rs).195 G
(implicity)-4.018 E 4.018(,w)-.845 G 4.018(ew)-4.018 G .768
(ill assume an 8K stack.)-4.018 F .768(While this seems rather)7.268 F
1.943(small, bear in mind that e)33.336 534 R -.195(ve)-.325 G 1.942
(ry bit of code in the k).195 F 1.942(ernel is carefully controlled.)
-.13 F(Lar)8.442 E(ge)-.234 E 1.612(amounts of local v)33.336 549 R
1.612(ariable space are discouraged, recursi)-.325 F 2.002 -.195(ve p)
-.325 H 1.612(rogramming is ne).195 F -.195(ve)-.325 G 4.862(ru).195 G
(sed,)-4.862 E 3.358
(and the depth of function call nesting rarely gets obnoxious.)33.336
564 R 3.358(Therefore, the k)9.858 F(ernel)-.13 E
(programmers can rely on the f)33.336 579 Q
(act that this 8K stack will not o)-.13 E -.195(ve)-.195 G(r\215o).195 E
-.845(w.)-.325 G(No)33.336 600 Q 2.853 -.845(w, t)-.325 H 4.413(oc).845
G 1.163(ompound this trick)-4.413 F(ery)-.13 E 4.413(,t)-.845 G 1.163
(he k)-4.413 F 1.163(ernel sticks a small data structure called)-.13 F
F2(struct)4.413 E(thread_info)33.336 615 Q F1 1.001
(at the limit of the stack, i.e. at the lo)4.251 F 1.001
(west memory address.)-.325 F 1.001(The k)7.501 F(ernel)-.13 E .762
(stack pointer v)33.336 630 R .762
(alue stored in the TSS memory area by the k)-.325 F .763
(ernel for each process/thread)-.13 F 2.398
(is the highest address of the allocated stack area.)33.336 645 R 2.398
(On entry to the k)8.898 F 2.398(ernel through an)-.13 F -.195(ex)33.336
660 S 2.419(ception or interrupt, the k).195 F 2.419
(ernel stack is empty)-.13 F 5.669(,a)-.845 G 2.419(nd the k)-5.669 F
2.419(ernel stack pointer is thus)-.13 F .119(furthest a)33.336 675 R
-.13(wa)-.195 G 3.368(yf).13 G .118(rom this)-3.368 F F2(thread_info)
3.368 E F1 .118(data structure, and as k)3.368 F .118
(ernel functions are called,)-.13 F
(the stack pointer gets closer to it, b)33.336 690 Q(ut should ne)-.26 E
-.195(ve)-.325 G 3.25(rb).195 G 3.25(ei)-3.25 G 3.25(na)-3.25 G .39
-.195(ny d)-3.25 H(anger of o).195 E -.195(ve)-.195 G -.26(r-).195 G
(writing it.).26 E 3.016
(This arrangement of memory addresses means that on entry to the k)
33.336 711 R 3.016(ernel, a simple)-.13 F 8.379
(masking operation of the stack pointer)33.336 726 R F2(%esp)11.629 E F1
8.379(yields the be)11.629 F 8.379(ginning of the)-.195 F F2
(thread__info)33.336 741 Q F1 3.735(structure. That)3.735 F .485
(address is k)3.735 F .485(ept in the)-.13 F F2(%ebp)3.735 E F1(re)3.735
E .485(gister for a while.)-.195 F(Also,)6.985 E 0 Cg EP
%%Page: 14 14
%%BeginPageSetup
BP
%%EndPageSetup
/F0 9/Times-Roman@0 SF(ECE357:Computer Operating Systems)33.336 60 Q
(Unit 7/pg 14)71.748 E(\2512016 Jef)142.155 E 2.25(fH)-.225 G(akner)
-2.25 E/F1 13/Times-Roman@0 SF 1.965(at an)33.336 120 R 5.215(yp)-.195 G
1.964(oint in the k)-5.215 F 1.964(ernel, the inline function)-.13 F/F2
13/Courier@0 SF(current_thread_info\(\))5.214 E F1(performs)5.214 E
10.329(that same masking operation.)33.336 135 R(Let')16.829 E 13.579
(sl)-.715 G 10.329(ook into the)-13.579 F F2(thread_info)13.58 E F1
(struct)13.58 E(\(/usr/src/linux/arch/x86/include/asm/thread_info.h\):)
33.336 150 Q/F3 10/Courier@0 SF(struct thread_info {)33.336 162 Q
(struct task_struct)81.336 174 Q 54(*task; /*)36 F
(main task structure */)6 E(struct exec_domain)81.336 186 Q 12
(*exec_domain; /*)36 F(execution domain */)6 E(unsigned long)81.336 198
Q 54(flags; /*)66 F(low level flags */)6 E(unsigned long)81.336 210 Q 48
(status; /*)66 F(thread-synchronous flags */)6 E 108(__u32 cpu;)81.336
222 R(/* current CPU */)72 E 120(int preempt_count;)81.336 234 R
(/* 0 => preemptable */)12 E 66(mm_segment_t addr_limit;)81.336 246 R
(/* highest valid VA */)30 E 142.8(void *sysenter_return;)90.936 258 R
(/* don't worry */)13.2 E(struct restart_block)81.336 270 Q 6
(restart_block; /*)24 F(for syscall restart */)6 E(#ifdef CONFIG_X86_32)
39.336 282 Q(/* Don't worry about these next two obscure lines */)46.8 E
(unsigned long)81.336 294 Q(previous_esp;)66 E 114
(__u8 supervisor_stack[0];)81.336 306 R(#endif)39.336 318 Q 148.8
(int uaccess_err;)90.936 330 R(/* err from accessing user mem*/)43.2 E
(};)33.336 342 Q F1 .994(There isn')33.336 363 R 4.244(tm)-.234 G .994
(uch room on the k)-4.244 F .994(ernel stack, so)-.13 F F2(thread_info)
4.243 E F1 .993(is pretty small.)4.243 F .993(What is)7.493 F -.13(ke)
33.336 378 S 1.369
(pt in there is only what is needed by the assembly language entry/e).13
F 1.369(xit routines.)-.195 F(The)7.869 E -.13(ke)33.336 393 S .89
(rnel needs to k).13 F .89(eep a lot more information about a process, \
so it allocates another data)-.13 F .384(structure called)33.336 408 R
F2 .385(struct task_struct)3.634 F F1 .385(which is pointed to by)3.635
F F2(thread_info)3.635 E F1 6.885(.T)C(his)-6.885 E
(is an unfortunate and confusing choice of names!)33.336 423 Q 1.267
(Inside k)33.336 444 R 1.267(ernel code, we can al)-.13 F -.13(wa)-.13 G
1.267(ys go from the k).13 F 1.266(ernel stack to the)-.13 F F2
(task_struct)4.516 E F1(and)4.516 E(vice-v)33.336 459 Q .97
(ersa because there are mutual pointers between them.)-.195 F .97
(In addition, there is a "per)7.47 F(-)-.26 E 3.351(CPU pri)33.336 474 R
-.325(va)-.325 G 3.351(te memory area" in k).325 F 3.351
(ernel global memory and the)-.13 F F2(current)6.6 E F1 -.325(va)6.6 G
3.35(riable is).325 F .546
(actually a macro which accesses the pointer to the)33.336 489 R F2
(task_struct)3.796 E F1 .546(for the task currently)3.796 F
(running on "our" CPU.)33.336 504 Q/F4 13/Times-Bold@0 SF(No)131.98 564
Q 1.43 -.715(w, b)-.13 H(ack to our system call, alr).715 E(eady in pr)
-.234 E(ogr)-.234 E(ess)-.234 E F1(Ha)33.336 600 Q 2.723
(ving computed the address of the thread_info structure, the ne)-.26 F
2.722(xt line of assembly)-.195 F -.195(ex)33.336 615 S 3.162
(amines a bitwise \215ags w).195 F 6.412(ord. There)-.13 F 3.162
(are quite a fe)6.412 F(w)-.325 E F2(TIF_XXX)6.412 E F1 3.162
(\215ags de\214ned.)6.412 F(Of)9.662 E .618
(interest here is a tracing hook: if the)33.336 630 R F2
(TIF_SYSCALL_TRACE)3.867 E F1 .617(\215ag is set, then the thread)3.867
F 2.321(making the system call is being traced \(e.g. through the)33.336
645 R F2(strace)5.571 E F1 2.321(command\) and the)5.571 F -.13(ke)
33.336 660 S 1.55(rnel di).13 F -.195(ve)-.325 G 1.55(rts to an alterna\
te entry which will record the parameters of the system call).195 F
(and pass them back as an e)33.336 675 Q -.195(ve)-.325 G
(nt to the tracer).195 E 6.5(.W)-.715 G 3.25(ew)-7.54 G(on')-3.38 E 3.25
(tg)-.234 G 3.25(od)-3.25 G -.325(ow)-3.25 G 3.25(nt).325 G
(hat road, ho)-3.25 E(we)-.325 E -.195(ve)-.325 G -.715(r.).195 G 1.187
(The ne)33.336 696 R 1.187(xt tw)-.195 F 4.437(ol)-.13 G 1.187
(ines are v)-4.437 F 1.188(ery important, as the)-.195 F 4.438(yi)-.195
G 1.188(llustrate data v)-4.438 F 4.438(alidation. Recall)-.325 F 1.188
(that the)4.438 F(user)33.336 711 Q(-le)-.26 E -.195(ve)-.325 G 3.59(lp)
.195 G .34(rocess is completely untrusted as f)-3.59 F .34(ar as the k)
-.13 F .34(ernel is concerned.)-.13 F .339(If the system)6.84 F 3.462(c\
all number passed by the user is greater than the highest system call n\
umber \(or)33.336 726 R(ne)33.336 741 Q -.065(ga)-.195 G(ti).065 E -.195
(ve)-.325 G 1.533(...think about tw).195 F(o')-.13 E 4.783(sc)-.715 G
1.533(omplement\) then the)-4.783 F F2(syscall_badsys)4.782 E F1 1.532
(code is jumped)4.782 F 0 Cg EP
%%Page: 15 15
%%BeginPageSetup
BP
%%EndPageSetup
/F0 9/Times-Roman@0 SF(ECE357:Computer Operating Systems)33.336 60 Q
(Unit 7/pg 15)71.748 E(\2512016 Jef)142.155 E 2.25(fH)-.225 G(akner)
-2.25 E/F1 13/Times-Roman@0 SF 3.873(to. This)33.336 120 R .623
(places an error code into the slot in the stack where the user')3.873 F
(s)-.715 E/F2 13/Courier@0 SF(eax)3.874 E F1(re)3.874 E .624(gister w)
-.195 F(as)-.13 E(sa)33.336 135 Q -.195(ve)-.26 G 3.25(d. Upon).195 F
-.195(ex)3.25 G(it from the system call handler).195 E 3.25(,t)-.52 G
(his v)-3.25 E(alue will be popped into %eax.)-.325 E/F3 13/Times-Bold@0
SF(System Call Retur)195.634 150 Q 3.25(nV)-.195 G(alue)-4.446 E F1
1.043(On the X86 architecture, when a function returns an int \(or othe\
r 32-bit v)33.336 186 R 1.042(alue such as a)-.325 F .75
(pointer\), that v)33.336 201 R .75(alue is returned in the)-.325 F F2
(eax)4 E F1(re)4 E(gister)-.195 E 7.25(.A)-.715 G .75(ll return v)-7.25
F .751(alues from k)-.325 F .751(ernel system)-.13 F 1.415
(calls are in f)33.336 216 R 1.415(act signed inte)-.13 F 4.665(gers. A)
-.195 F(ne)4.665 E -.065(ga)-.195 G(ti).065 E 1.805 -.195(ve v)-.325 H
1.414(alue is used to indicate an error)-.13 F 4.664(,a)-.52 G 1.414
(nd that)-4.664 F -.325(va)33.336 231 S(lue is -error_number).325 E(.)
-.715 E 1.306(Therefore, an in)33.336 252 R -.325(va)-.52 G 1.306
(lid system call will return the v).325 F 1.306
(alue -ENOSYS via the %eax re)-.325 F(gister)-.195 E(.)-.715 E(No)33.336
267 Q 3.224 -.845(w, a)-.325 H 4.784(nu).845 G 1.534
(nfortunate history lesson crops up.)-4.784 F 1.534
(The UNIX API, for reasons that may be)8.034 F 2.369
(lost to time, speci\214es that when system calls f)33.336 282 R 2.37
(ail, the)-.13 F 5.62(ys)-.195 G 2.37(hould set the global v)-5.62 F
(ariable)-.325 E(errno, and return -1.)33.336 297 Q(So the user)6.5 E
(-le)-.26 E -.195(ve)-.325 G 3.25(lg).195 G
(lue function does this \(pseudocode\):)-3.25 E/F4 10/Courier@0 SF
(int generic_system_call\(arguments...\))33.336 309 Q({)33.336 321 Q
(put arguments into registers)90.936 333 Q(put system call # into %eax)
90.936 345 Q(INT $0x80)90.936 357 Q(if \(%eax<0\))90.936 369 Q({)90.936
381 Q(errno= -%eax;)148.536 393 Q(return -1;)148.536 405 Q(})90.936 417
Q(return %eax;)90.936 429 Q(})33.336 441 Q F3 -.325(Ke)177.87 471 S
-.195(rn).325 G(el system call hand-off to C).195 E F1(Ho)33.336 507 Q
(we)-.325 E -.195(ve)-.325 G 1.658 -.52(r, w).195 H 3.868(ek).52 G(no)
-3.868 E 3.868(wi)-.325 G 3.868(nt)-3.868 G .618(his case that a v)
-3.868 F .617(alid system call number w)-.325 F .617(as used.)-.13 F
2.697 -1.04(We h)7.117 H -2.925 -.26(av e)1.04 H(been)4.127 E 3.926
(tracing out assembly language code, b)33.336 522 R 3.926
(ut most of the k)-.26 F 3.926(ernel is written in C.)-.13 F(The)10.426
E(instruction)33.336 537 Q F4 18(call *sys_call_table\(0,%eax,4\))90.936
549 R F1 2.759(uses the X86 inde)33.336 564 R -.195(xe)-.195 G 6.008(dr)
.195 G -.195(eg)-6.008 G 2.758(ister of).195 F 2.758
(fset indirect addressing mode as follo)-.325 F 2.758(ws: The %eax)-.325
F(re)33.336 579 Q 1.461(gister \(containing the system call #\) is mult\
ipled by 4 \(the sizeof a pointer\), and that)-.195 F(of)33.336 594 Q
1.408(fset is added to the base address of a table of function pointers)
-.325 F F2(sys_call_table)4.658 E F1(.)A .137
(The result of that addition is used to fetch 4 bytes from memory)33.336
609 R 3.388(,a)-.845 G .138(nd _that_ address is the)-3.388 F
(one which is called as a subroutine.)33.336 624 Q(It is)6.5 E/F5 13
/Times-Italic@0 SF(as if)3.25 E F1(:)A F4
(/* Declare and initialize array of function pointers */)45.336 636 Q
(/* The system call names and positions are purely an example */)39.336
648 Q
(void \(*sys_call_table[]\)\(\)={sys_open,sys_read,sys_close,....};)
45.336 660 Q(/* Hand-off to syscall handler, pseudocode */)51.336 672 Q
(\(*sys_call_table[%eax]\)\(args\);)90.936 684 Q F1 .494(When the k)
33.336 705 R .493(ernel is compiled, the sys_call_table is \214lled in \
with the name \(i.e. the virtual)-.13 F .417
(address\) of each C function which implements each system call.)33.336
720 R .417(It is the con)6.917 F -.195(ve)-.52 G .417(ntion that).195 F
4.637(as)33.336 735 S 1.386(ystem call which is kno)-4.637 F 1.386
(wn as XXX to the user is implemented by a k)-.325 F 1.386
(ernel function)-.13 F 0 Cg EP
%%Page: 16 16
%%BeginPageSetup
BP
%%EndPageSetup
/F0 9/Times-Roman@0 SF(ECE357:Computer Operating Systems)33.336 60 Q
(Unit 7/pg 16)71.748 E(\2512016 Jef)142.155 E 2.25(fH)-.225 G(akner)
-2.25 E/F1 13/Times-Roman@0 SF(called sys_XXX.)33.336 120 Q/F2 10
/Courier@0 SF(asmlinkage long sys_getuid\(void\))33.336 147 Q({)33.336
159 Q(return current->cred->uid;)81.336 171 Q
(/*cred is the credentials info */)26.4 E(})33.336 183 Q F1 2.083
(This system call is coded purely in C, and is in f)33.336 204 R 2.084
(act found in the architecture-neutral)-.13 F 2.814(portion of the k)
33.336 219 R 2.813(ernel source code \(at /usr/src/linux/k)-.13 F
(ernel/timer)-.13 E 6.063(.c\). The)-.715 F 2.813(only unusual)6.063 F
.677(thing is the compiler directi)33.336 234 R -.195(ve)-.325 G/F3 13
/Courier@0 SF(asmlinkage)4.122 E F1 3.927(,w)C .677
(hich indicates that this function is being)-3.927 F 3.968
(called directly from assembly language, and thus the ar)33.336 249 R
3.968(guments are passed in the)-.234 F(re)33.336 264 Q 5.298
(gisters. \(to)-.195 F 2.048(be precise,)5.298 F F3(asmlinkage)5.298 E
F1 2.048(is a macro which e)5.298 F 2.048(xpands out to other)-.195 F
5.298(,m)-.52 G(ore)-5.298 E 1.405
(confusing, gcc-speci\214c compiler directi)33.336 279 R -.195(ve)-.325
G 7.905(s\). If).195 F 1.405(you look in the source code you w)4.655 F
(on')-.13 E(t)-.234 E .061(\214nd the e)33.336 294 R .061(xact code abo)
-.195 F -.195(ve)-.195 G 3.312(,i).195 G 3.312(nw)-3.312 G .062
(hich some of the macros ha)-3.312 F .452 -.195(ve b)-.26 H .062(een e)
.195 F .062(xpanded out for better)-.195 F(readability)33.336 309 Q(.)
-.845 E .704(Note that the uid is a property of the currently running p\
rocess, and thus is fetched from)33.336 330 R(the)33.336 345 Q F3
(task_struct)3.25 E F1(structure via the)3.25 E F3(current)3.25 E F1
(pointer)3.25 E(.)-.715 E(Let')33.336 366 Q 3.25(st)-.715 G(ak)-3.25 E
3.25(eal)-.13 G(ook at another system call \()-3.25 E F3(time)A F1 3.25
(\)w)C(hich passes an ar)-3.25 E(gument:)-.234 E F2
(asmlinkage long sys_time\(time_t __user * tloc\))33.336 378 Q({)33.336
390 Q(time_t i;)81.336 402 Q(struct timespec tv;)81.336 414 Q 56.4
(getnstimeofday\(&tv\); //Kernel)81.336 438 R
(keeps time in ns resolution)6 E 6(i=t)81.336 450 S 150
(v.tv_sec; //tv_nsec)-6 F(ignored, therefore rounds DOWN)6 E
(if \(tloc\) {)81.336 474 Q(if \(put_user\(i,tloc\)\))129.336 486 Q 6
(i=-)177.336 498 S(EFAULT;)-6 E(})81.336 510 Q(return i;)81.336 522 Q(})
33.336 534 Q F1 1.709(Recall that)33.336 555 R F3(time)4.959 E F1 1.709
(returns the time as an int, b)4.959 F 1.709
(ut also accepts a pointer to an int.)-.26 F(That)8.21 E(ar)33.336 570 Q
1.659(gument comes in to the system call as)-.234 F F3(tloc)4.908 E F1
1.658(in the code abo)4.908 F -.195(ve)-.195 G 4.908(,a).195 G 1.658
(nd if supplied, the)-4.908 F -.13(ke)33.336 585 S 2.325(rnel tak).13 F
2.325(es the v)-.13 F 2.325(alue and writes it into the user')-.325 F
5.575(sm)-.715 G 2.325(emory using the k)-5.575 F 2.326(ernel function)
-.13 F F3(put_user)33.336 600 Q F1 7.098(.I)C 3.848(ft)-7.098 G .598
(he user supplied an in)-3.848 F -.325(va)-.52 G .598
(lid memory address,).325 F F3(put_user)3.848 E F1 .598(will catch that)
3.848 F .225(and return a non-zero v)33.336 615 R .225
(alue, which will cause the system call to f)-.325 F .226(ail with EF)
-.13 F -.715(AU)-.962 G -1.82 -1.196(LT .).715 H -1.04(We)7.922 G -.13
('l)1.04 G(l).13 E(ha)33.336 630 Q .449 -.195(ve a b)-.26 H .058
(it more to say about accessing user memory from within the k).195 F
.058(ernel in a fe)-.13 F 3.308(wu)-.325 G(nits.)-3.308 E/F4 13
/Times-Bold@0 SF(Retur)187.035 660 Q(ning fr)-.195 E(om a system call)
-.234 E F1 1.625(Once the system call speci\214c handler routine)33.336
696 R F3(sys_XXX)4.875 E F1 1.625(returns, the system call return)4.875
F -.325(va)33.336 711 S .175(lue is in the).325 F F3(%eax)3.424 E F1(re)
3.424 E .174(gister \(because that')-.195 F 3.424(sw)-.715 G .174
(here C function return v)-3.424 F .174(alues are placed by)-.325 F
1.135(the compiler\).)33.336 726 R 1.136(Looking back at the)7.635 F F3
(system_call)4.386 E F1 1.136(assembly language routine, we see)4.386 F
.614(this return v)33.336 741 R .614(alue is written to the k)-.325 F
.613(ernel stack in the location where the)-.13 F F3(eax)3.863 E F1(re)
3.863 E .613(gister will)-.195 F 0 Cg EP
%%Page: 17 17
%%BeginPageSetup
BP
%%EndPageSetup
/F0 9/Times-Roman@0 SF(ECE357:Computer Operating Systems)33.336 60 Q
(Unit 7/pg 17)71.748 E(\2512016 Jef)142.155 E 2.25(fH)-.225 G(akner)
-2.25 E/F1 13/Times-Roman@0 SF
(be popped when returning back to user mode.)33.336 120 Q(No)33.336 141
Q 5.546(wa)-.325 G 5.546(tl)-5.546 G(abel)-5.546 E/F2 13/Courier@0 SF
(syscall_exit)5.546 E F1 2.297(interrupts are temporarily mask)5.547 F
2.297(ed \(on multi-processor)-.13 F 1.689
(systems, this applies to the local processor only\).)33.336 156 R 1.688
(The reason for this is to protect the)8.188 F(ne)33.336 171 Q 4.945
(xt fe)-.195 F 8.195(wt)-.325 G 4.945
(esting and branching instructions as a)-8.195 F/F3 13/Times-Italic@0 SF
4.946(critical r)8.196 F -.52(eg)-.481 G(ion).52 E F1 11.446(.R)C 4.946
(ecall that the)-11.446 F F2(thread_info)33.336 186 Q F1 .048
(structure address is in)3.298 F F2(%ebp)3.298 E F1 6.548(.T)C .048
(he ne)-6.548 F .048(xt line of assembly code fetches the)-.195 F
(bitwise)33.336 201 Q F2(flags)5.805 E F1 2.555(into re)5.805 F(gister)
-.195 E F2(%ecx)5.806 E F1 2.556(and tests to see if an)5.806 F 5.806
<798d>-.195 G 2.556(ags are set which w)-5.806 F(ould)-.13 E 2.643(indi\
cate that, instead of returning directly to user mode, some other actio\
n might be)33.336 216 R 8.311(required. Let')33.336 231 R 8.311(ss)-.715
G 5.062(ay for a moment that those \215ags are clear)-8.311 F 11.562(.T)
-.715 G 5.062(hen the code at)-11.562 F F2(restore_all)33.336 246 Q F1
2.103(uses a macro)5.353 F F2(RESTORE_REGS)5.353 E F1 2.103
(to pop all of the re)5.353 F 2.102(gisters which had)-.195 F .391
(been sa)33.336 261 R -.195(ve)-.26 G 3.641(db).195 G(y)-3.641 E F2
(SAVE_REGS)3.642 E F1 6.892(.T)C .392(he system call return v)-6.892 F
.392(alue is no)-.325 F 3.642(wi)-.325 G(n)-3.642 E F2(%eax)3.642 E F1
(\(re)3.642 E -.065(ga)-.195 G .392(rdless of).065 F(ho)33.336 276 Q
8.011(wc)-.325 G 4.761(ontrol reached)-8.011 F F2(restore_all)8.011 E F1
8.011(\)a)C 4.76(nd the e)-8.011 F 4.76(xtra stack)-.195 F 4.76(ed cop)
-.13 F 8.01(yo)-.13 G(f)-8.01 E F2(eax)8.01 E F1(which)8.01 E
(contained the system call number is simply discarded.)33.336 291 Q(No)
33.336 312 Q 5.049(wt)-.325 G(he)-5.049 E F2(iret)5.049 E F1 1.799
(instruction is e)5.049 F -.195(xe)-.195 G 5.049(cuted. This).195 F
1.799(causes the hardw)5.049 F 1.799(are to restore the)-.13 F F2(eip,)
5.049 E .686(cs, eflags, esp)33.336 327 R F1(and)3.936 E F2(ss)3.936 E
F1(re)3.935 E 3.935(gisters. The)-.195 F .685(result is that e)3.935 F
-.195(xe)-.195 G .685(cution resumes in the user).195 F .188
(process, with the stack pointer back on the user')33.336 342 R 3.439
(ss)-.715 G 3.439(tack. All)-3.439 F .189(of the re)3.439 F .189
(gisters are e)-.195 F .189(xactly as)-.195 F(the)33.336 357 Q 7.446(yw)
-.195 G 4.196(ere when the user process e)-7.446 F -.195(xe)-.195 G
4.196(cuted the).195 F F2 4.196(INT $0x80)7.446 F F1 4.195
(instruction, with the)7.445 F -.195(ex)33.336 372 S 3.702
(ception of the).195 F F2(eax)6.952 E F1(re)6.952 E 3.702
(gister which no)-.195 F 6.952(wh)-.325 G 3.702
(olds the system call return v)-6.952 F 6.952(alue. The)-.325 F .027
(restoration of the)33.336 387 R F2(eflags)3.277 E F1(re)3.277 E .027
(gister means the pri)-.195 F(vile)-.325 E .027(ge le)-.195 F -.195(ve)
-.325 G 3.277(li).195 G 3.277(sr)-3.277 G .027
(eturned to user mode, and)-3.277 F .159
(the interrupt mask is restored to the normal v)33.336 402 R .159
(alue \(which when running in user mode is to)-.325 F(allo)33.336 417 Q
3.25(wi)-.325 G(nterrupts\).)-3.25 E/F4 13/Times-Bold@0 SF(Deferr)
176.095 447 Q(ed r)-.234 E(etur)-.234 E 3.25(nf)-.195 G -.234(ro)-3.25 G
3.25(ms).234 G(ystem call)-3.25 E F1 1.658(There are tw)33.336 483 R
4.908(om)-.13 G 1.658(ajor reasons wh)-4.908 F 4.908(yt)-.065 G 1.658
(he CPU w)-4.908 F 1.658(ould not return directly back to the user)-.13
F(-)-.26 E 1.378(mode program upon completion of a system call: \(1\) a\
nother task "may" be "better" to)33.336 498 R
(run, as determined by the scheduler)33.336 513 Q 6.5(.\()-.715 G
(2\) a deli)-6.5 E -.195(ve)-.325 G
(rable signal is pending for our process.).195 E 2.595
(The same reasons apply when returning back to user mode from a f)33.336
534 R 2.595(ault or interrupt)-.13 F(handler)33.336 549 Q(.)-.715 E F4
(Pr)192.495 579 Q(e-empti)-.234 E .26 -.13(ve c)-.13 H(ontext switch).13
E F1 2.996(The scheduler system may from time to time determine that th\
e current task is not)33.336 615 R .283
(necessarily the "best" task to be running on our CPU.)33.336 630 R .282
(This could happen from within the)6.782 F .445(tick interrupt handler \
\(because the current task has used up its timeslice\) or when, during)
33.336 645 R .375(our system call, another task has w)33.336 660 R(ok)
-.13 E .375(en up and it has better priority)-.13 F 6.874(.T)-.845 G
.374(he Linux k)-6.874 F .374(ernel is)-.13 F 2.578(not fully pre-empti)
33.336 675 R -.195(ve)-.325 G 9.078(.P).195 G(re-empti)-9.078 E 2.969
-.195(ve c)-.325 H(onte).195 E 2.579
(xt switches only happen at the moment that)-.195 F 2.834
(control is about to return to user mode.)33.336 690 R 2.834
(\(of course, if k)9.334 F 2.834(ernel code in a system call)-.13 F
2.367(encounters a blocking condition, such as reading from an empty pi\
pe, that causes an)33.336 705 R .818(immediate conte)33.336 720 R .818
(xt switch\).)-.195 F .818(The k)7.318 F 1.208 -.195(ey i)-.13 H 4.068
(st).195 G .818(he bitwise \215ag)-4.068 F F2(TIF_NEED_RESCHED)4.068 E
F1 .817(which is)4.067 F(part of the)33.336 735 Q F2(thread_info)3.25 E
F1(structure on the k)3.25 E(ernel stack.)-.13 E 0 Cg EP
%%Page: 18 18
%%BeginPageSetup
BP
%%EndPageSetup
/F0 9/Times-Roman@0 SF(ECE357:Computer Operating Systems)33.336 60 Q
(Unit 7/pg 18)71.748 E(\2512016 Jef)142.155 E 2.25(fH)-.225 G(akner)
-2.25 E/F1 13/Times-Roman@0 SF 3.71(Referring to the)33.336 120 R/F2 13
/Courier@0 SF(entry.S)6.96 E F1 3.71(code, if the)6.96 F F2
(TIF_NEED_RESCHED)6.96 E F1 3.711(\215ag is set, then at)6.961 F F2
(work_resched)33.336 135 Q F1 .485(the k)3.735 F .485
(ernel scheduler function)-.13 F F2(schedule)3.735 E F1 .484(is called.)
3.735 F -1.04(We)6.984 G -.13('l)1.04 G 3.734(ls).13 G .484
(ee that this)-3.734 F 2.591
(function, if it picks another process to run, causes a)33.336 150 R/F3
13/Times-Italic@0 SF(conte)5.841 E 2.591(xt switc)-.26 F(h)-.195 E F1
5.841(,a)C 2.591(nd the original)-5.841 F 5.843
(process appears to be frozen at the instant of ha)33.336 165 R 5.842
(ving called)-.26 F F2(schedule)9.092 E F1(from)9.092 E F2(work_resched)
33.336 180 Q F1 7.448(.A)C 4.198(ts)-7.448 G .948
(ome later time, the original process is selected to run ag)-4.198 F
.948(ain, and)-.065 F -.195(exe)33.336 195 S 1.428
(cution resumes at that frozen point.).195 F 1.428(Control returns from)
7.928 F F2(schedule)4.678 E F1 4.678(,a)C 1.427(nd then the)-4.678 F(ne)
33.336 210 Q .949(xt fe)-.195 F 4.199(wl)-.325 G .95
(ines are identical to those we ha)-4.199 F 1.34 -.195(ve a)-.26 H .95
(lready seen: the).195 F 4.2(yc)-.195 G .95(heck to see if an)-4.2 F
(ything)-.195 E
(else has come up, or whether it is OK to return to user mode.)33.336
225 Q/F4 13/Times-Bold@0 SF(Signal Deli)225.034 255 Q -.13(ve)-.13 G(ry)
.13 E F1 .572(It could also be that while the task w)33.336 291 R .572
(as in k)-.13 F .572(ernel mode, a signal became pending for that)-.13 F
4.404(task. Perhaps)33.336 306 R 1.154
(the system call changed the signal mask and a pre)4.404 F 1.154
(viously recei)-.325 F -.195(ve)-.325 G 4.404(ds).195 G(ignal)-4.404 E
2.39(became un-block)33.336 321 R 2.389
(ed, or perhaps the system call itself caused a signal to be raised, or)
-.13 F .512(perhaps a signal from another process just happened to come\
 along while we were in the)33.336 336 R 1.441(system call.)33.336 351 R
1.441(Signal deli)7.941 F -.195(ve)-.325 G(ry).195 E 4.69(,a)-.845 G
4.69(sd)-4.69 G 1.44
(iscussed in Unit #4, only happens at the moment that)-4.69 F(control w)
33.336 366 Q(as about to return from k)-.13 E
(ernel mode back to user mode.)-.13 E F2(work_notifysig)33.336 387 Q F1
3.327(is called when the threadinfo \215ags indicate that a non-block)
6.576 F(ed)-.13 E 1.678(signal is pending for the process.)33.336 402 R
1.678(The k)8.178 F 1.678(ernel then has some w)-.13 F 1.678
(ork to do to deli)-.13 F -.195(ve)-.325 G 4.927(rt).195 G(he)-4.927 E
.397(signal to the process.)33.336 417 R .397(As we')6.897 F .787 -.195
(ve s)-.65 H .397
(een in Unit #4, that might mean terminating the process).195 F 1.226
(\(the k)33.336 432 R 1.226(ernel calls)-.13 F F2(do_exit)4.476 E F1
1.226(on behalf of the process\) or in)4.476 F -.26(vo)-.52 G 1.225
(king the signal handler).26 F 7.725(.I)-.715 G(n)-7.725 E 1.369
(the latter case, the k)33.336 447 R 1.37(ernel has to modify the user)
-.13 F 1.37(-mode stack to mak)-.26 F 4.62(ei)-.13 G 4.62(ta)-4.62 G
1.37(ppear that the)-4.62 F .869(handler w)33.336 462 R .869
(as called from the point in the user)-.13 F .869
(-mode program \(%eip v)-.26 F .869(alue\) where control)-.325 F .325
(had entered the k)33.336 477 R .325(ernel, and then change the user)
-.13 F .325(-mode re)-.26 F .325(gisters sa)-.195 F -.195(ve)-.26 G
3.575(do).195 G 3.575(nt)-3.575 G .325(he k)-3.575 F .325(ernel stack)
-.13 F .918(to cause control to return to user mode at the %eip locatio\
n of the signal handler)33.336 492 R 4.168(,r)-.52 G(ather)-4.168 E
(than the point where it left of)33.336 507 Q(f!)-.325 E 1.921
(The orig_eax stack slot is al)33.336 528 R -.13(wa)-.13 G 1.922
(ys the original system call number that got us into the).13 F -.13(ke)
33.336 543 S 4.731(rnel. The).13 F 1.48
(eax slot will contain the syscall return v)4.731 F 1.48
(alue after the system call has run.)-.325 F .084
(orig_eax is used in signal handling for "restarted system calls" b)
33.336 558 R .084(ut we w)-.26 F(on')-.13 E 3.334(tb)-.234 G 3.334(el)
-3.334 G .085(ooking at)-3.334 F(that code.)33.336 573 Q F4
(The X86-64 API)222.2 603 Q F1 .883(Although the e)33.336 639 R .882
(xamples herein are for the older 32-bit X86 API, also kno)-.195 F .882
(wn as i386, we)-.325 F(should e)33.336 654 Q(xamine ho)-.195 E 3.25(wt)
-.325 G(hings change when using the 64-bit API, kno)-3.25 E
(wn as X86-64.)-.325 E .039(At user le)33.336 675 R -.195(ve)-.325 G
.039(l, the \214rst 6 ar).195 F .039
(guments to a function are passed in re)-.234 F .039
(gisters, not the stack.)-.195 F(The)6.539 E(ar)33.336 690 Q 1.583
(gument slots are re)-.234 F 1.583(gisters %rdi,%rsi,%rdx,%rcx,%r8,%r9.)
-.195 F 1.583(The X86-64 API does not)8.083 F .401
(use the INT 0x80 instruction, b)33.336 705 R .401(ut a ne)-.26 F 3.651
(wi)-.325 G .401(nstruction called)-3.651 F F2(SYSCALL)3.651 E F1 3.651
(,w)C .401(hich is some)-3.651 F(what)-.325 E -.13(fa)33.336 720 S(ster)
.13 E 6.5(.I)-.715 G 3.25(tp)-6.5 G(erforms the follo)-3.25 E
(wing steps in hardw)-.325 E(are:)-.13 E 3.25<8353>33.336 735 S -2.925
-.26(av e)-3.25 H(the return address \(%rip re)3.51 E(gister\) in re)
-.195 E(gister %rcx \(o)-.195 E -.195(ve)-.195 G(rwriting its v).195 E
(alue\))-.325 E 0 Cg EP
%%Page: 19 19
%%BeginPageSetup
BP
%%EndPageSetup
/F0 9/Times-Roman@0 SF(ECE357:Computer Operating Systems)33.336 60 Q
(Unit 7/pg 19)71.748 E(\2512016 Jef)142.155 E 2.25(fH)-.225 G(akner)
-2.25 E/F1 13/Times-Roman@0 SF 3.25<8353>33.336 120 S -2.925 -.26(av e)
-3.25 H(the current v)3.51 E(alue of the \215ags re)-.325 E
(gister \(%r\215ags\) in %r11 \(o)-.195 E -.195(ve)-.195 G
(rwriting it too\)).195 E 4.547<834d>33.336 135 S(ak)-4.547 E 4.547(es)
-.13 G 1.297(ome adjustments to the %cs and %ss re)-4.547 F 1.296
(gisters to allo)-.195 F 4.546(wk)-.325 G 1.296(ernel code to e)-4.676 F
-.195(xe)-.195 G(cute).195 E(properly)33.336 150 Q(.)-.845 E 3.25<8353>
33.336 165 S(et the processor to pri)-3.25 E(vile)-.325 E(ged mode)-.195
E 4.009<834c>33.336 180 S .759(oad the v)-4.009 F .759
(alue of a special re)-.325 F .759(gister \(MSR_CST)-.195 F .759
(AR\) into %rip.)-1.209 F .759(This pri)7.259 F(vile)-.325 E .759
(ged re)-.195 F(gister)-.195 E(has been pre-loaded by the k)33.336 195 Q
(ernel to point to the system call entrypoint.)-.13 E .281
(Note that in this 64-bit API, the hardw)33.336 225 R .281
(are does not stack an)-.13 F 3.531(yr)-.195 G -.195(eg)-3.531 G .28
(isters when performing a).195 F(system call.)33.336 240 Q .423
(Because the %rcx re)33.336 261 R .424
(gister is clobbered by the SYSCALL instruction, the k)-.195 F(ernel')
-.13 E 3.674(ss)-.715 G(ystem)-3.674 E 2.065(call con)33.336 276 R -.195
(ve)-.52 G 2.065(ntion speci\214es that the ar).195 F 2.065
(guments to the system call are passed in re)-.234 F(gisters:)-.195 E
4.425(%rdi,%rsi,%rdx,%r10,%r8,%r9. The)33.336 291 R 1.176
(system call number is passed in %rax.)4.425 F(Therefore,)7.676 E 1.326
(the user)33.336 306 R(-le)-.26 E -.195(ve)-.325 G 4.576(l").195 G 1.326
(glue" code tak)-4.576 F 1.326(es the 4th ar)-.13 F 1.326
(gument in %rcx and mo)-.234 F -.195(ve)-.195 G 4.576(si).195 G 4.576
(ti)-4.576 G 1.326(nto %r10, and)-4.576 F .679
(adds the system call number in %rax.)33.336 321 R .679(The k)7.179 F
(ernel')-.13 E 3.929(ss)-.715 G .68(ystem call assembly-language entry)
-3.929 F .072(code will put the 4th ar)33.336 336 R .071
(gument back into %rcx from %r10 prior to dispatching to k)-.234 F .071
(ernel C)-.13 F(functions via the system call table.)33.336 351 Q(Unlik)
33.336 372 Q 5.901(et)-.13 G 2.651(he 32-bit API, the 64-bit SYSCALL AP\
I does not change the stack pointer)-5.901 F(.)-.715 E 4.237
(Upon entry via an)33.336 387 R 7.487(yk)-.195 G 4.237
(ernel entrypoint, the k)-7.617 F 4.237(ernel uses the)-.13 F/F2 13
/Courier@0 SF(SWAPGS)7.487 E F1 4.236(instruction to)7.487 F .299
(interchange the user)33.336 402 R .299(-mode v)-.26 F .299
(alue of the %gs re)-.325 F .299(gister with a "hidden" %gs re)-.195 F
.299(gister that the)-.195 F -.13(ke)33.336 417 S 2.743
(rnel has pre-con\214gured.).13 F 2.743(This re)9.243 F 2.743
(gister can be used in conjunction with an obscure)-.195 F .718
(aspect of X86 programming kno)33.336 432 R .718(wn as "se)-.325 F .718
(gment o)-.195 F -.195(ve)-.195 G .718(rride", allo).195 F .719
(wing access to a reserv)-.325 F(ed)-.195 E 2.885(area of ph)33.336 447
R 2.885(ysical memory that the k)-.065 F 2.885
(ernel has pre-con\214gured.)-.13 F 2.885(It contains an array of)9.385
F .317(scratchpad areas, one for each processor)33.336 462 R 3.567(,k)
-.52 G(no)-3.567 E .318(wn as the "per_cpu" areas.)-.325 F .318(The v)
6.818 F .318(alue of the)-.325 F -.13(ke)33.336 477 S 1.585
(rnel stack pointer w).13 F 1.584(as sa)-.13 F -.195(ve)-.26 G 4.834(di)
.195 G 4.834(nt)-4.834 G 1.584(his per)-4.834 F 1.584
(-cpu area before control w)-.26 F 1.584(as returned to user)-.13 F
4.274(mode. Therefore,)33.336 492 R 1.024(on entry to the k)4.274 F
1.024(ernel, this sa)-.13 F -.195(ve)-.26 G 4.274(dk).195 G 1.024
(ernel stack pointer is retrie)-4.404 F -.195(ve)-.325 G 4.275(da).195 G
(nd)-4.275 E 2.809(processing of the system call \(or f)33.336 507 R
2.809(ault or interrupt\) continues within the k)-.13 F 2.809
(ernel in a)-.13 F(normal C en)33.336 522 Q(vironment.)-.52 E .284
(The k)33.336 543 R .284(ernel of course has sa)-.13 F -.195(ve)-.26 G
3.534(da).195 G .284(ll re)-3.534 F .284
(gisters once it has established the k)-.195 F .285(ernel stack.)-.13 F
(Prior)6.785 E .41(to return to user mode, the k)33.336 558 R .41
(ernel mak)-.13 F .41(es sure that the k)-.13 F .41
(ernel stack pointer is stored in the)-.13 F(per)33.336 573 Q 1.529
(-cpu scratchpad area, e)-.26 F -.195(xe)-.195 G 1.529(cutes the SW).195
F 1.53(APGS instruction ag)-1.56 F 1.53(ain to sa)-.065 F 1.92 -.195
(ve t)-.26 H 1.53(he hidden gs).195 F(re)33.336 588 Q(gister)-.195 E
4.672(,a)-.52 G 1.422(nd restores the user)-4.672 F 1.422
(-mode %rip and %r\215ags v)-.26 F 1.422(alues \(which were sa)-.325 F
-.195(ve)-.26 G 4.672(do).195 G 4.672(nt)-4.672 G(he)-4.672 E -.13(ke)
33.336 603 S .937(rnel stack\) into %rcx and %r11 respecti).13 F -.195
(ve)-.325 G(ly).195 E 7.437(.T)-.845 G(he)-7.437 E F2(SYSRET)4.187 E F1
.937(instruction is then used to)4.187 F(re)33.336 618 Q -.195(ve)-.325
G(rse the ef).195 E(fects of)-.325 E F2(SYSCALL)3.25 E F1
(and return control to user mode.)3.25 E .857(If the abo)33.336 639 R
1.246 -.195(ve d)-.195 H .856
(escription of X86-64 caused pain and/or confusion, do not panic.).195 F
2.936 -1.04(We w)7.356 H(ill)1.04 E(conduct the rest of our e)33.336 654
Q(xamples in 32 bits.)-.195 E 0 Cg EP
%%Page: 20 20
%%BeginPageSetup
BP
%%EndPageSetup
/F0 9/Times-Roman@0 SF(ECE357:Computer Operating Systems)33.336 60 Q
(Unit 7/pg 20)71.748 E(\2512016 Jef)142.155 E 2.25(fH)-.225 G(akner)
-2.25 E/F1 13/Times-Bold@0 SF(Summary of 32 and 64 bit X86 Syscall APIs)
146.358 120 Q/F2 13/Times-Roman@0 SF 60.658(32 64)94.722 165 R .52 LW
229.415 170.25 33.336 170.25 DL 229.415 172.25 33.336 172.25 DL 17.706
(Opcode INT)33.336 184 R 16.25($0x80 SYSCALL)3.25 F 16.25(syscall# %eax)
33.336 199 R(%rax)48.035 E(ar)33.336 214 Q 35.269(g1 %ebx)-.234 F(%rdi)
47.307 E(ar)33.336 229 Q 35.269(g2 %ecx)-.234 F(%rsi)48.035 E(ar)33.336
244 Q 35.269(g3 %edx)-.234 F(%rdx)47.307 E(ar)33.336 259 Q 35.269
(g4 %esi)-.234 F(%r10)51.636 E(ar)33.336 274 Q 35.269(g5 %edi)-.234 F
(%r8)50.193 E(ar)33.336 289 Q 35.269(g6 %ebp)-.234 F(%r9)47.307 E(retv)
33.336 304 Q 28.86(al %eax)-.325 F(%rax)48.035 E 161.88 153.25 161.88
307.25 DL 84.972 153.25 84.972 307.25 DL F1 -.325(Ap)117.511 349 S
(pendix - X86 Ar).325 E(chitectur)-.234 E 3.25(ea)-.234 G
(nd Assembly Language)-3.25 E F2 1.055(The follo)33.336 385 R 1.055(win\
g material comes from ECE466 -- Compilers and is intended to assist wit\
h)-.325 F(understand the assembly language portion of the k)33.336 400 Q
(ernel.)-.13 E .091(X86 refers broadly to a f)33.336 421 R .091
(amily of Intel \(and compatible\) microprocessors manuf)-.13 F .091
(actured in)-.13 F .044(the last 20 years or so.)33.336 436 R .044
(It is also called the X86 architecture by Intel.)6.544 F .044
(The \214rst 32-bit X86)6.544 F 3.431(processor w)33.336 451 R 3.431
(as the 80386.)-.13 F 3.43(X86-64 is a 64-bit e)9.93 F 3.43
(xtension to X86.)-.195 F(Intel')9.93 E 6.68(si)-.715 G 6.68(saC)-6.68 G
(ISC)-6.68 E .508
(architecture which is a direct linear descendent of the v)33.336 466 R
.508(ery \214rst microprocessor)-.195 F 3.758(,t)-.52 G .508(he 4004)
-3.758 F(\(a 4-bit product\).)33.336 481 Q .3(There are man)33.336 502 R
3.55(yw)-.195 G .3(ho \214nd the X86 architecture to be a dinosaur)-3.55
F 3.55(,a)-.52 G .299(nd a badly designed one)-3.55 F .692
(at that, which should ha)33.336 517 R 1.082 -.195(ve l)-.26 H .692
(ong ago become e).195 F 3.943(xtinct. Ho)-.195 F(we)-.325 E -.195(ve)
-.325 G 1.733 -.52(r, I).195 H(BM').52 E 3.943(sc)-.715 G .693
(hoice of it for its)-3.943 F(\214rst personal computer sealed its f)
33.336 532 Q(ate as the most popular processor architecture.)-.13 E
1.514(The X86-64 architecture e)33.336 553 R 1.513
(xtends the 32-bit X86 to use 64-bit re)-.195 F 1.513
(gisters, while retaining)-.195 F(backw)33.336 568 Q
(ards compatibility with 32-bit X86 code.)-.13 E(Belo)33.336 589 Q 3.458
(wi)-.325 G 3.458(sas)-3.458 G .208
(ummary of the X86/X86-64 architecture The reader is detoured to the of)
-3.458 F(\214cial)-.325 E(reference manuals for full details.)33.336 604
Q F1(Intel vs UNIX assembly syntax)182.114 634 Q F2 .359(The Intel docu\
mentation uses the Intel standard assembly language syntax, b)33.336 670
R .358(ut the UNIX)-.26 F(assembler)33.336 685 Q/F3 13/Courier@0 SF(as)
8.078 E F2(follo)8.078 E 4.828(ws a dif)-.325 F 4.828(ferent con)-.325 F
-.195(ve)-.52 G 4.828(ntion \(which is consistent across dif).195 F
(ferent)-.325 E 4.732(processors\). In)33.336 700 R 1.482
(the UNIX syntax, an identi\214er is unambiguously an assembler symbol.)
4.732 F 4.125 -1.04(To r)33.336 715 T 2.045(eference a re)1.04 F(gister)
-.195 E 5.295(,i)-.52 G 2.045(ts name is pre\214x)-5.295 F 2.045
(ed with a percent sign, e.g. %eax.)-.195 F 4.125 -1.04(To u)8.545 H
2.046(se a)1.04 F .699(symbol as an immediate v)33.336 730 R .699
(alue, the dollar sign is used as a pre\214x.)-.325 F .698
(Otherwise the symbol)7.198 F .986(means the contents of that address.)
33.336 745 R(Re)7.486 E .986
(gister indirect addressing modes are indicated by)-.195 F 0 Cg EP
%%Page: 21 21
%%BeginPageSetup
BP
%%EndPageSetup
/F0 9/Times-Roman@0 SF(ECE357:Computer Operating Systems)33.336 60 Q
(Unit 7/pg 21)71.748 E(\2512016 Jef)142.155 E 2.25(fH)-.225 G(akner)
-2.25 E/F1 13/Times-Roman@0 SF(brack)33.336 120 Q 5.082(ets or parenthe\
ses. UNIX assembly instructions are opcode src1,src2,dst for)-.13 F .698
(3-address instructions or opcode src,dst for 2-address.)33.336 135 R
.699(\(Note that Intel syntax is dst,src\).)7.199 F 4.6 -1.04(We w)
33.336 150 T 2.52(ill use the UNIX syntax in these notes.)1.04 F 2.519
(Another name for this is the "A)9.019 F(T&T")-1.443 E
(syntax, after the original authors of UNIX)33.336 165 Q 2.656
(In the UNIX/A)33.336 186 R 2.656
(T&T syntax, where a particular opcode can be performed at dif)-1.443 F
(ferent)-.325 E 1.291(precisions, that opcode recei)33.336 201 R -.195
(ve)-.325 G 4.54(sal).195 G 1.29(etter suf)-4.54 F 1.29(\214x: b,w)-.325
F 1.29(,l,q for 8,16,32 and 64-bit operations)-.845 F(respecti)33.336
216 Q -.195(ve)-.325 G(ly).195 E(.)-.845 E .255
(Assembly language \214les are denoted with a .s or .S suf)33.336 237 R
3.506(\214x. The)-.325 F .256(latter is used in the Linux)3.506 F -.13
(ke)33.336 252 S 1.986
(rnel for \214les which are hand-crafted in assembly).13 F 5.235(,a)
-.845 G 5.235(so)-5.235 G 1.985(pposed to .s \214les which were)-5.235 F
1.614(generated by the compiler)33.336 267 R 8.114(.A)-.715 G 1.614
(ssembly language is line-break sensiti)-8.114 F -.195(ve)-.325 G 8.114
(.E).195 G 1.615(ach line is an)-8.114 F 3.437
(instruction \(not including whitespace, assembler directi)33.336 282 R
-.195(ve)-.325 G 6.686(sa).195 G 3.436(nd comments\) and each)-6.686 F
.417(instruction must be contained on that line.)33.336 297 R .417
(The line has 2 parts: opcode operands.)6.917 F(These)6.917 E .197
(\214elds are separated by whitespace.)33.336 312 R .197
(The label is a symbolic name gi)6.697 F -.195(ve)-.325 G 3.447(nt).195
G 3.446(ot)-3.447 G .196(hat instruction)-3.446 F .485
(or memory location.)33.336 327 R .485(It is speci\214ed as)6.985 F/F2
13/Courier@0 SF(label:)3.735 E F1 .486(and can either appear at the be)
3.735 F .486(ginning of)-.195 F 1.553(the line, or on a line by itself,\
 in which case the label is attached to the ne)33.336 342 R 1.552
(xt line.)-.195 F(By)8.052 E 1.11(stylistic con)33.336 357 R -.195(ve)
-.52 G 1.11(ntion, the opcode is ne).195 F -.195(ve)-.325 G 4.36(ra).195
G 4.36(tt)-4.36 G 1.11(he be)-4.36 F 1.11(ginning of the line.)-.195 F
1.111(There is least one)7.61 F .858(whitespace character \(typically a\
 tab\) so that the opcode is not mistak)33.336 372 R .858
(en as a label.)-.13 F(The)7.358 E 1.39(operands \214eld contains 0, 1 \
or more operands delimited by commas, and follo)33.336 387 R 1.39
(wing the)-.325 F(addressing mode syntax e)33.336 402 Q(xplained belo)
-.195 E -.845(w.)-.325 G/F3 13/Times-Bold@0 SF(Assembler Dir)158.539 432
Q(ecti)-.234 E -.13(ve)-.13 G 3.25(s/P).13 G(seudo Opcodes)-3.25 E F1
1.533(Assembler directi)33.336 462 R -.195(ve)-.325 G 4.783(sa).195 G
1.533(re pseudo-opcodes that do not correspond to actual opcodes that)
-4.783 F .258(the processor e)33.336 477 R -.195(xe)-.195 G .258
(cutes, b).195 F .258
(ut cause the assembler to modify its operation, or to emit special)-.26
F 2.135(code or data.)33.336 492 R 2.135(These include)8.635 F F2(.text)
5.385 E F1(and)5.385 E F2(.data)5.385 E F1 2.135
(to switch between the te)5.385 F 2.134(xt and data)-.195 F .169
(sections of the a.out \214le,)33.336 507 R F2(.byte)3.42 E F1 .17
(to emit a single byte,)3.42 F F2(.long)3.42 E F1 .17
(to emit a 4-byte v)3.42 F .17(alue, and)-.325 F F2(.string)33.336 522 Q
F1 .383(to emit a nul-terminated string.)3.633 F .382(This is not an e)
6.882 F(xhausti)-.195 E .772 -.195(ve l)-.325 H .382
(ist and the reader is).195 F(referred to the documentation for)33.336
537 Q F2(as)3.25 E F1(.)A F3(X86 Register Model)212.099 567 Q F1 .403
(When referring to X86 re)33.336 603 R .403
(gisters, their size is implied by a pre\214x.)-.195 F -.195(Fo)6.903 G
3.653(re).195 G .403(xample, there is a)-3.848 F .393(32-bit re)33.336
618 R .393(gister called EAX.)-.195 F .393
(The least signi\214cant 16 bits of that re)6.893 F .392
(gister are called AX.)-.195 F(It)6.892 E .162
(is possible to refer to the least signi\214cant byte as AL and the ne)
33.336 633 R .162(xt most signi\214cant byte as)-.195 F 5.264(AH. In)
33.336 648 R 2.013(the 64-bit X86-64 instruction set, the 64-bit v)5.264
F 2.013(ersion of EAX w)-.195 F 2.013(ould be called)-.13 F 3.25(RAX. W)
33.336 663 R 3.25(ew)-1.04 G(ill consider the 32-bit model \214rst.)
-3.25 E .643(The re)33.336 684 R .643(gister model of X86 is con)-.195 F
-.26(vo)-.52 G .644(luted and archaic, making ef).26 F .644
(\214cient re)-.325 F .644(gister allocation)-.195 F 4.683
(and instruction selection a challenge.)33.336 699 R 4.683(The follo)
11.183 F 4.683(wing general-purpose re)-.325 F 4.682(gisters are)-.195 F
(typically used for holding temporary v)33.336 714 Q
(alues, general inte)-.325 E(ger computation, etc.)-.195 E 3.25<8325>
33.336 729 S(eax: The "accumulator".)-3.25 E(Man)6.5 E 3.25(yi)-.195 G
(nstructions use %eax as an implied operand.)-3.25 E 3.25<8325>33.336
744 S(ebx: The "base re)-3.25 E
(gister" \(not to be confused with %ebp\).)-.195 E 0 Cg EP
%%Page: 22 22
%%BeginPageSetup
BP
%%EndPageSetup
/F0 9/Times-Roman@0 SF(ECE357:Computer Operating Systems)33.336 60 Q
(Unit 7/pg 22)71.748 E(\2512016 Jef)142.155 E 2.25(fH)-.225 G(akner)
-2.25 E/F1 13/Times-Roman@0 SF 3.25<8325>33.336 120 S
(ecx: The "counter re)-3.25 E(gister".)-.195 E 3.25<8325>33.336 135 S
(edx: The "data re)-3.25 E(gister".)-.195 E 3.25<8325>33.336 150 S
(esi: Source re)-3.25 E(gister for string operations)-.195 E 3.25<8325>
33.336 165 S(edi: Destination re)-3.25 E(gister for string operations)
-.195 E(The follo)33.336 186 Q(wing special re)-.325 E
(gisters are used for control \215o)-.195 E(w:)-.325 E 4.753<8325>33.336
201 S 1.503(eip: The "instruction pointer", aka the Program Counter)
-4.753 F 8.003(.A)-.715 G 4.753(tt)-8.003 G 1.503
(he time of instruction)-4.753 F -.195(exe)33.336 216 S 2.385
(cution, %eip contains the address of the ne).195 F 2.385
(xt instruction to be fetched.)-.195 F 5.635(Ab)8.885 G(ranch)-5.635 E
1.961(instruction modi\214es %eip and causes the ne)33.336 231 R 1.961
(xt instruction to be fetched from that ne)-.195 F(w)-.325 E(address.)
33.336 246 Q 3.25<8325>33.336 261 S(esp: The stack pointer)-3.25 E(.)
-.715 E 3.366<8325>33.336 276 S .116(ebp: T)-3.366 F .115
(ypically used in the C / assembly language con)-1.04 F -.195(ve)-.52 G
.115(ntion for the stack frame "base).195 F 3.25(pointer". Aka)33.336
291 R(the "frame pointer".)3.25 E 5.466<8325>33.336 306 S 2.216
(e\215ags: The \215ags re)-5.466 F(gister)-.195 E 8.716(.I)-.715 G 5.466
(tc)-8.716 G 2.216(ontains the condition code \215ags \(carry)-5.466 F
5.466(,p)-.845 G(arity)-5.466 E 5.466(,B)-.845 G(CD)-5.466 E 1.546
(adjust, zero, signed, o)33.336 321 R -.195(ve)-.195 G(r\215o).195 E
1.545(w\) as well as a number of \215ags and control bits which can)
-.325 F .308(only be modi\214ed when running in K)33.336 336 R .308
(ernel \(Supervisor\) mode, such as the interrupt enable)-.325 F
(\215ag and the user/supervisor pri)33.336 351 Q(vile)-.325 E(ge le)
-.195 E -.195(ve)-.325 G(l.).195 E/F2 13/Times-Bold@0 SF
(Segmentation, Special-Pur)110.855 381 Q(pose and Additional Registers)
-.13 E F1 .999
(The X86 addressing scheme is based on an obsolete concept kno)33.336
411 R .998(wn as "se)-.325 F(gment/of)-.195 E(fset")-.325 E 6.555
(addressing. In)33.336 426 R 3.306
(all modern operating systems, program addresses are linear)6.555 F
6.556(,a)-.52 G 3.306(nd the)-6.556 F(se)33.336 441 Q 1.537
(gmentation is basically ignored.)-.195 F 1.536(The re)8.037 F 1.536
(gister model contains the re)-.195 F 1.536(gisters %cs, %ds,)-.195 F
.389(%ss which are initialized by the k)33.336 456 R .389
(ernel and should not be touched.)-.13 F(The)6.889 E 3.639(ya)-.195 G
.39(re what enable)-3.639 F 1.131(code, data and stack accesses to w)
33.336 471 R 4.381(ork. Additional)-.13 F(se)4.381 E 1.131(gment re)
-.195 F 1.131(gisters %es, %fs and %gs)-.195 F 3.079(are general-purpos\
e and, because a linear addressing model is being used, could be)33.336
486 R(emplo)33.336 501 Q 1.614(yed as general-purpose scratch re)-.13 F
1.613(gisters, subject to some restrictions as to which)-.195 F(re)
33.336 516 Q .476(gisters may appear in which instructions.)-.195 F(Ho)
6.976 E(we)-.325 E -.195(ve)-.325 G 1.516 -.52(r, b).195 H .476
(oth the %fs and %gs re).52 F .476(gisters are)-.195 F(used by the k)
33.336 531 Q(ernel and the standard library)-.13 E 3.25(,a)-.845 G
(nd should be a)-3.25 E -.26(vo)-.26 G(ided.).26 E 5.302 -1.04(We h)
33.336 552 T -2.925 -.26(av e)1.04 H 3.222(seen additional re)6.732 F
3.222(gisters such as %cr3 and %tr)-.195 F 9.722(.T)-.715 G 3.222
(hese are generally only)-9.722 F 1.713(accessible when running in k)
33.336 567 R 1.713
(ernel mode, and require special opcodes to read or write.)-.13 F .241
(Additional re)33.336 582 R .241(gisters are present for v)-.195 F .24
(arious \215oating point operations.)-.325 F .24(The k)6.74 F .24
(ernel does not)-.13 F .547(use these at all, b)33.336 597 R .548
(ut is required to sa)-.26 F .938 -.195(ve a)-.26 H .548
(nd restore them when conte).195 F .548(xt switching between)-.195 F
(user)33.336 612 Q(-le)-.26 E -.195(ve)-.325 G 3.25(lt).195 G
(asks, if the)-3.25 E 3.25(ya)-.195 G(re being used by those tasks.)
-3.25 E(On X86-64, there are additional general-purpose re)33.336 633 Q
(gisters)-.195 E/F3 13/Courier@0 SF(%r8 - %r15)3.25 E F1(.)A F2(Addr)
215.992 678 Q(essing Modes)-.234 E F1 .955(There are a number of addres\
sing modes which are used to specify where to \214nd or put)33.336 714 R
(the operands of an instruction:)33.336 729 Q 3.25<8352>33.336 744 S
-.195(eg)-3.25 G(ister Direct: Specify the re).195 E
(gister name with a % pre\214x, e.g. %eax.)-.195 E 0 Cg EP
%%Page: 23 23
%%BeginPageSetup
BP
%%EndPageSetup
/F0 9/Times-Roman@0 SF(ECE357:Computer Operating Systems)33.336 60 Q
(Unit 7/pg 23)71.748 E(\2512016 Jef)142.155 E 2.25(fH)-.225 G(akner)
-2.25 E/F1 13/Times-Roman@0 SF 3.25<8349>33.336 120 S
(mmediate: The immediate v)-3.25 E(alue must be pre\214x)-.325 E
(ed with the dollar sign, e.g. $1)-.195 E 5.099<834d>33.336 135 S 1.849
(emory Absolute: The absolute address of the operand is speci\214ed wit\
hout a pre\214x)-5.099 F(quali\214er)33.336 150 Q 9.409(.E)-.715 G(.g.)
-9.409 E/F2 13/Courier@0 SF 2.909(movl $1,y)6.159 F F1(mo)6.159 E -.195
(ve)-.195 G 6.159(st).195 G 2.909(he immediate v)-6.159 F 2.908
(alue 1 into the memory address)-.325 F
(which is associated with the link)33.336 165 Q(er symbol y)-.13 E(.)
-.845 E 5.046<8342>33.336 180 S(ase-inde)-5.046 E 5.046(x\()-.195 G(Re)
-5.046 E 1.796(gister Indirect with of)-.195 F 1.796
(fset\): The X86 has a handy mode for accessing)-.325 F .661
(elements of an array)33.336 195 R 7.161(.T)-.845 G .661(he syntax is)
-7.161 F F2(disp\(%base,%index,scale\))3.911 E F1 3.91(.T)3.91 G .66
(he address of)-3.91 F 1.126(the operand is computed as)33.336 210 R F2
(addr=base+index*scale+disp)4.377 E F1 7.627(.T)C 1.127
(he base and inde)-7.627 F(x)-.195 E 1.527(may be an)33.336 225 R 4.777
(yo)-.195 G 4.776(ft)-4.777 G 1.526(he general-purpose re)-4.776 F 1.526
(gisters \(eax, ebx, ecx, edx, ebp, dsi, edi, esp \(not)-.195 F(allo)
33.336 240 Q 1.391(wed as the inde)-.325 F 1.391
(x\)\). The displacement is a 32-bit absolute address.)-.195 F 1.391
(The scale f)7.891 F(actor)-.13 E 3.47(may be 1, 2, 4 or 8.)33.336 255 R
3.47(Some of these parameters may be omitted, forming simpler)9.97 F
.507(addressing modes.)33.336 270 R .508(E.g. in)7.008 F F2 .508
(movl $1, \(%eax\))7.008 F F1 .508(the eax re)3.758 F .508
(gister contains a pointer to a)-.195 F
(memory location, into which the immediate v)33.336 285 Q(alue 1 is mo)
-.325 E -.195(ve)-.195 G(d.).195 E 2.045(X86 is generally a 2-address a\
rchitecture, meaning that one of the operands is both a)33.336 315 R
2.815(source and a destination.)33.336 330 R 2.815(There are man)9.315 F
6.065(yc)-.195 G 2.815(ombinations of src/dst addressing modes)-6.065 F
10.563(including some odd restrictions.)33.336 345 R 10.562
(Generally speaking, most opcodes allo)17.063 F(w)-.325 E(re)33.336 360
Q(gister/re)-.195 E(gister)-.195 E 21.284(,r)-.52 G -.195(eg)-21.284 G
18.034(ister/immediate, re).195 F 18.034
(gister/memory or immediate/memory)-.195 F 3.25
(combinations. Memory/memory)33.336 375 R(is generally not allo)3.25 E
(wed.)-.325 E/F3 13/Times-Bold@0 SF(Function Calling Con)187.119 396 Q
-.13(ve)-.52 G(ntion).13 E F1 2.533 -1.04(We w)33.336 432 T .453
(ill discuss what the Intel documentation calls the CDECL con)1.04 F
-.195(ve)-.52 G .452(ntion for procedure).195 F .577
(calling, as that is what is used in the C/UNIX w)33.336 447 R 3.827
(orld. Other)-.13 F .578(calling con)3.827 F -.195(ve)-.52 G .578
(ntions do e).195 F(xist.)-.195 E 1.058
(In the X86-32 architecture, all ar)33.336 462 R 1.057
(guments to a function are pushed on the stack, and the)-.234 F .07
(return v)33.336 477 R .07(alue is returned in the %eax re)-.325 F
(gister)-.195 E 6.571(.I)-.715 G 3.321(ft)-6.571 G .071(he return v)
-3.321 F .071(alue is 64 bits \(long long\), it is)-.325 F .07
(returned in the re)33.336 492 R .07(gister pair %edx:%eax, with the %e\
dx being the most signi\214cant 32 bits.)-.195 F 2.064
(Recall that %esp is the stack pointer)33.336 513 R 5.314(,a)-.52 G
2.064(nd the stack gro)-5.314 F 2.064(ws to)-.325 F -.13(wa)-.325 G
2.065(rds lo).13 F 5.315(wm)-.325 G(emory)-5.315 E 8.565(.T)-.845 G(he)
-8.565 E 3.399(PUSH instruction predecrements the stack pointer)33.336
528 R 6.649(,t)-.52 G 3.399(hen writes the v)-6.649 F 3.399
(alue to \(%esp\).)-.325 F(Lik)33.336 543 Q -.325(ew)-.13 G 1.538
(ise, POP reads from \(%esp\) and then postincrements %esp.).325 F(Ar)
8.039 E 1.539(guments in C are)-.234 F 3.527
(pushed to the stack in right-to-left order)33.336 558 R 10.026(.T)-.715
G 3.526(herefore, just before issuing the CALL)-10.026 F 2.433
(instruction, the leftmost ar)33.336 573 R 2.433
(gument is on the top of the stack.)-.234 F 2.433(This con)8.933 F -.195
(ve)-.52 G 2.433(ntion allo).195 F(ws)-.325 E -.325(va)33.336 588 S
1.849(riadic functions to w).325 F 1.849(ork properly)-.13 F 8.349(.T)
-.845 G 1.849(he callee does not need to kno)-8.349 F 5.098(wi)-.325 G
5.098(na)-5.098 G(dv)-5.098 E 1.848(ance \(at)-.325 F .477
(compile time\) the e)33.336 603 R .477(xact number of ar)-.195 F .478
(guments which will be pushed.)-.234 F .478(It is able to retrie)6.978 F
-.195(ve)-.325 G(the ar)33.336 618 Q(guments left-to-right by positi)
-.234 E .39 -.195(ve o)-.325 H -.325(ff).195 G(sets from %esp.).325 E
2.53(The CALL instruction pushes the v)33.336 639 R 2.529
(alue of %eip, thus on entry to a function \(%esp\))-.325 F .698(contai\
ns the address of the instruction to which control should return \(i.e.\
 the instruction)33.336 654 R .964(after the CALL\).)33.336 669 R .964
(The \214rst thing an)7.464 F 4.214(yf)-.195 G .963
(unction does is set up its local stack frame.)-4.214 F(Let')7.463 E(s)
-.715 E(look at an e)33.336 684 Q(xample:)-.195 E/F4 8/Courier@0 SF 1.2
(f1\(\))33.936 696 S({)33.936 708 Q 1.2(f2\(2\);)81.936 720 S(})33.936
732 Q 0 Cg EP
%%Page: 24 24
%%BeginPageSetup
BP
%%EndPageSetup
/F0 9/Times-Roman@0 SF(ECE357:Computer Operating Systems)33.336 60 Q
(Unit 7/pg 24)71.748 E(\2512016 Jef)142.155 E 2.25(fH)-.225 G(akner)
-2.25 E/F1 8/Courier@0 SF 1.2(f2\(int b\))33.936 117 S({)33.936 129 Q
1.2(int a;)33.936 141 S 1.2(a++;)81.936 153 S 1.2(b--;)81.936 165 S 1.2
(return 1;)81.936 177 S(})33.936 189 Q 1.2(f1:)33.936 216 S 12 1.2
(pushl %ebp)81.936 228 T 18 1.2(movl %esp,)81.936 240 T 1.2(%ebp)6 G 18
1.2(subl $8,)81.936 252 T 90 1.2(%esp !one)6 H 1.2
(arg slot + one padding slot)6 G 18 1.2(movl $2,)81.936 264 T 78 1.2
(\(%esp\) !put)6 H 1.2(arg onto stack)6 G 18 1.2(call f2)81.936 276 T
1.2(leave)81.936 288 S 1.2(ret)81.936 300 S 1.2(f2:)33.936 324 S 12 1.2
(pushl %ebp)81.936 336 T 18 1.2(movl %esp,)81.936 348 T 1.2(%ebp)6 G 18
1.2(subl $16,)81.936 360 T 84 1.2(%esp !extra)6 H 1.2
(space for alignment)6 G 18 1.2(incl -4\(%ebp\))81.936 372 T 1.2
(!access local var a)96 G 18 1.2(decl 8\(%ebp\))81.936 384 T 1.2
(!access param b)102 G 18 1.2(movl $1,%eax)81.936 396 T 1.2
(!return value)102 G 1.2(leave)81.936 408 S 1.2(ret)81.936 420 S/F2 13
/Times-Roman@0 SF .048(The %ebp re)33.336 441 R .048
(gister is the frame pointer)-.195 F 3.299(,a)-.52 G .049
(nd will be used to access both local v)-3.299 F .049(ariables and)-.325
F 3.461(parameters. Its)33.336 456 R -.325(va)3.461 G .211
(lue must be preserv).325 F .21(ed so the \214rst action is to sa)-.195
F .6 -.195(ve i)-.26 H 3.46(to).195 G 3.46(nt)-3.46 G .21(he stack.)
-3.46 F(Then)6.71 E 2.604
(the stack pointer is decremented to create room for local v)33.336 471
R 5.854(ariables. In)-.325 F 2.604(our e)5.854 F(xample,)-.195 E .235
(function g has one local v)33.336 486 R .235(ariable which tak)-.325 F
.235(es up 4 bytes.)-.13 F .235(The %ebp contains the v)6.735 F .234
(alue of)-.325 F 2.029(the stack pointer after sa)33.336 501 R 2.029
(ving the old %ebp.)-.26 F 2.029
(Therefore 4\(%ebp\) is the return address,)8.529 F 2.247
(\(%ebp\) is the sa)33.336 516 R -.195(ve)-.26 G 5.496(d%).195 G 2.246
(ebp, and the \214rst parameter is 8\(%ebp\).)-5.496 F -.195(Pa)8.746 G
2.246(rameters will be at).195 F(positi)33.336 531 Q 2.994 -.195(ve o)
-.325 H -.325(ff).195 G 2.604(sets from %ebp and local v).325 F 2.604
(ariables will be at ne)-.325 F -.065(ga)-.195 G(ti).065 E 2.995 -.195
(ve o)-.325 H -.325(ff).195 G 5.855(sets. Generally).325 F 1.311
(speaking, the local v)33.336 546 R 1.311
(ariables mentioned \214rst in a function will ha)-.325 F 1.701 -.195
(ve t)-.26 H 1.311(he lo).195 F 1.311(west memory)-.325 F
(address \(i.e. highest ne)33.336 561 Q -.065(ga)-.195 G(ti).065 E .39
-.195(ve o)-.325 H -.325(ff).195 G(set from %ebp\), b).325 E
(ut that beha)-.26 E(vior is not guaranteed.)-.26 E .176
(When a function call is made, ar)33.336 582 R .177
(guments can be pushed on the stack in right-to-left order)-.234 F(,)
-.52 E .071(using the)33.336 597 R/F3 13/Courier@0 SF -1.8(pushl)2.421 G
F2 3.321(instruction. After)4.221 F(the)3.321 E F3 -1.8(CALL)2.421 G F2
.071(instruction, an)4.221 F F3 .07 -1.8(addl $X,%esp)2.421 H F2 -.13
(wo)4.22 G .07(uld be needed).13 F 1.202
(to adjust the stack pointer and re)33.336 612 R -.195(ve)-.325 G 1.202
(rse the ef).195 F 1.202(fects of the pre)-.325 F 1.202(vious pushes.)
-.325 F(Alternati)7.702 E -.195(ve)-.325 G(ly).195 E(,)-.845 E 2.6(one \
could determine during code generation which function call \(within the\
 function)33.336 627 R 3.637
(being generated\) has the highest number of ar)33.336 642 R 6.887
(guments. The)-.234 F 3.637(number of bytes thus)6.887 F .18
(required for passing ar)33.336 657 R .179
(guments can be added to the total local stack frame size, as if these)
-.234 F("ar)33.336 672 Q .156(gument slots" were hidden local v)-.234 F
3.406(ariables. Then)-.325 F .156(the ar)3.406 F .156
(guments can be passed via)-.234 F F3 -1.8(movl)2.506 G -1.8
(OFFSET\(%esp\))32.436 687 S F2 4.03(,i).9 G 4.03(na)-4.03 G 1.17 -.195
(ny o)-4.03 H .78
(rder desired, and there is no need to adjust the stack pointer after)
.195 F(the call.)33.336 702 Q(This is the approach that gcc tak)6.5 E
(es.)-.13 E .484(Upon lea)33.336 723 R .484(ving a function, the LEA)
-.26 F .484(VE instruction is used, which performs tw)-1.755 F 3.735(oo)
-.13 G(perations:)-3.735 E .748(%ebp is mo)33.336 738 R -.195(ve)-.195 G
3.998(di).195 G .748
(nto %esp, thus restoring the stack pointer to its v)-3.998 F .747
(alue just after the base)-.325 F 0 Cg EP
%%Page: 25 25
%%BeginPageSetup
BP
%%EndPageSetup
/F0 9/Times-Roman@0 SF(ECE357:Computer Operating Systems)33.336 60 Q
(Unit 7/pg 25)71.748 E(\2512016 Jef)142.155 E 2.25(fH)-.225 G(akner)
-2.25 E/F1 13/Times-Roman@0 SF .984(pointer sa)33.336 120 R 1.374 -.195
(ve o)-.26 H 4.234(ne).195 G(ntry)-4.234 E 4.234(,t)-.845 G .984
(hen %ebp is popped from the stack.)-4.234 F(No)7.485 E 4.235(we)-.325 G
-.195(ve)-4.56 G .985(rything is restored,).195 F .549(and the RET inst\
ruction pops the return address from the stack and resumes e)33.336 135
R -.195(xe)-.195 G .548(cution in).195 F(the caller)33.336 150 Q(.)-.715
E .362(If the compiler chose to use an)33.336 171 R 3.612(yr)-.195 G
-.195(eg)-3.612 G .362(isters which are callee-sa).195 F -.195(ve)-.26 G
.362(s, we w).195 F .363(ould see pushes of)-.13 F(those re)33.336 186 Q
(gisters on entry and corresponding pops on e)-.195 E(xit.)-.195 E 0 0
468 498 -507.47 540 33.336 714.47 PBEGIN
%%BeginDocument: x86stack.eps
%!PS-Adobe-2.0 EPSF-2.0
%%Title: x86stack.fig
%%Creator: fig2dev Version 3.2 Patchlevel 4
%%CreationDate: Mon Dec  1 01:28:12 2008
%%For: hak@lex ()
%%BoundingBox: 0 0 498 540
%%Magnification: 1.0000
%%EndComments
/$F2psDict 200 dict def
$F2psDict begin
$F2psDict /mtrx matrix put
/col-1 {0 setgray} bind def
/col0 {0.000 0.000 0.000 srgb} bind def
/col1 {0.000 0.000 1.000 srgb} bind def
/col2 {0.000 1.000 0.000 srgb} bind def
/col3 {0.000 1.000 1.000 srgb} bind def
/col4 {1.000 0.000 0.000 srgb} bind def
/col5 {1.000 0.000 1.000 srgb} bind def
/col6 {1.000 1.000 0.000 srgb} bind def
/col7 {1.000 1.000 1.000 srgb} bind def
/col8 {0.000 0.000 0.560 srgb} bind def
/col9 {0.000 0.000 0.690 srgb} bind def
/col10 {0.000 0.000 0.820 srgb} bind def
/col11 {0.530 0.810 1.000 srgb} bind def
/col12 {0.000 0.560 0.000 srgb} bind def
/col13 {0.000 0.690 0.000 srgb} bind def
/col14 {0.000 0.820 0.000 srgb} bind def
/col15 {0.000 0.560 0.560 srgb} bind def
/col16 {0.000 0.690 0.690 srgb} bind def
/col17 {0.000 0.820 0.820 srgb} bind def
/col18 {0.560 0.000 0.000 srgb} bind def
/col19 {0.690 0.000 0.000 srgb} bind def
/col20 {0.820 0.000 0.000 srgb} bind def
/col21 {0.560 0.000 0.560 srgb} bind def
/col22 {0.690 0.000 0.690 srgb} bind def
/col23 {0.820 0.000 0.820 srgb} bind def
/col24 {0.500 0.190 0.000 srgb} bind def
/col25 {0.630 0.250 0.000 srgb} bind def
/col26 {0.750 0.380 0.000 srgb} bind def
/col27 {1.000 0.500 0.500 srgb} bind def
/col28 {1.000 0.630 0.630 srgb} bind def
/col29 {1.000 0.750 0.750 srgb} bind def
/col30 {1.000 0.880 0.880 srgb} bind def
/col31 {1.000 0.840 0.000 srgb} bind def

end
save
newpath 0 540 moveto 0 0 lineto 498 0 lineto 498 540 lineto closepath clip newpath
-81.0 571.5 translate
1 -1 scale

/cp {closepath} bind def
/ef {eofill} bind def
/gr {grestore} bind def
/gs {gsave} bind def
/sa {save} bind def
/rs {restore} bind def
/l {lineto} bind def
/m {moveto} bind def
/rm {rmoveto} bind def
/n {newpath} bind def
/s {stroke} bind def
/sh {show} bind def
/slc {setlinecap} bind def
/slj {setlinejoin} bind def
/slw {setlinewidth} bind def
/srgb {setrgbcolor} bind def
/rot {rotate} bind def
/sc {scale} bind def
/sd {setdash} bind def
/ff {findfont} bind def
/sf {setfont} bind def
/scf {scalefont} bind def
/sw {stringwidth} bind def
/tr {translate} bind def
/tnt {dup dup currentrgbcolor
  4 -2 roll dup 1 exch sub 3 -1 roll mul add
  4 -2 roll dup 1 exch sub 3 -1 roll mul add
  4 -2 roll dup 1 exch sub 3 -1 roll mul add srgb}
  bind def
/shd {dup dup currentrgbcolor 4 -2 roll mul 4 -2 roll mul
  4 -2 roll mul srgb} bind def
/$F2psBegin {$F2psDict begin /$F2psEnteredState save def} def
/$F2psEnd {$F2psEnteredState restore end} def

$F2psBegin
10 setmiterlimit
0 slj 0 slc
 0.06000 0.06000 sc
%
% Fig objects follow
%
% 
% here starts figure with depth 50
% Polyline
7.500 slw
n 2400 900 m 4200 900 l 4200 1500 l 2400 1500 l
 cp gs col0 s gr 
% Polyline
 [60] 0 sd
n 2400 1050 m
 4200 1050 l gs col0 s gr  [] 0 sd
% Polyline
 [60] 0 sd
n 2400 1200 m
 4200 1200 l gs col0 s gr  [] 0 sd
% Polyline
 [60] 0 sd
n 2400 1350 m
 4200 1350 l gs col0 s gr  [] 0 sd
% Polyline
n 2400 1500 m 4200 1500 l 4200 2100 l 2400 2100 l
 cp gs col0 s gr 
% Polyline
 [60] 0 sd
n 2400 1650 m
 4200 1650 l gs col0 s gr  [] 0 sd
% Polyline
 [60] 0 sd
n 2400 1800 m
 4200 1800 l gs col0 s gr  [] 0 sd
% Polyline
 [60] 0 sd
n 2400 1950 m
 4200 1950 l gs col0 s gr  [] 0 sd
% Polyline
n 2400 2100 m 4200 2100 l 4200 2700 l 2400 2700 l
 cp gs col0 s gr 
% Polyline
 [60] 0 sd
n 2400 2250 m
 4200 2250 l gs col0 s gr  [] 0 sd
% Polyline
 [60] 0 sd
n 2400 2400 m
 4200 2400 l gs col0 s gr  [] 0 sd
% Polyline
 [60] 0 sd
n 2400 2550 m
 4200 2550 l gs col0 s gr  [] 0 sd
% Polyline
n 2400 2700 m 4200 2700 l 4200 3300 l 2400 3300 l
 cp gs col0 s gr 
% Polyline
 [60] 0 sd
n 2400 2850 m
 4200 2850 l gs col0 s gr  [] 0 sd
% Polyline
 [60] 0 sd
n 2400 3000 m
 4200 3000 l gs col0 s gr  [] 0 sd
% Polyline
 [60] 0 sd
n 2400 3150 m
 4200 3150 l gs col0 s gr  [] 0 sd
% Polyline
n 2400 3300 m 4200 3300 l 4200 3900 l 2400 3900 l
 cp gs col0 s gr 
% Polyline
 [60] 0 sd
n 2400 3450 m
 4200 3450 l gs col0 s gr  [] 0 sd
% Polyline
 [60] 0 sd
n 2400 3600 m
 4200 3600 l gs col0 s gr  [] 0 sd
% Polyline
 [60] 0 sd
n 2400 3750 m
 4200 3750 l gs col0 s gr  [] 0 sd
% Polyline
n 2400 3900 m 4200 3900 l 4200 4500 l 2400 4500 l
 cp gs col0 s gr 
% Polyline
 [60] 0 sd
n 2400 4050 m
 4200 4050 l gs col0 s gr  [] 0 sd
% Polyline
 [60] 0 sd
n 2400 4200 m
 4200 4200 l gs col0 s gr  [] 0 sd
% Polyline
 [60] 0 sd
n 2400 4350 m
 4200 4350 l gs col0 s gr  [] 0 sd
% Polyline
n 2400 4500 m 4200 4500 l 4200 5100 l 2400 5100 l
 cp gs col0 s gr 
% Polyline
 [60] 0 sd
n 2400 4650 m
 4200 4650 l gs col0 s gr  [] 0 sd
% Polyline
 [60] 0 sd
n 2400 4800 m
 4200 4800 l gs col0 s gr  [] 0 sd
% Polyline
 [60] 0 sd
n 2400 4950 m
 4200 4950 l gs col0 s gr  [] 0 sd
% Polyline
n 2400 5100 m 4200 5100 l 4200 5700 l 2400 5700 l
 cp gs col0 s gr 
% Polyline
 [60] 0 sd
n 2400 5250 m
 4200 5250 l gs col0 s gr  [] 0 sd
% Polyline
 [60] 0 sd
n 2400 5400 m
 4200 5400 l gs col0 s gr  [] 0 sd
% Polyline
 [60] 0 sd
n 2400 5550 m
 4200 5550 l gs col0 s gr  [] 0 sd
% Polyline
n 2400 5700 m 4200 5700 l 4200 6300 l 2400 6300 l
 cp gs col0 s gr 
% Polyline
 [60] 0 sd
n 2400 5850 m
 4200 5850 l gs col0 s gr  [] 0 sd
% Polyline
 [60] 0 sd
n 2400 6000 m
 4200 6000 l gs col0 s gr  [] 0 sd
% Polyline
 [60] 0 sd
n 2400 6150 m
 4200 6150 l gs col0 s gr  [] 0 sd
% Polyline
n 2400 6300 m 4200 6300 l 4200 6900 l 2400 6900 l
 cp gs col0 s gr 
% Polyline
 [60] 0 sd
n 2400 6450 m
 4200 6450 l gs col0 s gr  [] 0 sd
% Polyline
 [60] 0 sd
n 2400 6600 m
 4200 6600 l gs col0 s gr  [] 0 sd
% Polyline
 [60] 0 sd
n 2400 6750 m
 4200 6750 l gs col0 s gr  [] 0 sd
% Polyline
n 2400 6900 m 4200 6900 l 4200 7500 l 2400 7500 l
 cp gs col0 s gr 
% Polyline
 [60] 0 sd
n 2400 7050 m
 4200 7050 l gs col0 s gr  [] 0 sd
% Polyline
 [60] 0 sd
n 2400 7200 m
 4200 7200 l gs col0 s gr  [] 0 sd
% Polyline
 [60] 0 sd
n 2400 7350 m
 4200 7350 l gs col0 s gr  [] 0 sd
% Polyline
n 2400 7500 m 4200 7500 l 4200 8100 l 2400 8100 l
 cp gs col0 s gr 
% Polyline
 [60] 0 sd
n 2400 7650 m
 4200 7650 l gs col0 s gr  [] 0 sd
% Polyline
 [60] 0 sd
n 2400 7800 m
 4200 7800 l gs col0 s gr  [] 0 sd
% Polyline
 [60] 0 sd
n 2400 7950 m
 4200 7950 l gs col0 s gr  [] 0 sd
% Polyline
n 2400 8100 m 4200 8100 l 4200 8700 l 2400 8700 l
 cp gs col0 s gr 
% Polyline
 [60] 0 sd
n 2400 8250 m
 4200 8250 l gs col0 s gr  [] 0 sd
% Polyline
 [60] 0 sd
n 2400 8400 m
 4200 8400 l gs col0 s gr  [] 0 sd
% Polyline
 [60] 0 sd
n 2400 8550 m
 4200 8550 l gs col0 s gr  [] 0 sd
% Polyline
n 2400 8700 m 4200 8700 l 4200 9300 l 2400 9300 l
 cp gs col0 s gr 
% Polyline
 [60] 0 sd
n 2400 8850 m
 4200 8850 l gs col0 s gr  [] 0 sd
% Polyline
 [60] 0 sd
n 2400 9000 m
 4200 9000 l gs col0 s gr  [] 0 sd
% Polyline
 [60] 0 sd
n 2400 9150 m
 4200 9150 l gs col0 s gr  [] 0 sd
% Polyline
gs  clippath
4260 6345 m 4260 6405 l 4412 6405 l 4292 6375 l 4412 6345 l cp
eoclip
n 5250 6375 m
 4275 6375 l gs col0 s gr gr

% arrowhead
n 4412 6345 m 4292 6375 l 4412 6405 l  col0 s
% Polyline
n 2250 2775 m 2025 3150 l 2025 4725 l 1950 4875 l 2025 5100 l 2025 7050 l

 2175 7350 l gs col0 s gr 
% Polyline
gs  clippath
4260 2745 m 4260 2805 l 4412 2805 l 4292 2775 l 4412 2745 l cp
eoclip
n 5250 2775 m
 4275 2775 l gs col0 s gr gr

% arrowhead
n 4412 2745 m 4292 2775 l 4412 2805 l  col0 s
% Polyline
gs  clippath
4255 4097 m 4264 4156 l 4414 4132 l 4291 4122 l 4404 4073 l cp
eoclip
n 5700 3900 m
 4275 4125 l gs col0 s gr gr

% arrowhead
n 4404 4073 m 4291 4122 l 4414 4132 l  col0 s
% Polyline
 [60] 0 sd
gs  clippath
4260 7470 m 4260 7530 l 4412 7530 l 4292 7500 l 4412 7470 l cp
eoclip
n 5250 7500 m
 4275 7500 l gs col0 s gr gr
 [] 0 sd
% arrowhead
n 4412 7470 m 4292 7500 l 4412 7530 l  col0 s
/Times-Roman ff 200.00 scf sf
2775 675 m
gs 1 -1 sc (LOW MEMORY) col0 sh gr
/Times-Roman ff 200.00 scf sf
2700 9525 m
gs 1 -1 sc (HIGH MEMORY) col0 sh gr
/Times-Bold ff 233.33 scf sf
3000 8325 m
gs 1 -1 sc  345.0 rot (arg2) col0 sh gr
/Times-Bold ff 233.33 scf sf
2925 8925 m
gs 1 -1 sc  345.0 rot (arg3) col0 sh gr
/Times-Bold ff 233.33 scf sf
3000 7725 m
gs 1 -1 sc  345.0 rot (arg1) col0 sh gr
/Times-Bold ff 233.33 scf sf
3000 7050 m
gs 1 -1 sc  345.0 rot (return) col0 sh gr
/Times-Bold ff 233.33 scf sf
2925 7275 m
gs 1 -1 sc  345.0 rot (address) col0 sh gr
/Times-Bold ff 233.33 scf sf
3075 6450 m
gs 1 -1 sc  345.0 rot (saved) col0 sh gr
/Times-Bold ff 233.33 scf sf
2997 6740 m
gs 1 -1 sc  345.0 rot (%ebp) col0 sh gr
/Times-Bold ff 233.33 scf sf
3150 5925 m
gs 1 -1 sc  345.0 rot (c) col0 sh gr
/Times-Bold ff 233.33 scf sf
3150 5325 m
gs 1 -1 sc  345.0 rot (b) col0 sh gr
/Times-Bold ff 233.33 scf sf
3150 4725 m
gs 1 -1 sc  345.0 rot (a) col0 sh gr
/Times-Bold ff 233.33 scf sf
2775 4200 m
gs 1 -1 sc  345.0 rot (padding) col0 sh gr
/Times-Roman ff 233.33 scf sf
5400 6375 m
gs 1 -1 sc (%ebp) col0 sh gr
/Times-Bold ff 233.33 scf sf
2700 3600 m
gs 1 -1 sc  345.0 rot (arg slot 2) col0 sh gr
/Times-Bold ff 233.33 scf sf
2700 3000 m
gs 1 -1 sc  345.0 rot (arg slot 1) col0 sh gr
/Times-Roman ff 233.33 scf sf
5400 2850 m
gs 1 -1 sc (%esp) col0 sh gr
/Times-Roman ff 233.33 scf sf
1350 5400 m
gs 1 -1 sc (g\(\)) col0 sh gr
/Times-Roman ff 233.33 scf sf
1350 5025 m
gs 1 -1 sc (for) col0 sh gr
/Times-Roman ff 233.33 scf sf
1350 4575 m
gs 1 -1 sc (frame) col0 sh gr
/Times-Roman ff 233.33 scf sf
1350 4200 m
gs 1 -1 sc (stack) col0 sh gr
/Times-Roman ff 233.33 scf sf
5775 3825 m
gs 1 -1 sc (If additional space were needed) col0 sh gr
/Times-Roman ff 233.33 scf sf
5775 4110 m
gs 1 -1 sc (for more local variables or temp) col0 sh gr
/Times-Roman ff 233.33 scf sf
5775 4395 m
gs 1 -1 sc (values, they would be allocated in) col0 sh gr
/Times-Roman ff 233.33 scf sf
5775 4680 m
gs 1 -1 sc (here, with padding necessary to bring) col0 sh gr
/Times-Roman ff 233.33 scf sf
5775 4965 m
gs 1 -1 sc (the total stack frame size to a multiple) col0 sh gr
/Times-Roman ff 233.33 scf sf
5775 5250 m
gs 1 -1 sc (of 16.) col0 sh gr
/Times-Roman ff 233.33 scf sf
7050 7125 m
gs 1 -1 sc (f\(\)) col0 sh gr
/Times-Roman ff 233.33 scf sf
7050 7410 m
gs 1 -1 sc ({) col0 sh gr
/Times-Roman ff 233.33 scf sf
7350 7575 m
gs 1 -1 sc (/*...*/) col0 sh gr
/Times-Roman ff 233.33 scf sf
7350 7860 m
gs 1 -1 sc (g\(arg1,arg2,arg3\);) col0 sh gr
/Times-Roman ff 233.33 scf sf
7350 8145 m
gs 1 -1 sc (/*...*/) col0 sh gr
/Times-Roman ff 233.33 scf sf
7050 8325 m
gs 1 -1 sc (}) col0 sh gr
/Times-Roman ff 233.33 scf sf
6825 1650 m
gs 1 -1 sc (g\(x,y,z\)) col0 sh gr
/Times-Roman ff 233.33 scf sf
6825 1935 m
gs 1 -1 sc ({) col0 sh gr
/Times-Roman ff 233.33 scf sf
6825 2220 m
gs 1 -1 sc ( int a,b,c;) col0 sh gr
/Times-Roman ff 233.33 scf sf
6825 2505 m
gs 1 -1 sc ( /*...*/) col0 sh gr
/Times-Roman ff 233.33 scf sf
6825 2790 m
gs 1 -1 sc (    z\(1,2\);) col0 sh gr
/Times-Roman ff 233.33 scf sf
6825 3075 m
gs 1 -1 sc ( .*...*.) col0 sh gr
/Times-Roman ff 233.33 scf sf
6825 3360 m
gs 1 -1 sc (}) col0 sh gr
/Times-Roman ff 233.33 scf sf
5250 3000 m
gs 1 -1 sc (\(during exec) col0 sh gr
/Times-Roman ff 233.33 scf sf
5250 3285 m
gs 1 -1 sc ( of fn. g\)) col0 sh gr
/Times-Roman ff 233.33 scf sf
5475 6675 m
gs 1 -1 sc (\(during exec. of fn. g\)) col0 sh gr
/Times-Roman ff 233.33 scf sf
5400 7500 m
gs 1 -1 sc (%esp just) col0 sh gr
/Times-Roman ff 233.33 scf sf
5400 7785 m
gs 1 -1 sc (before calling) col0 sh gr
/Times-Roman ff 233.33 scf sf
5400 8070 m
gs 1 -1 sc (fn. g) col0 sh gr
% here ends figure;
$F2psEnd
rs
showpage
%%EndDocument
end PEND 0 Cg EP
%%Page: 26 26
%%BeginPageSetup
BP
%%EndPageSetup
/F0 9/Times-Roman@0 SF(ECE357:Computer Operating Systems)33.336 60 Q
(Unit 7/pg 26)71.748 E(\2512016 Jef)142.155 E 2.25(fH)-.225 G(akner)
-2.25 E/F1 13/Times-Bold@0 SF(X86-64 Function Calling)199.079 120 Q/F2
13/Times-Roman@0 SF .878
(Under the 64 bit architecture, the \214rst 6 inte)33.336 156 R .877
(ger ar)-.195 F .877(guments are passed in re)-.234 F .877
(gisters, rather)-.195 F 2.012(than on the stack.)33.336 171 R(Ar)8.512
E 2.012(guments are placed in left-to-right order in re)-.234 F 2.012
(gisters %rdi, %rsi,)-.195 F .35(%rdx, %rcx, %r8, %r9.)33.336 186 R .349
(If there are additional ar)6.85 F .349(guments, the)-.234 F 3.599(ya)
-.195 G .349(re put on the stack right-)-3.599 F .253
(to-left, i.e. with the right-most ar)33.336 201 R .253
(gument at the highest memory address, just lik)-.234 F 3.503(eX)-.13 G
(86-32.)-3.503 E .068(If structs are passed as ar)33.336 216 R .068
(guments, the)-.234 F 3.318(ya)-.195 G .068(re al)-3.318 F -.13(wa)-.13
G .067(ys placed on the stack.).13 F .067(The inte)6.567 F .067
(ger return)-.195 F -.325(va)33.336 231 S(lue is in the %rax re).325 E
(gister)-.195 E(.)-.715 E 1.404(This h)33.336 252 R 1.404(ybrid re)-.065
F 1.404(gister/memory ar)-.195 F 1.404
(gument passing model introduces some comple)-.234 F 1.404(xity with)
-.195 F -.325(va)33.336 267 S(riadic functions, aka).325 E/F3 13
/Courier@0 SF -1.8(<stdarg.h>)2.35 G F2 6.5(.G).9 G(CC implements)-6.5 E
F3 -1.8(stdarg)2.35 G F2(as a compiler b)4.15 E(uilt-in.)-.26 E F1
(X86-64 Global V)199.32 297 Q(ariables)-1.196 E F2 .672(There is an odd\
 limitation in the X86-64 instruction set: the absolute addressing mode\
 is)33.336 333 R 2.789(not supported for 64-bit addresses.)33.336 348 R
4.87 -1.04(To a)9.289 H 2.79(ccess a memory operand, a re)1.04 F 2.79
(gister indirect)-.195 F(addressing mode must be used.)33.336 363 Q/F4
10/Courier@0 SF(extern int i;)33.336 375 Q(f\(\))33.336 399 Q({)33.336
411 Q(i=2;)90.936 423 Q(})33.336 435 Q(f:)33.336 459 Q 12(pushq %rbp)
81.336 471 R(#Prologue, save base pointer)168 E 18(movq %rsp,)81.336 483
R 68.4(%rbp #Set)6 F(new base pointer)6 E 27.6(subq $32,)90.936 495 R
55.2(%rsp #Create)6 F(stack frame)6 E 18(movl $2,)81.336 507 R 62.4
(i\(%rip\) #Program)6 F(Counter Relative mode)6 E(leave)81.336 519 Q
(ret)81.336 531 Q F2 .267(There will be a 32-bit "hole" in the)33.336
564 R F3 -1.8(movl)2.617 G F2 .267
(opcode which will be a program counter relati)4.417 F -.195(ve)-.325 G
.666(relocation type \(similar to the e)33.336 579 R .667
(xample of the CALL opcode earlier in this unit\).)-.195 F .667(At link)
7.167 F .587(time, when the address of symbol i has been resolv)33.336
594 R .586(ed, this hole will be \214lled with the i')-.195 F(s)-.715 E
(address, minus the address of the hole itself.)33.336 609 Q 0 Cg EP
%%Page: 27 27
%%BeginPageSetup
BP
%%EndPageSetup
/F0 9/Times-Roman@0 SF(ECE357:Computer Operating Systems)33.336 60 Q
(Unit 7/pg 27)71.748 E(\2512016 Jef)142.155 E 2.25(fH)-.225 G(akner)
-2.25 E/F1 13/Times-Roman@0 SF .32
(This introduces a limitation that code and data must f)33.336 120 R
.321(all within the same contiguous 2GB)-.13 F .289(memory re)33.336 135
R .289
(gion at run time, which the X64-64 spec calls a "medium" memory model.)
-.195 F -1.04(To)6.788 G 2.117(use a "lar)33.336 150 R 2.117
(ge" memory model where code and data may be an)-.234 F 2.118
(yplace within the 64-bit)-.195 F(address space, dif)33.336 165 Q
(ferent opcodes are used:)-.325 E/F2 10/Courier@0 SF 9.6(movabsq $i,)
90.936 177 R 61.2(%rax #Move)6 F(64 bit immediate value to rax)6 E 18
(movl $2,)81.336 189 R 68.4(\(%rax\) #Register)6 F(indirect)6 E/F3 13
/Times-Bold@0 SF(Caller/Callee sa)215.03 219 Q -.13(ve)-.325 G(s).13 E
F1 1.777(It is the case for an)33.336 255 R 5.027(ya)-.195 G 1.776
(rchitecture and operating system that there is a function calling)
-5.027 F("con)33.336 270 Q -.195(ve)-.52 G 1.046
(ntion" which speci\214es ho).195 F 4.296(wa)-.325 G -.234(rg)-4.296 G
1.046(uments are passed and returned, and ho).234 F 4.296(wr)-.325 G
-.195(eg)-4.296 G(isters).195 E 1.413(may be used.)33.336 285 R 1.413
(This con)7.913 F -.195(ve)-.52 G 1.412(ntion dictates which of the re)
.195 F 1.412(gisters are e)-.195 F 1.412(xpected to survi)-.195 F 1.802
-.195(ve a)-.325 H 3.125
(function call, and which ones may be used as "scratch" re)33.336 300 R
3.125(gisters, and are therefore)-.195 F -.195(ex)33.336 315 S 2.215
(pected to be v).195 F 2.215(olatile across function calls.)-.26 F 2.215
(Another w)8.715 F 2.214(ay of saying this is there are)-.13 F(caller)
33.336 330 Q(-sa)-.26 E -.195(ve)-.26 G 4.592(dr).195 G -.195(eg)-4.592
G 1.342(isters \(the scratch re).195 F 4.593(gisters.. if)-.195 F 1.343
(the caller w)4.593 F 1.343(ants to k)-.13 F 1.343(eep a v)-.13 F 1.343
(alue in there)-.325 F .769(through a function call it must e)33.336 345
R .769(xplicitly sa)-.195 F 1.159 -.195(ve i)-.26 H .769
(t\) and callee-sa).195 F -.195(ve)-.26 G 4.019(dr).195 G -.195(eg)
-4.019 G .768(isters \(if a function).195 F -.13(wa)33.336 360 S .549
(nts to use one of these re).13 F .55(gisters it must e)-.195 F .55
(xplicitly sa)-.195 F .94 -.195(ve i)-.26 H 3.8(to).195 G 3.8(ne)-3.8 G
.55(ntry and restore it before)-3.8 F(returning\).)33.336 375 Q 1.28
(In the X86-32 architecture under UNIX, the %eax,%ecx,and %edx re)33.336
396 R 1.28(gisters are scratch)-.195 F(re)33.336 411 Q .777
(gisters \(caller)-.195 F(-sa)-.26 E -.195(ve)-.26 G 4.027(s\). Y).195 F
.777(ou will \214nd that the compiler tends to put short-li)-1.43 F
-.195(ve)-.325 G 4.027(dv).195 G .777(alues in)-4.352 F 2.782(these re)
33.336 426 R 6.032(gisters. Of)-.195 F 2.782(course the %e\215ags re)
6.032 F 2.782(gister is also e)-.195 F 2.782
(xpected to be modi\214ed by a)-.195 F 3.799(function call.)33.336 441 R
3.799(The %ebx,%edi,%esi and %es [CA)10.299 F 3.8
(UTION: this is a 16-bit re)-.715 F(gister])-.195 E(re)33.336 456 Q
1.361(gisters are callee-sa)-.195 F -.195(ve)-.26 G 4.611(d. The).195 F
1.361(compiler may use these for longer)4.611 F(-li)-.26 E -.195(ve)
-.325 G 4.61(dv).195 G 1.36(alues \(such as)-4.935 F .92(local v)33.336
471 R .92(ariables which are assigned to a re)-.325 F .921
(gister for all or part of the function to impro)-.195 F -.195(ve)-.195
G 4.333(speed\). Ho)33.336 486 R(we)-.325 E -.195(ve)-.325 G 2.123 -.52
(r, i).195 H 4.333(fo).52 G 1.082(ne of these re)-4.333 F 1.082
(gisters is used by the compiler)-.195 F 4.332(,i)-.52 G 4.332(tm)-4.332
G 1.082(ust emit code to)-4.332 F(push it on the stack on entry)33.336
501 Q 3.25(,a)-.845 G(nd pop it on return.)-3.25 E 4.917
(On X86-64, the caller)33.336 522 R(-sa)-.26 E 5.307 -.195(ve \()-.26 H
4.917(scratch\) re).195 F 4.918
(gisters are %rax,%rcx,%rdx,%rsi,%rdi, and)-.195 F 1.307
(%r8-%r11, while the callee-sa)33.336 537 R 1.697 -.195(ve \()-.26 H
1.307(long-term\) re).195 F 1.306(gisters are %rbx, %r12-%r15.)-.195 F
1.306(Note that)7.806 F .484(%rsi and %rdi are caller)33.336 552 R(-sa)
-.26 E .874 -.195(ve o)-.26 H 3.734(n6).195 G 3.734(4b)-3.734 G .484
(it, whereas the)-3.734 F 3.735(yw)-.195 G .485(ere callee-sa)-3.735 F
.875 -.195(ve o)-.26 H 3.735(n3).195 G 3.735(2-bit. This)-3.735 F(is)
3.735 E(because the)33.336 567 Q 3.25(ya)-.195 G(re used for ar)-3.25 E
(gument passing on 64 bit.)-.234 E F3(X86 General-Pur)153.488 597 Q
(pose Register Summary)-.13 E 0 Cg EP
%%Page: 28 28
%%BeginPageSetup
BP
%%EndPageSetup
/F0 9/Times-Roman@0 SF(ECE357:Computer Operating Systems)33.336 60 Q
(Unit 7/pg 28)71.748 E(\2512016 Jef)142.155 E 2.25(fH)-.225 G(akner)
-2.25 E .52 LW 419.488 110.25 33.336 110.25 DL/F1 13/Times-Roman@0 SF
(-32 re)39.836 122 Q 19.5(gS)-.195 G -2.925 -.26(av e)-19.5 H 3.25(db)
.26 G 35.932(yN)-3.25 G 32.682(otes -64)-35.932 F(re)3.25 E 19.5(gS)
-.195 G -2.925 -.26(av e)-19.5 H 3.25(db).26 G 26.013(yN)-3.25 G(otes)
-26.013 E 419.488 127.25 33.336 127.25 DL 419.488 129.25 33.336 129.25
DL 28.203(%eax Caller)43.892 141 R(fn retv)37.317 E 30.946(al %rax)-.325
F 24.148(Caller fn)32.175 F(retv)3.25 E(al)-.325 E 24.947(%ebx CallEE)
43.528 156 R 25.669(%rbx CallEE)111.611 F 28.203(%ecx Caller)43.892 171
R 28.925(%rcx Caller)114.868 F(ar)32.767 E 3.25(g#)-.234 G(4)-3.25 E
27.839(%edx Caller)43.528 186 R(longlong ret)27.398 E 28.561
(%rdx Caller)23.913 F(ar)32.767 E 3.25(g#)-.234 G(3)-3.25 E 26.39
(%edi CallEE)44.971 201 R 30.004(%rdi Caller)113.054 F(ar)32.767 E 3.25
(g#)-.234 G(1)-3.25 E 27.112(%esi CallEE)45.692 216 R 30.725
(%rsi Caller)113.776 F(ar)32.767 E 3.25(g#)-.234 G(2)-3.25 E 28.919
(%es CallEE)47.499 231 R(N/A)114.497 E 31.811(%r8 Caller)253.744 246 R
(ar)32.767 E 3.25(g#)-.234 G(5)-3.25 E 31.811(%r9 Caller)253.744 261 R
(ar)32.767 E 3.25(g#)-.234 G(6)-3.25 E 28.561(%r10 Caller)250.494 276 R
28.561(%r11 Caller)250.494 291 R 25.669(%r12 CallEE)250.494 306 R 25.669
(%r13 CallEE)250.494 321 R 25.669(%r14 CallEE)250.494 336 R 25.669
(%r15 CallEE)250.494 351 R 419.488 356.25 33.336 356.25 DL 359.883
110.25 359.883 356.25 DL 292.816 110.25 292.816 356.25 DL 235.331 110.25
235.331 356.25 DL 237.331 110.25 237.331 356.25 DL 153.638 110.25
153.638 356.25 DL 86.571 110.25 86.571 356.25 DL 419.488 110.25 419.488
356.25 DL 33.336 110.25 33.336 356.25 DL 0 Cg EP
%%Trailer
end
%%EOF
